# 订单状态查询接口详细文档

<cite>
**本文档引用的文件**
- [reply_server.py](file://reply_server.py)
- [order_status_handler.py](file://order_status_handler.py)
- [db_manager.py](file://db_manager.py)
- [order_detail_fetcher.py](file://utils/order_detail_fetcher.py)
- [app.js](file://static/js/app.js)
- [index.html](file://static/index.html)
</cite>

## 目录
1. [简介](#简介)
2. [API端点概览](#api端点概览)
3. [核心功能架构](#核心功能架构)
4. [订单状态管理](#订单状态管理)
5. [API端点详细说明](#api端点详细说明)
6. [数据模型与结构](#数据模型与结构)
7. [权限验证机制](#权限验证机制)
8. [错误处理策略](#错误处理策略)
9. [实际使用示例](#实际使用示例)
10. [性能优化建议](#性能优化建议)

## 简介

本文档详细介绍了闲鱼自动回复系统中的订单状态查询接口，该系统提供了完整的订单生命周期管理功能，包括订单列表查询、订单详情获取、状态更新等功能。系统采用前后端分离架构，后端提供RESTful API接口，前端通过JavaScript实现交互式订单管理界面。

## API端点概览

系统提供以下主要的订单状态查询和管理API端点：

| 端点 | 方法 | 功能描述 | 权限要求 |
|------|------|----------|----------|
| `/api/orders` | GET | 获取当前用户的订单列表 | 已认证用户 |
| `/api/orders/{order_id}` | GET | 获取指定订单的详细信息 | 已认证用户 |
| `/admin/data/orders` | GET | 管理员获取所有订单数据 | 管理员权限 |
| `/admin/data/orders/delete` | POST | 删除订单记录 | 管理员权限 |

## 核心功能架构

系统采用模块化设计，主要包含以下核心组件：

```mermaid
graph TB
subgraph "前端层"
UI[用户界面]
JS[JavaScript控制器]
end
subgraph "API网关层"
Auth[认证中间件]
Router[路由处理器]
end
subgraph "业务逻辑层"
OrderHandler[订单状态处理器]
DetailFetcher[订单详情获取器]
StatusManager[状态管理器]
end
subgraph "数据访问层"
DBManager[数据库管理器]
SQLite[(SQLite数据库)]
end
UI --> JS
JS --> Auth
Auth --> Router
Router --> OrderHandler
Router --> DetailFetcher
OrderHandler --> StatusManager
DetailFetcher --> DBManager
StatusManager --> DBManager
DBManager --> SQLite
```

**图表来源**
- [reply_server.py](file://reply_server.py#L5524-L5558)
- [order_status_handler.py](file://order_status_handler.py#L26-L1074)
- [db_manager.py](file://db_manager.py#L16-L5103)

## 订单状态管理

系统实现了完整的订单状态管理体系，支持多种订单状态及其转换规则：

### 订单状态定义

| 状态代码 | 中文描述 | 英文描述 | 状态优先级 |
|----------|----------|----------|------------|
| `processing` | 处理中 | Processing | 1 |
| `pending_ship` | 待发货 | Pending Ship | 2 |
| `shipped` | 已发货 | Shipped | 3 |
| `completed` | 已完成 | Completed | 4 |
| `refunding` | 退款中 | Refunding | 2 |
| `refund_cancelled` | 退款撤销 | Refund Cancelled | - |
| `cancelled` | 已关闭 | Cancelled | 5 |

### 状态转换规则

```mermaid
stateDiagram-v2
[*] --> processing : 新订单创建
processing --> pending_ship : 买家付款
processing --> cancelled : 买家取消
pending_ship --> shipped : 卖家发货
pending_ship --> completed : 自动确认收货
pending_ship --> refunded : 退款申请
shipped --> completed : 买家确认收货
shipped --> cancelled : 交易关闭
shipped --> refunded : 退款申请
completed --> cancelled : 退款完成
completed --> refunded : 退款申请
refunded --> completed : 退款撤销
refunded --> cancelled : 退款完成
cancelled --> [*]
refund_cancelled --> [*]
```

**图表来源**
- [order_status_handler.py](file://order_status_handler.py#L36-L44)

**章节来源**
- [order_status_handler.py](file://order_status_handler.py#L36-L44)
- [order_status_handler.py](file://order_status_handler.py#L51-L58)

## API端点详细说明

### 1. 获取用户订单列表

#### 端点
`GET /api/orders`

#### 功能描述
获取当前登录用户的订单列表信息，支持按Cookie账号分类展示。

#### 请求参数
无参数

#### 响应格式
```json
{
  "success": true,
  "data": [
    {
      "order_id": "2856024697612814489",
      "item_id": "123456789",
      "buyer_id": "buyer123",
      "spec_name": "颜色",
      "spec_value": "红色",
      "quantity": "1",
      "amount": "¥99.00",
      "order_status": "pending_ship",
      "cookie_id": "cookie_001",
      "created_at": "2024-01-15T10:30:00Z",
      "updated_at": "2024-01-15T10:35:00Z"
    }
  ]
}
```

#### 响应字段说明

| 字段名 | 类型 | 描述 |
|--------|------|------|
| `order_id` | String | 订单唯一标识符 |
| `item_id` | String | 商品唯一标识符 |
| `buyer_id` | String | 买家用户ID |
| `spec_name` | String | 商品规格名称 |
| `spec_value` | String | 商品规格值 |
| `quantity` | String | 购买数量 |
| `amount` | String | 订单总金额 |
| `order_status` | String | 订单当前状态 |
| `cookie_id` | String | 关联的Cookie账号 |
| `created_at` | DateTime | 订单创建时间 |
| `updated_at` | DateTime | 订单最后更新时间 |

#### 实现细节
- 限制最多获取1000条订单记录
- 按创建时间倒序排列
- 自动添加Cookie信息到每个订单对象
- 记录用户操作日志

**章节来源**
- [reply_server.py](file://reply_server.py#L5524-L5558)
- [db_manager.py](file://db_manager.py#L4506-L4515)

### 2. 获取订单详情

#### 端点
`GET /api/orders/{order_id}`

#### 功能描述
获取指定订单的详细信息，包括商品规格、数量、金额等。

#### 路径参数
| 参数名 | 类型 | 必需 | 描述 |
|--------|------|------|------|
| `order_id` | String | 是 | 要查询的订单ID |

#### 响应格式
```json
{
  "success": true,
  "data": {
    "order_id": "2856024697612814489",
    "url": "https://www.goofish.com/order-detail?orderId=2856024697612814489&role=seller",
    "title": "订单详情 - 2856024697612814489",
    "sku_info": {
      "spec_name": "尺寸",
      "spec_value": "XL",
      "quantity": "2",
      "amount": "¥198.00"
    },
    "spec_name": "尺寸",
    "spec_value": "XL",
    "quantity": "2",
    "amount": "¥198.00",
    "order_status": "shipped",
    "timestamp": 1705324800.123456,
    "from_cache": false
  }
}
```

#### 实现机制
系统采用智能缓存策略：
1. **数据库检查**：首先查询本地数据库
2. **缓存命中**：如果订单存在且金额有效，直接返回缓存数据
3. **浏览器获取**：如果数据缺失或无效，使用Playwright浏览器自动化获取最新信息
4. **数据验证**：确保金额字段的有效性

**章节来源**
- [order_detail_fetcher.py](file://utils/order_detail_fetcher.py#L200-L351)
- [order_detail_fetcher.py](file://utils/order_detail_fetcher.py#L657-L737)

## 数据模型与结构

### 订单表结构

系统使用SQLite数据库存储订单信息，订单表结构如下：

```mermaid
erDiagram
ORDERS {
string order_id PK
string item_id
string buyer_id
string spec_name
string spec_value
string quantity
string amount
string order_status
string cookie_id FK
timestamp created_at
timestamp updated_at
}
COOKIES {
string id PK
string value
integer user_id FK
boolean auto_confirm
string remark
integer pause_duration
string username
string password
integer show_browser
timestamp created_at
}
ORDERS ||--|| COOKIES : belongs_to
```

**图表来源**
- [db_manager.py](file://db_manager.py#L219-L234)

### 订单状态映射

系统维护订单状态的双向映射关系：

| 状态代码 | 中文描述 | 英文描述 |
|----------|----------|----------|
| `processing` | 处理中 | Processing |
| `pending_ship` | 待发货 | Pending Ship |
| `shipped` | 已发货 | Shipped |
| `completed` | 已完成 | Completed |
| `refunding` | 退款中 | Refunding |
| `refund_cancelled` | 退款撤销 | Refund Cancelled |
| `cancelled` | 已关闭 | Cancelled |

**章节来源**
- [order_status_handler.py](file://order_status_handler.py#L51-L58)

## 权限验证机制

系统实现了多层次的权限验证机制：

### 认证流程

```mermaid
sequenceDiagram
participant Client as 客户端
participant Auth as 认证中间件
participant Token as Token管理器
participant API as API端点
participant DB as 数据库
Client->>Auth : 发送请求 + Bearer Token
Auth->>Token : 验证Token有效性
Token->>DB : 检查Token是否存在
DB-->>Token : 返回Token状态
Token-->>Auth : Token验证结果
alt Token有效
Auth->>API : 转发请求
API-->>Client : 返回数据
else Token无效
Auth-->>Client : 401 Unauthorized
end
```

**图表来源**
- [reply_server.py](file://reply_server.py#L188-L229)

### 权限控制层级

| 权限级别 | 描述 | 实现方式 |
|----------|------|----------|
| 无权限 | 未登录用户 | `verify_token()` |
| 用户权限 | 已登录普通用户 | `require_auth()` |
| 管理员权限 | 系统管理员 | `require_admin()` |
| 独立权限 | Cookie专属权限 | `verify_cookie_permission()` |

### 错误响应格式

系统统一使用标准的HTTP状态码和错误响应格式：

```json
{
  "detail": "未授权访问",
  "status_code": 401
}
```

**章节来源**
- [reply_server.py](file://reply_server.py#L188-L241)

## 错误处理策略

### 常见错误码及处理

| 错误码 | 场景描述 | 处理策略 |
|--------|----------|----------|
| 401 | 未授权访问 | 跳转登录页面 |
| 403 | 权限不足 | 显示权限错误提示 |
| 404 | 订单不存在 | 返回空结果或提示 |
| 500 | 服务器内部错误 | 记录日志并返回通用错误 |

### 错误处理流程

```mermaid
flowchart TD
Request[接收请求] --> ValidateAuth{验证权限}
ValidateAuth --> |失败| AuthError[返回401/403]
ValidateAuth --> |成功| ProcessRequest[处理业务逻辑]
ProcessRequest --> CheckData{检查数据}
CheckData --> |数据不存在| NotFound[返回404]
CheckData --> |数据有效| Success[返回成功响应]
ProcessRequest --> |发生异常| InternalError[返回500]
AuthError --> LogError[记录错误日志]
NotFound --> LogError
InternalError --> LogError
LogError --> ErrorResponse[返回错误响应]
```

**图表来源**
- [app.js](file://static/js/app.js#L1108-L1148)

### 错误恢复机制

系统实现了多种错误恢复策略：

1. **浏览器重连**：Playwright浏览器连接断开时自动重连
2. **数据库重试**：数据库操作失败时自动重试
3. **缓存降级**：API调用失败时使用本地缓存数据
4. **状态回退**：退款撤销时自动回退到上一状态

**章节来源**
- [order_detail_fetcher.py](file://utils/order_detail_fetcher.py#L293-L300)
- [order_status_handler.py](file://order_status_handler.py#L261-L269)

## 实际使用示例

### 前端JavaScript示例

以下是前端获取订单列表的完整示例：

```javascript
// 获取订单列表
async function fetchOrders() {
    try {
        const response = await fetch('/api/orders', {
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('auth_token')}`
            }
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const result = await response.json();
        if (result.success) {
            displayOrders(result.data);
        } else {
            showToast('获取订单列表失败', 'danger');
        }
    } catch (error) {
        console.error('获取订单列表失败:', error);
        showToast('网络错误，请稍后重试', 'danger');
    }
}

// 显示订单列表
function displayOrders(orders) {
    const tbody = document.querySelector('#ordersTableBody');
    if (!tbody) return;
    
    tbody.innerHTML = orders.map(order => `
        <tr>
            <td>${order.order_id}</td>
            <td>${order.item_id}</td>
            <td>${order.spec_value || '无'}</td>
            <td>${order.amount || '¥0.00'}</td>
            <td><span class="badge ${getStatusClass(order.order_status)}">
                ${getStatusText(order.order_status)}
            </span></td>
            <td>${formatDate(order.created_at)}</td>
            <td>
                <button class="btn btn-sm btn-info" 
                        onclick="viewOrderDetails('${order.order_id}')">
                    查看详情
                </button>
            </td>
        </tr>
    `).join('');
}
```

### 后端Python示例

以下是后端获取订单详情的实现示例：

```python
@app.get('/api/orders/{order_id}')
def get_order_detail(order_id: str, current_user: Dict[str, Any] = Depends(get_current_user)):
    """获取订单详细信息"""
    try:
        from utils.order_detail_fetcher import fetch_order_detail_simple
        
        # 使用智能缓存获取订单详情
        order_detail = fetch_order_detail_simple(
            order_id=order_id,
            cookie_string=current_user.get('cookie_string'),
            headless=True
        )
        
        if order_detail:
            return {"success": True, "data": order_detail}
        else:
            return {"success": False, "detail": "订单详情获取失败"}
            
    except Exception as e:
        logger.error(f"获取订单详情失败: {order_id} - {str(e)}")
        raise HTTPException(status_code=500, detail="服务器内部错误")
```

### API请求示例

#### 获取订单列表
```bash
curl -X GET "http://localhost:8080/api/orders" \
     -H "Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
```

#### 获取订单详情
```bash
curl -X GET "http://localhost:8080/api/orders/2856024697612814489" \
     -H "Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
```

**章节来源**
- [app.js](file://static/js/app.js#L8770-L8793)
- [reply_server.py](file://reply_server.py#L5524-L5558)

## 性能优化建议

### 缓存策略

1. **数据库缓存**：订单信息在数据库中缓存，避免重复查询
2. **浏览器缓存**：Playwright浏览器实例复用，减少初始化开销
3. **内存缓存**：订单状态历史记录在内存中维护

### 并发控制

1. **订单锁机制**：使用线程锁防止同一订单的并发更新
2. **浏览器实例池**：维护多个浏览器实例处理并发请求
3. **队列管理**：待处理更新使用队列机制有序处理

### 监控指标

建议监控以下关键指标：
- API响应时间
- 订单获取成功率
- 浏览器初始化耗时
- 数据库查询性能
- 缓存命中率

### 扩展性考虑

1. **水平扩展**：支持多实例部署
2. **负载均衡**：分布式订单状态管理
3. **异步处理**：大量订单的批量处理
4. **监控告警**：关键错误的实时通知

**章节来源**
- [order_detail_fetcher.py](file://utils/order_detail_fetcher.py#L40-L42)
- [order_status_handler.py](file://order_status_handler.py#L465-L486)