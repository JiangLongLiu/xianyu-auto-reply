# 验证码处理机制

<cite>
**本文档引用的文件**   
- [xianyu_slider_stealth.py](file://utils/xianyu_slider_stealth.py)
- [captcha_remote_control.py](file://utils/captcha_remote_control.py)
- [api_captcha_remote.py](file://api_captcha_remote.py)
- [item_search.py](file://utils/item_search.py)
- [XianyuAutoAsync.py](file://XianyuAutoAsync.py)
</cite>

## 目录
1. [引言](#引言)
2. [验证码检测与类型识别](#验证码检测与类型识别)
3. [标准滑块处理机制](#标准滑块处理机制)
4. [刮刮乐滑块处理机制](#刮刮乐滑块处理机制)
5. [重试机制与超时处理](#重试机制与超时处理)
6. [状态监控与会话管理](#状态监控与会话管理)
7. [扩展与分布式环境](#扩展与分布式环境)

## 引言
本系统设计了一套完整的验证码处理机制，旨在应对闲鱼平台上的两种主要滑块验证码：标准滑块和刮刮乐滑块。系统通过多选择器策略和iframe检测来精确识别验证码类型，并采用不同的处理策略。对于标准滑块，系统集成了XianyuSliderStealth进行自动化破解；对于刮刮乐滑块，系统通过远程控制会话生成控制链接，支持用户在网页上手动完成验证。该机制结合了重试、超时处理和状态监控，确保了高可靠性和用户体验。

## 验证码检测与类型识别
系统通过`handle_slider_verification`方法实现对两种滑块验证码的检测和处理。该方法首先使用多选择器策略在主页面和iframe中搜索滑块元素，以确保不遗漏任何可能的验证码。

```mermaid
flowchart TD
Start([开始检测滑块]) --> Wait["等待页面加载 (1秒)"]
Wait --> CheckHTML["检查页面HTML内容"]
CheckHTML --> CheckSelectors["遍历选择器列表"]
CheckSelectors --> Query["查询选择器"]
Query --> IsFound{"元素找到?"}
IsFound --> |是| IsVisible{"元素可见?"}
IsVisible --> |是| SetDetected["设置检测到的滑块"]
IsVisible --> |否| Continue["继续下一个选择器"]
IsFound --> |否| Continue
Continue --> NextSelector["下一个选择器?"]
NextSelector --> |是| Query
NextSelector --> |否| CheckIframe["检查iframe"]
CheckIframe --> IframeFound{"iframe中找到?"}
IframeFound --> |是| SetDetected
IframeFound --> |否| NoSlider["未检测到滑块"]
SetDetected --> CheckType["检测滑块类型"]
CheckType --> IsScratch{"是刮刮乐类型?"}
IsScratch --> |是| HandleScratch["处理刮刮乐"]
IsScratch --> |否| HandleStandard["处理标准滑块"]
```

**图源**
- [item_search.py](file://utils/item_search.py#L411-L623)

**本节源**
- [item_search.py](file://utils/item_search.py#L411-L623)

## 标准滑块处理机制
对于标准滑块，系统集成XianyuSliderStealth进行自动化破解。XianyuSliderStealth是一个增强反检测版本的滑块验证工具，它通过模拟人类行为来绕过平台的检测机制。

```mermaid
sequenceDiagram
participant XianyuAutoAsync as XianyuAutoAsync
participant ItemSearch as item_search
participant SliderStealth as XianyuSliderStealth
XianyuAutoAsync->>ItemSearch : _handle_captcha_verification()
ItemSearch->>ItemSearch : 创建XianyuSearcher实例
ItemSearch->>ItemSearch : 调用handle_slider_verification()
ItemSearch->>ItemSearch : 检测到标准滑块
ItemSearch->>SliderStealth : 创建XianyuSliderStealth实例
SliderStealth->>SliderStealth : 初始化浏览器(反检测配置)
SliderStealth->>SliderStealth : 计算滑动距离
SliderStealth->>SliderStealth : 生成人类化轨迹
SliderStealth->>SliderStealth : 执行滑动操作
SliderStealth-->>ItemSearch : 返回成功/失败
ItemSearch-->>XianyuAutoAsync : 返回新cookies
```

**图源**
- [xianyu_slider_stealth.py](file://utils/xianyu_slider_stealth.py#L244-L703)
- [item_search.py](file://utils/item_search.py#L569-L593)

**本节源**
- [xianyu_slider_stealth.py](file://utils/xianyu_slider_stealth.py#L244-L703)
- [item_search.py](file://utils/item_search.py#L569-L593)

## 刮刮乐滑块处理机制
对于刮刮乐滑块，系统采用远程控制会话的方式，通过WebSocket实时传输页面截图到前端，支持用户手动完成验证。

```mermaid
sequenceDiagram
participant XianyuAutoAsync as XianyuAutoAsync
participant ItemSearch as item_search
participant CaptchaCtrl as CaptchaRemoteController
participant API as api_captcha_remote
participant User as 用户
XianyuAutoAsync->>ItemSearch : _handle_captcha_verification()
ItemSearch->>ItemSearch : 调用handle_slider_verification()
ItemSearch->>ItemSearch : 检测到刮刮乐滑块
ItemSearch->>CaptchaCtrl : create_session()
CaptchaCtrl->>CaptchaCtrl : 截取验证码区域
CaptchaCtrl-->>ItemSearch : 返回会话信息
ItemSearch->>API : 生成控制链接
API->>User : 提供控制页面URL
User->>API : 访问控制页面
API->>CaptchaCtrl : 建立WebSocket连接
CaptchaCtrl->>User : 发送初始截图
loop 用户操作
User->>API : 发送鼠标事件
API->>CaptchaCtrl : 转发鼠标事件
CaptchaCtrl->>Page : 执行鼠标操作
CaptchaCtrl->>User : 更新截图
end
CaptchaCtrl->>CaptchaCtrl : check_completion()
CaptchaCtrl-->>User : 发送完成消息
CaptchaCtrl-->>XianyuAutoAsync : 验证成功
```

**图源**
- [captcha_remote_control.py](file://utils/captcha_remote_control.py#L14-L368)
- [api_captcha_remote.py](file://api_captcha_remote.py#L38-L156)
- [item_search.py](file://utils/item_search.py#L52-L150)

**本节源**
- [captcha_remote_control.py](file://utils/captcha_remote_control.py#L14-L368)
- [api_captcha_remote.py](file://api_captcha_remote.py#L38-L156)
- [item_search.py](file://utils/item_search.py#L52-L150)

## 重试机制与超时处理
系统实现了完善的重试机制和超时处理，确保在各种异常情况下都能正确处理。

```mermaid
flowchart TD
Start([开始处理]) --> MaxRetries["检查最大重试次数"]
MaxRetries --> Exceeded{"超过最大重试?"}
Exceeded --> |是| Fail["返回失败"]
Exceeded --> |否| Process["处理验证码"]
Process --> Success{"成功?"}
Success --> |是| SuccessEnd["返回成功"]
Success --> |否| Delay["计算重试延迟"]
Delay --> Wait["等待延迟时间"]
Wait --> MaxRetries
subgraph 重试延迟计算
Delay --> CheckError["检查错误类型"]
CheckError --> IsNetwork{"网络错误?"}
IsNetwork --> |是| LongDelay["长延迟"]
IsNetwork --> |否| IsClose{"连接关闭?"}
IsClose --> |是| ShortDelay["短延迟"]
IsClose --> |否| MediumDelay["中等延迟"]
end
```

**图源**
- [XianyuAutoAsync.py](file://XianyuAutoAsync.py#L453-L465)
- [XianyuAutoAsync.py](file://XianyuAutoAsync.py#L1302-L1306)

**本节源**
- [XianyuAutoAsync.py](file://XianyuAutoAsync.py#L453-L465)
- [XianyuAutoAsync.py](file://XianyuAutoAsync.py#L1302-L1306)

## 状态监控与会话管理
系统通过多种机制实现状态监控和会话管理，确保系统的稳定运行。

```mermaid
classDiagram
class CaptchaRemoteController {
+active_sessions : Dict[str, Dict]
+websocket_connections : Dict[str, WebSocket]
+create_session(session_id, page)
+update_screenshot(session_id)
+handle_mouse_event(session_id, event_type, x, y)
+check_completion(session_id)
+is_completed(session_id)
+session_exists(session_id)
+close_session(session_id)
+auto_refresh_screenshot(session_id)
}
class XianyuSliderStealth {
+user_id : str
+enable_learning : bool
+headless : bool
+browser : Browser
+page : Page
+context : BrowserContext
+playwright : Playwright
+solve_slider(max_retries)
+init_browser()
+_get_random_browser_features()
+_get_stealth_script()
}
class XianyuLive {
+captcha_verification_count : int
+max_captcha_verification_count : int
+_handle_captcha_verification(res_json)
+_need_captcha_verification(res_json)
}
class XianyuSearcher {
+handle_slider_verification(page, max_retries)
+_handle_scratch_captcha_manual(page)
+_handle_scratch_captcha_async(page)
}
XianyuLive --> XianyuSearcher : "使用"
XianyuSearcher --> XianyuSliderStealth : "使用"
XianyuSearcher --> CaptchaRemoteController : "使用"
```

**图源**
- [captcha_remote_control.py](file://utils/captcha_remote_control.py#L14-L368)
- [xianyu_slider_stealth.py](file://utils/xianyu_slider_stealth.py#L244-L703)
- [XianyuAutoAsync.py](file://XianyuAutoAsync.py#L711-L713)
- [item_search.py](file://utils/item_search.py#L411-L623)

**本节源**
- [captcha_remote_control.py](file://utils/captcha_remote_control.py#L14-L368)
- [xianyu_slider_stealth.py](file://utils/xianyu_slider_stealth.py#L244-L703)
- [XianyuAutoAsync.py](file://XianyuAutoAsync.py#L711-L713)
- [item_search.py](file://utils/item_search.py#L411-L623)

## 扩展与分布式环境
系统设计考虑了扩展性和分布式环境下的会话管理。通过全局实例管理和并发控制，确保在多用户环境下稳定运行。

```mermaid
erDiagram
USER_SESSION {
string user_id PK
string session_id
string status
timestamp created_at
timestamp updated_at
string verification_type
string verification_url
string control_url
}
CAPTCHA_SESSION {
string session_id PK
string user_id FK
string page_reference
string screenshot_base64
boolean completed
timestamp created_at
timestamp updated_at
}
WEBSOCKET_CONNECTION {
string session_id PK
string websocket_reference
timestamp connected_at
timestamp disconnected_at
}
USER_SESSION ||--o{ CAPTCHA_SESSION : "创建"
USER_SESSION ||--o{ WEBSOCKET_CONNECTION : "建立"
```

**图源**
- [XianyuAutoAsync.py](file://XianyuAutoAsync.py#L172-L185)
- [captcha_remote_control.py](file://utils/captcha_remote_control.py#L18-L19)

**本节源**
- [XianyuAutoAsync.py](file://XianyuAutoAsync.py#L172-L185)
- [captcha_remote_control.py](file://utils/captcha_remote_control.py#L18-L19)