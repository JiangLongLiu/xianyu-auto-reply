# è®¢å•å¤„ç†ç³»ç»ŸçŠ¶æ€ç®¡ç†æœºåˆ¶

<cite>
**æœ¬æ–‡æ¡£å¼•ç”¨çš„æ–‡ä»¶**
- [order_status_handler.py](file://order_status_handler.py)
- [utils/message_utils.py](file://utils/message_utils.py)
- [db_manager.py](file://db_manager.py)
- [XianyuAutoAsync.py](file://XianyuAutoAsync.py)
- [config.py](file://config.py)
</cite>

## ç›®å½•
1. [ç³»ç»Ÿæ¦‚è¿°](#ç³»ç»Ÿæ¦‚è¿°)
2. [æ ¸å¿ƒç»„ä»¶æ¶æ„](#æ ¸å¿ƒç»„ä»¶æ¶æ„)
3. [çŠ¶æ€è½¬æ¢è§„åˆ™](#çŠ¶æ€è½¬æ¢è§„åˆ™)
4. [è®¢å•çŠ¶æ€å¤„ç†å™¨è¯¦è§£](#è®¢å•çŠ¶æ€å¤„ç†å™¨è¯¦è§£)
5. [æ¶ˆæ¯å¤„ç†ä¸çŠ¶æ€æ›´æ–°](#æ¶ˆæ¯å¤„ç†ä¸çŠ¶æ€æ›´æ–°)
6. [æ•°æ®åº“æ“ä½œä¸é‡è¯•æœºåˆ¶](#æ•°æ®åº“æ“ä½œä¸é‡è¯•æœºåˆ¶)
7. [å¾…å¤„ç†é˜Ÿåˆ—ç®¡ç†](#å¾…å¤„ç†é˜Ÿåˆ—ç®¡ç†)
8. [æ¶ˆæ¯æ ¼å¼åŒ–å·¥å…·](#æ¶ˆæ¯æ ¼å¼åŒ–å·¥å…·)
9. [é…ç½®ä¸æ‰©å±•æ€§](#é…ç½®ä¸æ‰©å±•æ€§)
10. [æ•…éšœæ’é™¤æŒ‡å—](#æ•…éšœæ’é™¤æŒ‡å—)

## ç³»ç»Ÿæ¦‚è¿°

è®¢å•å¤„ç†ç³»ç»Ÿæ˜¯ä¸€ä¸ªé«˜åº¦è‡ªåŠ¨åŒ–çš„ä¼ä¸šçº§è§£å†³æ–¹æ¡ˆï¼Œä¸“é—¨è®¾è®¡ç”¨äºå¤„ç†é—²é±¼å¹³å°ä¸Šçš„è®¢å•çŠ¶æ€å˜æ›´ã€‚è¯¥ç³»ç»Ÿé€šè¿‡WebSocketå®æ—¶æ¥æ”¶æ¶ˆæ¯ï¼Œæ™ºèƒ½è§£æè®¢å•çŠ¶æ€ï¼Œå¹¶ç¡®ä¿æ‰€æœ‰çŠ¶æ€è½¬æ¢éƒ½ç¬¦åˆé¢„å®šä¹‰çš„ä¸šåŠ¡è§„åˆ™ã€‚

### ä¸»è¦ç‰¹æ€§

- **ä¸¥æ ¼çš„ä¸šåŠ¡è§„åˆ™éªŒè¯**ï¼šç¡®ä¿è®¢å•çŠ¶æ€åªèƒ½æŒ‰ç…§é¢„è®¾çš„ä¸šåŠ¡é€»è¾‘è¿›è¡Œè½¬æ¢
- **åŸå­æ€§çŠ¶æ€æ›´æ–°**ï¼šé€šè¿‡æ•°æ®åº“äº‹åŠ¡å’Œé‡è¯•æœºåˆ¶ä¿è¯çŠ¶æ€å˜æ›´çš„å¯é æ€§
- **æ™ºèƒ½æ¶ˆæ¯è§£æ**ï¼šä»å¤æ‚çš„WebSocketæ¶ˆæ¯ç»“æ„ä¸­æå–è®¢å•ID
- **å¾…å¤„ç†é˜Ÿåˆ—æœºåˆ¶**ï¼šä¼˜é›…å¤„ç†æ•°æ®åº“ä¸­ä¸å­˜åœ¨çš„è®¢å•çŠ¶æ€æ›´æ–°
- **å®Œå–„çš„æ—¥å¿—è®°å½•**ï¼šæä¾›è¯¦ç»†çš„å®¡è®¡è·Ÿè¸ªå’Œè°ƒè¯•ä¿¡æ¯

## æ ¸å¿ƒç»„ä»¶æ¶æ„

```mermaid
graph TB
subgraph "æ¶ˆæ¯å±‚"
WS[WebSocketè¿æ¥]
MSG[æ¶ˆæ¯è§£æå™¨]
end
subgraph "ä¸šåŠ¡é€»è¾‘å±‚"
OSH[è®¢å•çŠ¶æ€å¤„ç†å™¨]
VAL[çŠ¶æ€éªŒè¯å™¨]
QUEUE[å¾…å¤„ç†é˜Ÿåˆ—]
end
subgraph "æ•°æ®å±‚"
DB[(SQLiteæ•°æ®åº“)]
CACHE[çŠ¶æ€å†å²ç¼“å­˜]
end
subgraph "å·¥å…·å±‚"
UTIL[æ¶ˆæ¯æ ¼å¼åŒ–å·¥å…·]
CONFIG[é…ç½®ç®¡ç†]
end
WS --> MSG
MSG --> OSH
OSH --> VAL
OSH --> QUEUE
OSH --> DB
OSH --> CACHE
OSH --> UTIL
OSH --> CONFIG
```

**å›¾è¡¨æ¥æº**
- [order_status_handler.py](file://order_status_handler.py#L26-L1074)
- [XianyuAutoAsync.py](file://XianyuAutoAsync.py#L158-L8372)

## çŠ¶æ€è½¬æ¢è§„åˆ™

ç³»ç»Ÿå®šä¹‰äº†ä¸€å¥—ä¸¥æ ¼çš„è®¢å•çŠ¶æ€è½¬æ¢è§„åˆ™ï¼Œç¡®ä¿ä¸šåŠ¡é€»è¾‘çš„æ­£ç¡®æ€§ã€‚

### çŠ¶æ€æšä¸¾

| çŠ¶æ€ä»£ç  | ä¸­æ–‡æè¿° | è‹±æ–‡æè¿° |
|---------|---------|---------|
| processing | å¤„ç†ä¸­ | Processing |
| pending_ship | å¾…å‘è´§ | Pending Ship |
| shipped | å·²å‘è´§ | Shipped |
| completed | å·²å®Œæˆ | Completed |
| refunding | é€€æ¬¾ä¸­ | Refunding |
| refund_cancelled | é€€æ¬¾æ’¤é”€ | Refund Cancelled |
| cancelled | å·²å…³é—­ | Cancelled |

### çŠ¶æ€è½¬æ¢çŸ©é˜µ

```mermaid
stateDiagram-v2
[*] --> processing : è®¢å•åˆ›å»º
processing --> pending_ship : å·²ä»˜æ¬¾
processing --> shipped : ç›´æ¥å‘è´§
processing --> completed : è‡ªåŠ¨ç¡®è®¤
processing --> cancelled : å–æ¶ˆè®¢å•
pending_ship --> shipped : å‘è´§ç¡®è®¤
pending_ship --> completed : è‡ªåŠ¨ç¡®è®¤
pending_ship --> cancelled : å–æ¶ˆè®¢å•
pending_ship --> refunding : é€€æ¬¾ç”³è¯·
shipped --> completed : ç¡®è®¤æ”¶è´§
shipped --> cancelled : å–æ¶ˆè®¢å•
shipped --> refunding : é€€æ¬¾ç”³è¯·
completed --> cancelled : é€€æ¬¾å®Œæˆ
completed --> refunding : é€€æ¬¾ç”³è¯·
refunding --> completed : å–æ¶ˆé€€æ¬¾
refunding --> cancelled : é€€æ¬¾å®Œæˆ
refunding --> refund_cancelled : é€€æ¬¾æ’¤é”€
refund_cancelled --> processing : å›é€€åˆ°å¤„ç†ä¸­ç‰¹æ®Š
refund_cancelled --> pending_ship : å›é€€åˆ°å¾…å‘è´§
refund_cancelled --> shipped : å›é€€åˆ°å·²å‘è´§
refund_cancelled --> completed : å›é€€åˆ°å·²å®Œæˆ
refund_cancelled --> cancelled : å›é€€åˆ°å·²å…³é—­
cancelled --> [*] : ç»ˆæ€
```

**å›¾è¡¨æ¥æº**
- [order_status_handler.py](file://order_status_handler.py#L36-L43)

### å…³é”®ä¸šåŠ¡è§„åˆ™

1. **ç¦æ­¢çŠ¶æ€å›é€€**ï¼šå·²ä»˜æ¬¾çš„è®¢å•å’Œå·²å®Œæˆçš„è®¢å•ä¸èƒ½å›é€€åˆ°å¤„ç†ä¸­çŠ¶æ€
2. **é€€æ¬¾ç‰¹æ®Šå¤„ç†**ï¼šé€€æ¬¾ä¸­çš„è®¢å•å¯ä»¥è®¾ç½®ä¸ºå·²å®Œæˆï¼ˆå–æ¶ˆé€€æ¬¾ï¼‰æˆ–å·²å…³é—­ï¼ˆé€€æ¬¾å®Œæˆï¼‰
3. **ä¸´æ—¶çŠ¶æ€**ï¼šé€€æ¬¾æ’¤é”€çŠ¶æ€ï¼ˆrefund_cancelledï¼‰æ˜¯ä¸´æ—¶çŠ¶æ€ï¼Œä¼šç«‹å³å›é€€åˆ°ä¸Šä¸€æ¬¡çŠ¶æ€
4. **ç»ˆæ€ä¿æŠ¤**ï¼šå·²å…³é—­çŠ¶æ€ï¼ˆcancelledï¼‰ä¸èƒ½è½¬æ¢åˆ°å…¶ä»–ä»»ä½•çŠ¶æ€

**èŠ‚æ¥æº**
- [order_status_handler.py](file://order_status_handler.py#L36-L43)
- [order_status_handler.py](file://order_status_handler.py#L309-L330)

## è®¢å•çŠ¶æ€å¤„ç†å™¨è¯¦è§£

### OrderStatusHandlerç±»æ ¸å¿ƒåŠŸèƒ½

OrderStatusHandlerç±»æ˜¯ç³»ç»Ÿçš„æ ¸å¿ƒç»„ä»¶ï¼Œè´Ÿè´£ç®¡ç†æ‰€æœ‰è®¢å•çŠ¶æ€ç›¸å…³çš„ä¸šåŠ¡é€»è¾‘ã€‚

#### åˆå§‹åŒ–é…ç½®

ç³»ç»Ÿæä¾›äº†çµæ´»çš„é…ç½®é€‰é¡¹ï¼Œæ”¯æŒä¸åŒçš„éƒ¨ç½²éœ€æ±‚ï¼š

```python
ORDER_STATUS_HANDLER_CONFIG = {
    'use_pending_queue': True,                     # æ˜¯å¦ä½¿ç”¨å¾…å¤„ç†é˜Ÿåˆ—
    'strict_validation': True,                     # æ˜¯å¦å¯ç”¨ä¸¥æ ¼çš„çŠ¶æ€è½¬æ¢éªŒè¯
    'log_level': 'info',                          # æ—¥å¿—çº§åˆ«
    'max_pending_age_hours': 24,                  # å¾…å¤„ç†æ›´æ–°çš„æœ€å¤§ä¿ç•™æ—¶é—´
    'enable_status_logging': True,                # æ˜¯å¦å¯ç”¨è¯¦ç»†çš„çŠ¶æ€å˜æ›´æ—¥å¿—
}
```

#### å¹¶å‘æ§åˆ¶æœºåˆ¶

ç³»ç»Ÿä½¿ç”¨threading.RLockç¡®ä¿çº¿ç¨‹å®‰å…¨ï¼š

```python
# ä½¿ç”¨threading.RLockä¿æŠ¤å¹¶å‘è®¿é—®
self._lock = threading.RLock()
```

#### çŠ¶æ€æ˜ å°„è¡¨

ç³»ç»Ÿç»´æŠ¤äº†ä¸€ä¸ªå®Œæ•´çš„çŠ¶æ€æ˜ å°„è¡¨ï¼Œæ”¯æŒä¸­è‹±æ–‡çŠ¶æ€æè¿°ï¼š

```python
self.status_mapping = {
    'processing': 'å¤„ç†ä¸­',
    'pending_ship': 'å¾…å‘è´§',
    'shipped': 'å·²å‘è´§',
    'completed': 'å·²å®Œæˆ',
    'refunding': 'é€€æ¬¾ä¸­',
    'refund_cancelled': 'é€€æ¬¾æ’¤é”€',
    'cancelled': 'å·²å…³é—­',
}
```

**èŠ‚æ¥æº**
- [order_status_handler.py](file://order_status_handler.py#L15-L23)
- [order_status_handler.py](file://order_status_handler.py#L46-L75)

### update_order_statusæ–¹æ³•è¯¦è§£

update_order_statusæ–¹æ³•æ˜¯çŠ¶æ€æ›´æ–°çš„æ ¸å¿ƒå…¥å£ï¼Œå®ç°äº†ä¸¥æ ¼çš„éªŒè¯å’Œå¯é çš„æ•°æ®åº“æ“ä½œã€‚

#### éªŒè¯æµç¨‹

```mermaid
flowchart TD
START([å¼€å§‹çŠ¶æ€æ›´æ–°]) --> VALIDATE_STATUS[éªŒè¯çŠ¶æ€æœ‰æ•ˆæ€§]
VALIDATE_STATUS --> STATUS_VALID{çŠ¶æ€æœ‰æ•ˆ?}
STATUS_VALID --> |å¦| ERROR1[è¿”å›é”™è¯¯]
STATUS_VALID --> |æ˜¯| GET_ORDER[è·å–è®¢å•ä¿¡æ¯]
GET_ORDER --> ORDER_EXISTS{è®¢å•å­˜åœ¨?}
ORDER_EXISTS --> |å¦| CHECK_PENDING{å¯ç”¨å¾…å¤„ç†é˜Ÿåˆ—?}
CHECK_PENDING --> |æ˜¯| ADD_PENDING[æ·»åŠ åˆ°å¾…å¤„ç†é˜Ÿåˆ—]
CHECK_PENDING --> |å¦| ERROR2[è¿”å›é”™è¯¯]
ORDER_EXISTS --> |æ˜¯| CHECK_SAME{çŠ¶æ€ç›¸åŒ?}
CHECK_SAME --> |æ˜¯| SKIP[è·³è¿‡é‡å¤æ›´æ–°]
CHECK_SAME --> |å¦| VALIDATE_TRANSITION[éªŒè¯çŠ¶æ€è½¬æ¢]
VALIDATE_TRANSITION --> TRANSITION_VALID{è½¬æ¢æœ‰æ•ˆ?}
TRANSITION_VALID --> |å¦| ERROR3[è¿”å›é”™è¯¯]
TRANSITION_VALID --> |æ˜¯| HANDLE_REFUND[å¤„ç†é€€æ¬¾æ’¤é”€]
HANDLE_REFUND --> UPDATE_DB[æ›´æ–°æ•°æ®åº“]
UPDATE_DB --> RECORD_HISTORY[è®°å½•çŠ¶æ€å†å²]
RECORD_HISTORY --> SUCCESS[è¿”å›æˆåŠŸ]
ADD_PENDING --> SUCCESS
SKIP --> SUCCESS
ERROR1 --> END([ç»“æŸ])
ERROR2 --> END
ERROR3 --> END
SUCCESS --> END
```

**å›¾è¡¨æ¥æº**
- [order_status_handler.py](file://order_status_handler.py#L192-L307)

#### æ•°æ®åº“é‡è¯•æœºåˆ¶

ç³»ç»Ÿå®ç°äº†æ™ºèƒ½çš„æ•°æ®åº“é‡è¯•æœºåˆ¶ï¼Œç¡®ä¿æ“ä½œçš„å¯é æ€§ï¼š

```python
max_retries = 3
for attempt in range(max_retries):
    try:
        # æ•°æ®åº“æ“ä½œ
        success = db_manager.insert_or_update_order(...)
        break
    except Exception as db_e:
        if attempt == max_retries - 1:
            # æœ€åä¸€æ¬¡å°è¯•å¤±è´¥
            return False
        else:
            # é€’å¢å»¶è¿Ÿé‡è¯•
            time.sleep(0.1 * (attempt + 1))
```

#### çŠ¶æ€å†å²è®°å½•

ç³»ç»Ÿä¼šè®°å½•æ‰€æœ‰æœ‰æ•ˆçš„çŠ¶æ€å˜æ›´ï¼Œç”¨äºé€€æ¬¾æ’¤é”€æ—¶çš„å›é€€ï¼š

```python
def _record_status_history(self, order_id: str, from_status: str, to_status: str, context: str):
    with self._lock:
        if order_id not in self._order_status_history:
            self._order_status_history[order_id] = []
        
        # åªè®°å½•éä¸´æ—¶çŠ¶æ€çš„å†å²
        if to_status != 'refund_cancelled':
            history_entry = {
                'from_status': from_status,
                'to_status': to_status,
                'context': context,
                'timestamp': time.time()
            }
            self._order_status_history[order_id].append(history_entry)
```

**èŠ‚æ¥æº**
- [order_status_handler.py](file://order_status_handler.py#L192-L307)
- [order_status_handler.py](file://order_status_handler.py#L419-L446)

### _is_valid_status_transitionæ–¹æ³•

è¯¥æ–¹æ³•å®ç°äº†ä¸¥æ ¼çš„çŠ¶æ€è½¬æ¢éªŒè¯é€»è¾‘ï¼š

```python
def _is_valid_status_transition(self, current_status: str, new_status: str) -> bool:
    # å¦‚æœå½“å‰çŠ¶æ€ä¸åœ¨è§„åˆ™ä¸­ï¼Œå…è®¸è½¬æ¢ï¼ˆå…¼å®¹æ€§ï¼‰
    if current_status not in self.VALID_TRANSITIONS:
        return True
    
    # ç‰¹æ®Šè§„åˆ™ï¼šå·²ä»˜æ¬¾çš„è®¢å•å’Œå·²å®Œæˆçš„è®¢å•ä¸èƒ½å›é€€åˆ°å¤„ç†ä¸­
    if new_status == 'processing' and current_status in ['pending_ship', 'shipped', 'completed', 'refunding', 'refund_cancelled']:
        return False
    
    # æ£€æŸ¥æ–°çŠ¶æ€æ˜¯å¦åœ¨å…è®¸çš„è½¬æ¢åˆ—è¡¨ä¸­
    allowed_statuses = self.VALID_TRANSITIONS.get(current_status, [])
    return new_status in allowed_statuses
```

**èŠ‚æ¥æº**
- [order_status_handler.py](file://order_status_handler.py#L309-L330)

## æ¶ˆæ¯å¤„ç†ä¸çŠ¶æ€æ›´æ–°

### extract_order_idæ–¹æ³•

ç³»ç»Ÿèƒ½å¤Ÿä»å¤æ‚çš„WebSocketæ¶ˆæ¯ç»“æ„ä¸­æå–è®¢å•IDï¼Œæ”¯æŒå¤šç§æå–ç­–ç•¥ï¼š

#### æå–ç­–ç•¥

1. **ä¼˜å…ˆç­–ç•¥**ï¼šä»buttonçš„targetUrlä¸­æå–orderId
2. **å¤‡ç”¨ç­–ç•¥**ï¼šä»mainçš„targetUrlä¸­æå–order_detailçš„id  
3. **å…œåº•ç­–ç•¥**ï¼šåœ¨æ¶ˆæ¯å­—ç¬¦ä¸²ä¸­æœç´¢å„ç§å¯èƒ½çš„è®¢å•IDæ¨¡å¼

#### æ”¯æŒçš„è®¢å•IDæ¨¡å¼

```python
patterns = [
    r'orderId[=:](\d{10,})',           # orderId=123456789
    r'order_detail\?id=(\d{10,})',    # order_detail?id=123456789
    r'"id"\s*:\s*"?(\d{10,})"?',      # "id":"123456789" æˆ– "id":123456789
    r'bizOrderId[=:](\d{10,})',       # bizOrderId=123456789
]
```

#### æ¶ˆæ¯ç»“æ„åˆ†æ

ç³»ç»Ÿä¼šå¯¹æ¶ˆæ¯ç»“æ„è¿›è¡Œæ·±åº¦åˆ†æï¼Œæä¾›è¯¦ç»†çš„è°ƒè¯•ä¿¡æ¯ï¼š

```python
# æ£€æŸ¥message['1']çš„ç»“æ„
message_1 = message.get('1', {})
if isinstance(message_1, dict):
    logger.info(f"ğŸ” message['1'] æ˜¯å­—å…¸ï¼Œkeys: {list(message_1.keys())}")
```

**èŠ‚æ¥æº**
- [order_status_handler.py](file://order_status_handler.py#L81-L186)
- [order_status_handler.py](file://order_status_handler.py#L163-L176)

### handle_system_messageæ–¹æ³•

è¯¥æ–¹æ³•å¤„ç†ç³»ç»Ÿæ¶ˆæ¯å¹¶æ›´æ–°è®¢å•çŠ¶æ€ï¼Œå®ç°äº†æ™ºèƒ½çš„çŠ¶æ€ä¼˜å…ˆçº§åˆ¤æ–­ï¼š

#### çŠ¶æ€ä¼˜å…ˆçº§æ˜ å°„

```python
status_priority = {
    'processing': 1,      # å¤„ç†ä¸­
    'pending_ship': 2,    # å¾…å‘è´§
    'shipped': 3,         # å·²å‘è´§
    'completed': 4,       # å·²å®Œæˆ
    'refunding': 2,       # é€€æ¬¾ä¸­ï¼ˆä¸å¾…å‘è´§åŒçº§ï¼‰
    'cancelled': 5,       # å·²å–æ¶ˆï¼ˆç»ˆæ€ï¼‰
}
```

#### æ™ºèƒ½çŠ¶æ€è¿‡æ»¤

ç³»ç»Ÿä¼šæ™ºèƒ½åœ°è¿‡æ»¤æ‰ä¸åˆç†çš„çŠ¶æ€å›é€€ï¼š

```python
# å¦‚æœæ–°çŠ¶æ€çš„ä¼˜å…ˆçº§ä½äºå½“å‰çŠ¶æ€ï¼Œä¸”ä¸æ˜¯ç‰¹æ®ŠçŠ¶æ€ï¼ˆé€€æ¬¾ã€å–æ¶ˆï¼‰ï¼Œåˆ™å¿½ç•¥
if new_priority < current_priority and new_status not in ['refunding', 'cancelled']:
    logger.warning(f'å¿½ç•¥å›é€€åˆ° {new_status}')
    return True  # è¿”å›Trueè¡¨ç¤ºå·²å¤„ç†ï¼Œä½†å®é™…ä¸Šæ˜¯å¿½ç•¥
```

**èŠ‚æ¥æº**
- [order_status_handler.py](file://order_status_handler.py#L633-L758)
- [order_status_handler.py](file://order_status_handler.py#L722-L739)

## æ•°æ®åº“æ“ä½œä¸é‡è¯•æœºåˆ¶

### insert_or_update_orderæ–¹æ³•

ç³»ç»Ÿæä¾›äº†åŸå­æ€§çš„è®¢å•æ•°æ®åº“æ“ä½œï¼š

#### æ“ä½œæµç¨‹

```mermaid
sequenceDiagram
participant Client as å®¢æˆ·ç«¯
participant Handler as çŠ¶æ€å¤„ç†å™¨
participant DB as æ•°æ®åº“ç®¡ç†å™¨
participant Lock as æ•°æ®åº“é”
Client->>Handler : update_order_status()
Handler->>Lock : è·å–æ•°æ®åº“é”
Lock-->>Handler : é”è·å–æˆåŠŸ
Handler->>DB : æ£€æŸ¥è®¢å•æ˜¯å¦å­˜åœ¨
DB-->>Handler : è¿”å›è®¢å•ä¿¡æ¯
Handler->>DB : æ‰§è¡ŒINSERT/UPDATEæ“ä½œ
DB-->>Handler : æ“ä½œç»“æœ
alt æ“ä½œæˆåŠŸ
Handler->>DB : æäº¤äº‹åŠ¡
DB-->>Handler : äº‹åŠ¡æäº¤æˆåŠŸ
Handler-->>Client : è¿”å›True
else æ“ä½œå¤±è´¥
Handler->>DB : å›æ»šäº‹åŠ¡
DB-->>Handler : äº‹åŠ¡å›æ»šæˆåŠŸ
Handler-->>Client : è¿”å›False
end
Handler->>Lock : é‡Šæ”¾æ•°æ®åº“é”
```

**å›¾è¡¨æ¥æº**
- [db_manager.py](file://db_manager.py#L4400-L4474)

#### æ•°æ®å®Œæ•´æ€§ä¿éšœ

1. **å¤–é”®çº¦æŸæ£€æŸ¥**ï¼šç¡®ä¿cookie_idå­˜åœ¨äºcookiesè¡¨ä¸­
2. **äº‹åŠ¡åŸå­æ€§**ï¼šæ‰€æœ‰æ•°æ®åº“æ“ä½œåœ¨ä¸€ä¸ªäº‹åŠ¡ä¸­å®Œæˆ
3. **å¼‚å¸¸å¤„ç†**ï¼šæ•è·æ‰€æœ‰å¼‚å¸¸å¹¶å›æ»šäº‹åŠ¡

### get_order_by_idæ–¹æ³•

æä¾›å®‰å…¨çš„è®¢å•æŸ¥è¯¢æ¥å£ï¼š

```python
def get_order_by_id(self, order_id: str):
    with self.lock:
        try:
            cursor = self.conn.cursor()
            cursor.execute('''
            SELECT order_id, item_id, buyer_id, spec_name, spec_value,
                   quantity, amount, order_status, cookie_id, created_at, updated_at
            FROM orders WHERE order_id = ?
            ''', (order_id,))
            
            row = cursor.fetchone()
            if row:
                return {
                    'order_id': row[0],
                    'item_id': row[1],
                    'buyer_id': row[2],
                    'spec_name': row[3],
                    'spec_value': row[4],
                    'quantity': row[5],
                    'amount': row[6],
                    'order_status': row[7],
                    'cookie_id': row[8],
                    'created_at': row[9],
                    'updated_at': row[10]
                }
            return None
        except Exception as e:
            logger.error(f"è·å–è®¢å•ä¿¡æ¯å¤±è´¥: {order_id} - {e}")
            return None
```

**èŠ‚æ¥æº**
- [db_manager.py](file://db_manager.py#L4400-L4474)
- [db_manager.py](file://db_manager.py#L4475-L4505)

## å¾…å¤„ç†é˜Ÿåˆ—ç®¡ç†

### é˜Ÿåˆ—æ¶æ„

ç³»ç»Ÿå®ç°äº†å¤šå±‚æ¬¡çš„å¾…å¤„ç†é˜Ÿåˆ—æœºåˆ¶ï¼š

```mermaid
graph LR
subgraph "å¾…å¤„ç†é˜Ÿåˆ—å±‚æ¬¡"
PQ[å¾…å¤„ç†æ›´æ–°é˜Ÿåˆ—<br/>pending_updates]
SM[å¾…å¤„ç†ç³»ç»Ÿæ¶ˆæ¯é˜Ÿåˆ—<br/>_pending_system_messages]
RM[å¾…å¤„ç†çº¢è‰²æé†’æ¶ˆæ¯é˜Ÿåˆ—<br/>_pending_red_reminder_messages]
end
subgraph "å¤„ç†æœºåˆ¶"
EP[æå–è®¢å•ID]
PO[å¤„ç†å¾…å¤„ç†æ›´æ–°]
CL[æ¸…ç†è¿‡æœŸé¡¹ç›®]
end
PQ --> PO
SM --> EP
RM --> EP
EP --> PO
PO --> CL
```

**å›¾è¡¨æ¥æº**
- [order_status_handler.py](file://order_status_handler.py#L61-L70)

### _add_to_pending_updatesæ–¹æ³•

å½“è®¢å•ä¸å­˜åœ¨äºæ•°æ®åº“æ—¶ï¼Œç³»ç»Ÿä¼šå°†çŠ¶æ€æ›´æ–°è¯·æ±‚æ·»åŠ åˆ°å¾…å¤„ç†é˜Ÿåˆ—ï¼š

```python
def _add_to_pending_updates(self, order_id: str, new_status: str, cookie_id: str, context: str):
    with self._lock:
        if order_id not in self.pending_updates:
            self.pending_updates[order_id] = []
        
        update_info = {
            'new_status': new_status,
            'cookie_id': cookie_id,
            'context': context,
            'timestamp': time.time()
        }
        
        self.pending_updates[order_id].append(update_info)
```

### process_pending_updatesæ–¹æ³•

ç³»ç»Ÿä¼šå®šæœŸå¤„ç†å¾…å¤„ç†é˜Ÿåˆ—ä¸­çš„æ›´æ–°è¯·æ±‚ï¼š

```python
def process_pending_updates(self, order_id: str) -> bool:
    with self._lock:
        if order_id not in self.pending_updates:
            return False
        
        updates = self.pending_updates.pop(order_id)
        processed_count = 0
    
    for update_info in updates:
        success = self.update_order_status(
            order_id=order_id,
            new_status=update_info['new_status'],
            cookie_id=update_info['cookie_id'],
            context=f"å¾…å¤„ç†é˜Ÿåˆ—: {update_info['context']}"
        )
        
        if success:
            processed_count += 1
    
    return processed_count > 0
```

### æ¸…ç†æœºåˆ¶

ç³»ç»Ÿå®ç°äº†æ™ºèƒ½çš„è¿‡æœŸé¡¹ç›®æ¸…ç†æœºåˆ¶ï¼š

```python
def clear_old_pending_updates(self, max_age_hours: int = None):
    current_time = time.time()
    max_age_seconds = max_age_hours * 3600 if max_age_hours else self.config.get('max_pending_age_hours', 24) * 3600
    
    with self._lock:
        # æ¸…ç†pending_updates
        expired_orders = []
        for order_id, updates in self.pending_updates.items():
            valid_updates = [
                update for update in updates 
                if current_time - update['timestamp'] < max_age_seconds
            ]
            
            if not valid_updates:
                expired_orders.append(order_id)
            else:
                self.pending_updates[order_id] = valid_updates
        
        # ç§»é™¤å®Œå…¨è¿‡æœŸçš„è®¢å•
        for order_id in expired_orders:
            del self.pending_updates[order_id]
```

**èŠ‚æ¥æº**
- [order_status_handler.py](file://order_status_handler.py#L465-L486)
- [order_status_handler.py](file://order_status_handler.py#L488-L525)
- [order_status_handler.py](file://order_status_handler.py#L555-L631)

## æ¶ˆæ¯æ ¼å¼åŒ–å·¥å…·

### format_messageå‡½æ•°

æä¾›ç»Ÿä¸€çš„æ¶ˆæ¯æ ¼å¼åŒ–è¾“å‡ºï¼š

```python
def format_message(message_data: Dict[str, Any], is_outgoing: bool = False, is_manual: bool = False) -> str:
    try:
        # è·å–æ¶ˆæ¯å†…å®¹
        content = message_data.get('content', '')
        if not content:
            return ''
            
        # è·å–å‘é€æ—¶é—´
        timestamp = message_data.get('time', time.time() * 1000)
        time_str = time.strftime('%Y-%m-%d %H:%M:%S', time.localtime(timestamp / 1000))
        
        # ç¡®å®šæ¶ˆæ¯æ–¹å‘
        direction = 'ã€å‘å‡ºã€‘' if is_outgoing else 'ã€æ”¶åˆ°ã€‘'
        if is_manual:
            direction = 'ã€æ‰‹åŠ¨å‘å‡ºã€‘'
            
        # æ ¼å¼åŒ–è¾“å‡º
        return f"{time_str} {direction} {content}"
    except Exception as e:
        return f"æ¶ˆæ¯æ ¼å¼åŒ–é”™è¯¯: {str(e)}"
```

### format_system_messageå‡½æ•°

ä¸“é—¨ç”¨äºæ ¼å¼åŒ–ç³»ç»Ÿæ¶ˆæ¯ï¼š

```python
def format_system_message(message: str) -> str:
    time_str = time.strftime('%Y-%m-%d %H:%M:%S', time.localtime())
    return f"{time_str} ã€ç³»ç»Ÿã€‘ {message}"
```

**èŠ‚æ¥æº**
- [utils/message_utils.py](file://utils/message_utils.py#L4-L24)
- [utils/message_utils.py](file://utils/message_utils.py#L26-L29)

## é…ç½®ä¸æ‰©å±•æ€§

### é…ç½®ç®¡ç†

ç³»ç»Ÿä½¿ç”¨Configç±»æä¾›é›†ä¸­å¼çš„é…ç½®ç®¡ç†ï¼š

```python
class Config:
    """é…ç½®ç®¡ç†ç±»"""
    
    def get(self, key: str, default: Any = None) -> Any:
        """è·å–é…ç½®é¡¹"""
        keys = key.split('.')
        value = self._config
        for k in keys:
            if isinstance(value, dict):
                value = value.get(k)
            else:
                return default
            if value is None:
                return default
        return value
    
    def set(self, key: str, value: Any) -> None:
        """è®¾ç½®é…ç½®é¡¹"""
        keys = key.split('.')
        config = self._config
        for k in keys[:-1]:
            if k not in config:
                config[k] = {}
            config = config[k]
        config[keys[-1]] = value
```

### æ‰©å±•ç‚¹

1. **è‡ªå®šä¹‰çŠ¶æ€è½¬æ¢è§„åˆ™**ï¼šå¯ä»¥é€šè¿‡ä¿®æ”¹VALID_TRANSITIONSå¸¸é‡æ¥æ‰©å±•çŠ¶æ€è½¬æ¢é€»è¾‘
2. **æ¶ˆæ¯å¤„ç†æ‰©å±•**ï¼šå¯ä»¥æ·»åŠ æ–°çš„æ¶ˆæ¯ç±»å‹å¤„ç†å™¨
3. **æ•°æ®åº“é€‚é…**ï¼šå¯ä»¥é€šè¿‡ä¿®æ”¹db_manageræ¥é€‚é…ä¸åŒçš„æ•°æ®åº“ç³»ç»Ÿ
4. **æ—¥å¿—çº§åˆ«è°ƒæ•´**ï¼šå¯ä»¥é€šè¿‡é…ç½®è°ƒæ•´æ—¥å¿—è¯¦ç»†ç¨‹åº¦

**èŠ‚æ¥æº**
- [config.py](file://config.py#L5-L86)

## æ•…éšœæ’é™¤æŒ‡å—

### å¸¸è§é—®é¢˜åŠè§£å†³æ–¹æ¡ˆ

#### 1. è®¢å•çŠ¶æ€è½¬æ¢å¤±è´¥

**ç—‡çŠ¶**ï¼šçŠ¶æ€æ›´æ–°è¿”å›Falseï¼Œä½†æ²¡æœ‰æ˜ç¡®é”™è¯¯ä¿¡æ¯

**æ’æŸ¥æ­¥éª¤**ï¼š
1. æ£€æŸ¥è®¢å•IDæ˜¯å¦æ­£ç¡®
2. éªŒè¯çŠ¶æ€è½¬æ¢è§„åˆ™
3. æ£€æŸ¥æ•°æ®åº“è¿æ¥çŠ¶æ€
4. æŸ¥çœ‹è¯¦ç»†é”™è¯¯æ—¥å¿—

**è§£å†³æ–¹æ¡ˆ**ï¼š
```python
# å¯ç”¨è¯¦ç»†æ—¥å¿—
ORDER_STATUS_HANDLER_CONFIG['log_level'] = 'debug'
ORDER_STATUS_HANDLER_CONFIG['enable_status_logging'] = True
```

#### 2. è®¢å•IDæå–å¤±è´¥

**ç—‡çŠ¶**ï¼šæ— æ³•ä»æ¶ˆæ¯ä¸­æå–è®¢å•ID

**æ’æŸ¥æ­¥éª¤**ï¼š
1. æ£€æŸ¥æ¶ˆæ¯ç»“æ„æ˜¯å¦ç¬¦åˆé¢„æœŸ
2. éªŒè¯æ­£åˆ™è¡¨è¾¾å¼æ¨¡å¼
3. æŸ¥çœ‹æ¶ˆæ¯è§£ææ—¥å¿—

**è§£å†³æ–¹æ¡ˆ**ï¼š
```python
# å¢åŠ è°ƒè¯•ä¿¡æ¯
logger.info(f"å®Œæ•´æ¶ˆæ¯ç»“æ„: {message}")
```

#### 3. å¾…å¤„ç†é˜Ÿåˆ—å †ç§¯

**ç—‡çŠ¶**ï¼šå¾…å¤„ç†é˜Ÿåˆ—ä¸­çš„é¡¹ç›®æŒç»­å¢é•¿

**æ’æŸ¥æ­¥éª¤**ï¼š
1. æ£€æŸ¥æ•°æ®åº“è¿æ¥æ˜¯å¦æ­£å¸¸
2. éªŒè¯è®¢å•IDæå–é€»è¾‘
3. æŸ¥çœ‹é˜Ÿåˆ—æ¸…ç†æ—¥å¿—

**è§£å†³æ–¹æ¡ˆ**ï¼š
```python
# è°ƒæ•´æ¸…ç†é¢‘ç‡
self.config['max_pending_age_hours'] = 12
```

#### 4. æ•°æ®åº“äº‹åŠ¡å¤±è´¥

**ç—‡çŠ¶**ï¼šçŠ¶æ€æ›´æ–°æˆåŠŸä½†æ•°æ®åº“æ“ä½œå¤±è´¥

**æ’æŸ¥æ­¥éª¤**ï¼š
1. æ£€æŸ¥æ•°æ®åº“è¿æ¥æ± çŠ¶æ€
2. éªŒè¯å¤–é”®çº¦æŸ
3. æŸ¥çœ‹äº‹åŠ¡å›æ»šæ—¥å¿—

**è§£å†³æ–¹æ¡ˆ**ï¼š
```python
# å¢åŠ é‡è¯•æ¬¡æ•°
max_retries = 5
```

### ç›‘æ§æŒ‡æ ‡

å»ºè®®ç›‘æ§ä»¥ä¸‹å…³é”®æŒ‡æ ‡ï¼š

1. **çŠ¶æ€è½¬æ¢æˆåŠŸç‡**ï¼šæˆåŠŸçŠ¶æ€è½¬æ¢/æ€»çŠ¶æ€è½¬æ¢
2. **å¾…å¤„ç†é˜Ÿåˆ—é•¿åº¦**ï¼špending_updatesé˜Ÿåˆ—å¤§å°
3. **æ¶ˆæ¯å¤„ç†å»¶è¿Ÿ**ï¼šä»æ¶ˆæ¯æ¥æ”¶åˆ°çŠ¶æ€æ›´æ–°çš„æ—¶é—´
4. **æ•°æ®åº“è¿æ¥å¥åº·åº¦**ï¼šè¿æ¥æ± ä½¿ç”¨ç‡å’Œè¶…æ—¶æ¬¡æ•°

### æ€§èƒ½ä¼˜åŒ–å»ºè®®

1. **æ‰¹é‡å¤„ç†**ï¼šå¯¹äºå¤§é‡å¾…å¤„ç†æ›´æ–°ï¼Œè€ƒè™‘æ‰¹é‡å¤„ç†
2. **ç¼“å­˜ä¼˜åŒ–**ï¼šå¯¹é¢‘ç¹æŸ¥è¯¢çš„çŠ¶æ€è¿›è¡Œç¼“å­˜
3. **è¿æ¥æ± è°ƒä¼˜**ï¼šæ ¹æ®å¹¶å‘éœ€æ±‚è°ƒæ•´æ•°æ®åº“è¿æ¥æ± å¤§å°
4. **æ—¥å¿—åˆ†çº§**ï¼šåœ¨é«˜è´Ÿè½½æ—¶é™ä½æ—¥å¿—çº§åˆ«

**èŠ‚æ¥æº**
- [order_status_handler.py](file://order_status_handler.py#L204-L307)
- [order_status_handler.py](file://order_status_handler.py#L555-L631)

## ç»“è®º

è®¢å•å¤„ç†ç³»ç»Ÿé€šè¿‡ç²¾å¿ƒè®¾è®¡çš„çŠ¶æ€ç®¡ç†æœºåˆ¶ï¼Œç¡®ä¿äº†è®¢å•çŠ¶æ€å˜æ›´çš„å‡†ç¡®æ€§å’Œå¯é æ€§ã€‚ç³»ç»Ÿçš„æ ¸å¿ƒä¼˜åŠ¿åŒ…æ‹¬ï¼š

1. **ä¸¥æ ¼çš„ä¸šåŠ¡è§„åˆ™éªŒè¯**ï¼šé€šè¿‡VALID_TRANSITIONSå¸¸é‡ç¡®ä¿çŠ¶æ€è½¬æ¢çš„åˆæ³•æ€§
2. **å¯é çš„æ•°æ®åº“æ“ä½œ**ï¼šé€šè¿‡é‡è¯•æœºåˆ¶å’Œäº‹åŠ¡ä¿è¯æ•°æ®ä¸€è‡´æ€§
3. **æ™ºèƒ½çš„æ¶ˆæ¯å¤„ç†**ï¼šæ”¯æŒå¤æ‚çš„WebSocketæ¶ˆæ¯è§£æå’Œè®¢å•IDæå–
4. **ä¼˜é›…çš„é”™è¯¯å¤„ç†**ï¼šé€šè¿‡å¾…å¤„ç†é˜Ÿåˆ—æœºåˆ¶å¤„ç†ä¸´æ—¶æ€§é”™è¯¯
5. **å®Œå–„çš„ç›‘æ§ä½“ç³»**ï¼šæä¾›è¯¦ç»†çš„æ—¥å¿—è®°å½•å’ŒçŠ¶æ€è·Ÿè¸ª

è¯¥ç³»ç»Ÿä¸ºä¼ä¸šçº§åº”ç”¨æä¾›äº†ç¨³å®šã€å¯é ã€å¯æ‰©å±•çš„è®¢å•çŠ¶æ€ç®¡ç†è§£å†³æ–¹æ¡ˆï¼Œèƒ½å¤Ÿæ»¡è¶³å¤æ‚ä¸šåŠ¡åœºæ™¯ä¸‹çš„å„ç§éœ€æ±‚ã€‚