# çŠ¶æ€å†å²ç®¡ç†

<cite>
**æœ¬æ–‡æ¡£ä¸­å¼•ç”¨çš„æ–‡ä»¶**
- [order_status_handler.py](file://order_status_handler.py)
- [db_manager.py](file://db_manager.py)
- [XianyuAutoAsync.py](file://XianyuAutoAsync.py)
- [reply_server.py](file://reply_server.py)
</cite>

## ç›®å½•
1. [æ¦‚è¿°](#æ¦‚è¿°)
2. [æ ¸å¿ƒç»„ä»¶æ¶æ„](#æ ¸å¿ƒç»„ä»¶æ¶æ„)
3. [_order_status_historyå­—å…¸è¯¦è§£](#_order_status_historyå­—å…¸è¯¦è§£)
4. [_record_status_historyæ–¹æ³•æ·±åº¦åˆ†æ](#_record_status_historyæ–¹æ³•æ·±åº¦åˆ†æ)
5. [_get_previous_statusæ–¹æ³•è¯¦è§£](#_get_previous_statusæ–¹æ³•è¯¦è§£)
6. [çº¿ç¨‹å®‰å…¨æœºåˆ¶](#çº¿ç¨‹å®‰å…¨æœºåˆ¶)
7. [å†å²è®°å½•ä¿ç•™ç­–ç•¥](#å†å²è®°å½•ä¿ç•™ç­–ç•¥)
8. [é€€æ¬¾æ’¤é”€åœºæ™¯å¤„ç†](#é€€æ¬¾æ’¤é”€åœºæ™¯å¤„ç†)
9. [çŠ¶æ€å†å²è®¿é—®ä¸è°ƒè¯•](#çŠ¶æ€å†å²è®¿é—®ä¸è°ƒè¯•)
10. [æ•°æ®åº“æŒä¹…åŒ–æ–¹æ¡ˆ](#æ•°æ®åº“æŒä¹…åŒ–æ–¹æ¡ˆ)
11. [æœ€ä½³å®è·µæŒ‡å¯¼](#æœ€ä½³å®è·µæŒ‡å¯¼)
12. [æ•…éšœæ’é™¤æŒ‡å—](#æ•…éšœæ’é™¤æŒ‡å—)

## æ¦‚è¿°

è®¢å•çŠ¶æ€å†å²ç®¡ç†ç³»ç»Ÿæ˜¯Xianyu Auto Replyé¡¹ç›®ä¸­çš„æ ¸å¿ƒç»„ä»¶ï¼Œè´Ÿè´£è·Ÿè¸ªå’Œç®¡ç†è®¢å•çŠ¶æ€çš„æ¯ä¸€æ¬¡å˜æ›´ã€‚è¯¥ç³»ç»Ÿé€šè¿‡`_order_status_history`å­—å…¸è®°å½•çŠ¶æ€å˜æ›´å†å²ï¼Œä¸ºé€€æ¬¾æ’¤é”€ã€çŠ¶æ€å›é€€å’Œå¼‚å¸¸æ’æŸ¥æä¾›å…³é”®çš„æ•°æ®æ”¯æ’‘ã€‚

### ä¸»è¦åŠŸèƒ½ç‰¹æ€§

- **å®æ—¶çŠ¶æ€è¿½è¸ª**ï¼šè®°å½•æ¯ä¸ªè®¢å•çš„çŠ¶æ€å˜æ›´è¿‡ç¨‹
- **çº¿ç¨‹å®‰å…¨ä¿éšœ**ï¼šä½¿ç”¨é”æœºåˆ¶ç¡®ä¿å¹¶å‘è®¿é—®çš„å®‰å…¨æ€§
- **æ™ºèƒ½å†å²ç®¡ç†**ï¼šé™åˆ¶å†å²è®°å½•æ•°é‡ï¼Œä¼˜åŒ–å†…å­˜ä½¿ç”¨
- **é€€æ¬¾æ’¤é”€æ”¯æŒ**ï¼šæä¾›çŠ¶æ€å›é€€åŠŸèƒ½
- **çµæ´»çš„è®¿é—®æ¥å£**ï¼šæ”¯æŒçŠ¶æ€å†å²çš„æŸ¥è¯¢å’Œåˆ†æ

## æ ¸å¿ƒç»„ä»¶æ¶æ„

```mermaid
classDiagram
class OrderStatusHandler {
-dict _order_status_history
-RLock _lock
-dict pending_updates
-dict status_mapping
+update_order_status() bool
+_record_status_history() void
+_get_previous_status() Optional~str~
+process_pending_updates() bool
+clear_old_pending_updates() void
}
class DBManager {
+insert_or_update_order() bool
+get_order_by_id() dict
+cleanup_old_data() dict
}
class StatusHistoryEntry {
+str from_status
+str to_status
+str context
+float timestamp
}
OrderStatusHandler --> DBManager : "ä½¿ç”¨"
OrderStatusHandler --> StatusHistoryEntry : "åˆ›å»º"
OrderStatusHandler --> StatusHistoryEntry : "ç®¡ç†"
```

**å›¾è¡¨æ¥æº**
- [order_status_handler.py](file://order_status_handler.py#L26-L100)
- [db_manager.py](file://db_manager.py#L16-L50)

**ç« èŠ‚æ¥æº**
- [order_status_handler.py](file://order_status_handler.py#L26-L100)

## _order_status_historyå­—å…¸è¯¦è§£

### æ•°æ®ç»“æ„è®¾è®¡

`_order_status_history`æ˜¯ä¸€ä¸ªåµŒå¥—å­—å…¸ç»“æ„ï¼Œç”¨äºå­˜å‚¨è®¢å•çŠ¶æ€å˜æ›´çš„å†å²è®°å½•ï¼š

```python
{
    "order_id_1": [
        {
            "from_status": "processing",
            "to_status": "pending_ship",
            "context": "ç”¨æˆ·ä»˜æ¬¾å®Œæˆ",
            "timestamp": 1640995200.123456
        },
        {
            "from_status": "pending_ship", 
            "to_status": "shipped",
            "context": "å•†å®¶å‘è´§",
            "timestamp": 1640995800.654321
        }
    ],
    "order_id_2": [...]
}
```

### å­—æ®µè¯´æ˜

| å­—æ®µå | ç±»å‹ | æè¿° | ç¤ºä¾‹å€¼ |
|--------|------|------|--------|
| `from_status` | str | çŠ¶æ€å˜æ›´å‰çš„åŸå§‹çŠ¶æ€ | `'processing'` |
| `to_status` | str | çŠ¶æ€å˜æ›´åçš„ç›®æ ‡çŠ¶æ€ | `'pending_ship'` |
| `context` | str | çŠ¶æ€å˜æ›´çš„ä¸Šä¸‹æ–‡æè¿° | `'ç”¨æˆ·ä»˜æ¬¾å®Œæˆ'` |
| `timestamp` | float | Unixæ—¶é—´æˆ³ï¼Œç²¾ç¡®åˆ°å¾®ç§’ | `1640995200.123456` |

### è®¾è®¡è€ƒé‡

1. **é€‰æ‹©å­—å…¸è€Œéåˆ—è¡¨**ï¼šä»¥è®¢å•IDä¸ºé”®ï¼Œä¾¿äºå¿«é€ŸæŸ¥æ‰¾å’Œæ›´æ–°
2. **æœ‰åºå†å²è®°å½•**ï¼šåˆ—è¡¨é¡ºåºåæ˜ çŠ¶æ€å˜æ›´çš„æ—¶é—´åºåˆ—
3. **æ’é™¤ä¸´æ—¶çŠ¶æ€**ï¼šä¸è®°å½•`refund_cancelled`ç­‰ä¸´æ—¶çŠ¶æ€ï¼Œé¿å…å†å²æ··ä¹±

**ç« èŠ‚æ¥æº**
- [order_status_handler.py](file://order_status_handler.py#L67-L70)
- [order_status_handler.py](file://order_status_handler.py#L418-L447)

## _record_status_historyæ–¹æ³•æ·±åº¦åˆ†æ

### æ–¹æ³•ç­¾åä¸å‚æ•°

```python
def _record_status_history(self, order_id: str, from_status: str, to_status: str, context: str):
```

### æ ¸å¿ƒå®ç°æµç¨‹

```mermaid
flowchart TD
Start([å¼€å§‹è®°å½•çŠ¶æ€å†å²]) --> AcquireLock["è·å–çº¿ç¨‹é”"]
AcquireLock --> CheckOrderExists{"è®¢å•IDæ˜¯å¦å­˜åœ¨?"}
CheckOrderExists --> |å¦| InitEmptyList["åˆå§‹åŒ–ç©ºå†å²åˆ—è¡¨"]
CheckOrderExists --> |æ˜¯| CheckRefundCancelled{"ç›®æ ‡çŠ¶æ€æ˜¯<br/>refund_cancelled?"}
InitEmptyList --> CheckRefundCancelled
CheckRefundCancelled --> |æ˜¯| SkipRecord["è·³è¿‡è®°å½•ä¸´æ—¶çŠ¶æ€"]
CheckRefundCancelled --> |å¦| CreateHistoryEntry["åˆ›å»ºå†å²è®°å½•æ¡ç›®"]
CreateHistoryEntry --> AppendToHistory["è¿½åŠ åˆ°å†å²åˆ—è¡¨"]
AppendToHistory --> CheckLimit{"å†å²è®°å½•æ•°é‡<br/>> 10?"}
CheckLimit --> |æ˜¯| TruncateHistory["æˆªå–æœ€è¿‘10æ¡è®°å½•"]
CheckLimit --> |å¦| LogDebug["è®°å½•è°ƒè¯•æ—¥å¿—"]
TruncateHistory --> LogDebug
SkipRecord --> ReleaseLock["é‡Šæ”¾çº¿ç¨‹é”"]
LogDebug --> ReleaseLock
ReleaseLock --> End([ç»“æŸ])
```

**å›¾è¡¨æ¥æº**
- [order_status_handler.py](file://order_status_handler.py#L418-L447)

### å…³é”®å®ç°ç»†èŠ‚

1. **æ¡ä»¶è®°å½•è¿‡æ»¤**ï¼šåªæœ‰éä¸´æ—¶çŠ¶æ€æ‰ä¼šè¢«è®°å½•
2. **åŸå­æ€§æ“ä½œ**ï¼šæ•´ä¸ªè®°å½•è¿‡ç¨‹åœ¨é”ä¿æŠ¤ä¸‹å®Œæˆ
3. **è‡ªåŠ¨æˆªæ–­**ï¼šè¶…å‡º10æ¡æ—¶è‡ªåŠ¨ä¿ç•™æœ€æ–°è®°å½•
4. **è°ƒè¯•æ—¥å¿—**ï¼šæä¾›è¯¦ç»†çš„è®°å½•ä¿¡æ¯ç”¨äºè°ƒè¯•

### é”™è¯¯å¤„ç†æœºåˆ¶

- **å¼‚å¸¸å®‰å…¨**ï¼šå³ä½¿å‘ç”Ÿå¼‚å¸¸ï¼Œé”ä¹Ÿä¼šè¢«æ­£ç¡®é‡Šæ”¾
- **é™é»˜å¤±è´¥**ï¼šè®°å½•å¤±è´¥ä¸ä¼šå½±å“ä¸»ä¸šåŠ¡æµç¨‹
- **è¯¦ç»†æ—¥å¿—**ï¼šè®°å½•è¯¦ç»†çš„è°ƒè¯•ä¿¡æ¯

**ç« èŠ‚æ¥æº**
- [order_status_handler.py](file://order_status_handler.py#L418-L447)

## _get_previous_statusæ–¹æ³•è¯¦è§£

### æ–¹æ³•åŠŸèƒ½

`_get_previous_status`æ–¹æ³•ç”¨äºè·å–è®¢å•çš„ä¸Šä¸€æ¬¡æœ‰æ•ˆçŠ¶æ€ï¼Œä¸»è¦ç”¨äºé€€æ¬¾æ’¤é”€åœºæ™¯ä¸‹çš„çŠ¶æ€å›é€€ã€‚

### å®ç°é€»è¾‘

```mermaid
sequenceDiagram
participant Client as "è°ƒç”¨æ–¹"
participant Method as "_get_previous_status"
participant History as "_order_status_history"
Client->>Method : _get_previous_status(order_id)
Method->>Method : è·å–çº¿ç¨‹é”
Method->>History : æ£€æŸ¥è®¢å•æ˜¯å¦å­˜åœ¨
History-->>Method : å­˜åœ¨/ä¸å­˜åœ¨
alt è®¢å•ä¸å­˜åœ¨æˆ–æ— å†å²è®°å½•
Method-->>Client : è¿”å›None
else è®¢å•å­˜åœ¨ä¸”æœ‰å†å²è®°å½•
Method->>History : è·å–æœ€æ–°å†å²è®°å½•
History-->>Method : æœ€æ–°çŠ¶æ€æ¡ç›®
Method->>Method : æå–to_statuså­—æ®µ
Method-->>Client : è¿”å›ä¸Šä¸€æ¬¡çŠ¶æ€
end
Method->>Method : é‡Šæ”¾çº¿ç¨‹é”
```

**å›¾è¡¨æ¥æº**
- [order_status_handler.py](file://order_status_handler.py#L448-L464)

### çŠ¶æ€å›é€€ç®—æ³•

1. **æ£€æŸ¥è®¢å•å­˜åœ¨æ€§**ï¼šç¡®è®¤è®¢å•åœ¨å†å²è®°å½•ä¸­
2. **éªŒè¯å†å²è®°å½•**ï¼šç¡®ä¿æœ‰å¯ç”¨çš„å†å²çŠ¶æ€
3. **æå–ç›®æ ‡çŠ¶æ€**ï¼šè·å–æœ€åä¸€æ¬¡çŠ¶æ€å˜æ›´çš„ç›®æ ‡çŠ¶æ€
4. **è¿”å›ç»“æœ**ï¼šæä¾›ä¸Šä¸€æ¬¡çš„æœ‰æ•ˆçŠ¶æ€

### åº”ç”¨åœºæ™¯

- **é€€æ¬¾æ’¤é”€**ï¼šå½“ç”¨æˆ·æ’¤é”€é€€æ¬¾ç”³è¯·æ—¶ï¼Œå›é€€åˆ°ä¹‹å‰çš„ç¨³å®šçŠ¶æ€
- **å¼‚å¸¸æ¢å¤**ï¼šç³»ç»Ÿå¼‚å¸¸åçš„çŠ¶æ€æ¢å¤
- **å®¡è®¡è¿½è¸ª**ï¼šçŠ¶æ€å˜æ›´çš„å®¡è®¡å’Œè¿½æº¯

**ç« èŠ‚æ¥æº**
- [order_status_handler.py](file://order_status_handler.py#L448-L464)

## çº¿ç¨‹å®‰å…¨æœºåˆ¶

### é”æœºåˆ¶è®¾è®¡

ç³»ç»Ÿé‡‡ç”¨`threading.RLock`å®ç°çº¿ç¨‹å®‰å…¨ï¼š

```python
# åˆå§‹åŒ–æ—¶åˆ›å»ºå¯é‡å…¥é”
self._lock = threading.RLock()

# åœ¨æ‰€æœ‰å…³é”®æ“ä½œä¸­ä½¿ç”¨é”ä¿æŠ¤
with self._lock:
    # çº¿ç¨‹å®‰å…¨çš„æ“ä½œ
    pass
```

### é”ä½¿ç”¨ç­–ç•¥

1. **ç»Ÿä¸€é”ç®¡ç†**ï¼šæ‰€æœ‰çŠ¶æ€å†å²æ“ä½œéƒ½ä½¿ç”¨åŒä¸€ä¸ªé”
2. **é¿å…æ­»é”**ï¼šéµå¾ªä¸€è‡´çš„é”è·å–é¡ºåº
3. **æ€§èƒ½ä¼˜åŒ–**ï¼šä½¿ç”¨å¯é‡å…¥é”å‡å°‘é”ç«äº‰

### å¹¶å‘æ§åˆ¶æµç¨‹

```mermaid
flowchart TD
Request[è¯·æ±‚çŠ¶æ€æ›´æ–°] --> AcquireLock[è·å–é”]
AcquireLock --> CheckConditions[æ£€æŸ¥å‰ç½®æ¡ä»¶]
CheckConditions --> PerformOperation[æ‰§è¡ŒçŠ¶æ€æ›´æ–°]
PerformOperation --> RecordHistory[è®°å½•çŠ¶æ€å†å²]
RecordHistory --> ReleaseLock[é‡Šæ”¾é”]
ReleaseLock --> NotifySuccess[é€šçŸ¥æˆåŠŸ]
AcquireLock --> LockWait[ç­‰å¾…é”é‡Šæ”¾]
LockWait --> AcquireLock
```

**å›¾è¡¨æ¥æº**
- [order_status_handler.py](file://order_status_handler.py#L72-L74)

### æ€§èƒ½è€ƒé‡

- **é”ç²’åº¦**ï¼šç»†ç²’åº¦é”å‡å°‘é”ç«äº‰
- **æŒæœ‰æ—¶é—´**ï¼šæœ€å°åŒ–é”æŒæœ‰æ—¶é—´
- **å¯é‡å…¥æ€§**ï¼šé¿å…æ­»é”æƒ…å†µ

**ç« èŠ‚æ¥æº**
- [order_status_handler.py](file://order_status_handler.py#L72-L74)

## å†å²è®°å½•ä¿ç•™ç­–ç•¥

### æ•°é‡é™åˆ¶æœºåˆ¶

ç³»ç»Ÿé‡‡ç”¨å›ºå®šå¤§å°çš„æ»‘åŠ¨çª—å£ç­–ç•¥ï¼š

```python
# é™åˆ¶å†å²è®°å½•æ•°é‡ï¼Œåªä¿ç•™æœ€è¿‘10æ¡
if len(self._order_status_history[order_id]) > 10:
    self._order_status_history[order_id] = self._order_status_history[order_id][-10:]
```

### è®¾è®¡åŸåˆ™

1. **å®ç”¨æ€§ä¼˜å…ˆ**ï¼š10æ¡è®°å½•è¶³ä»¥è¦†ç›–å¤§å¤šæ•°ä¸šåŠ¡åœºæ™¯
2. **å†…å­˜æ•ˆç‡**ï¼šé¿å…æ— é™å¢é•¿å¯¼è‡´å†…å­˜æ³„æ¼
3. **å†å²å®Œæ•´æ€§**ï¼šä¿ç•™è¶³å¤Ÿçš„å†å²ä¿¡æ¯ç”¨äºåˆ†æ
4. **æ€§èƒ½å¹³è¡¡**ï¼šåœ¨å­˜å‚¨æ•ˆç‡å’Œä¿¡æ¯å®Œæ•´æ€§ä¹‹é—´æ‰¾åˆ°å¹³è¡¡

### æ›¿ä»£æ–¹æ¡ˆå¯¹æ¯”

| æ–¹æ¡ˆ | ä¼˜åŠ¿ | åŠ£åŠ¿ | é€‚ç”¨åœºæ™¯ |
|------|------|------|----------|
| å›ºå®š10æ¡ | å†…å­˜å ç”¨å¯æ§ | å¯èƒ½ä¸¢å¤±æ—©æœŸä¿¡æ¯ | ç”Ÿäº§ç¯å¢ƒ |
| æŒ‰æ—¶é—´é™åˆ¶ | ä¿ç•™æ—¶é—´èŒƒå›´å†…çš„è®°å½• | æ—¶é—´çª—å£å¤–çš„ä¿¡æ¯ä¸¢å¤± | éœ€è¦æ—¶é—´èŒƒå›´åˆ†æ |
| æ— é™å¢é•¿ | ä¿ç•™å®Œæ•´å†å² | å†…å­˜æ¶ˆè€—å¤§ | å¼€å‘è°ƒè¯•ç¯å¢ƒ |

### æ‰©å±•å»ºè®®

å¯¹äºéœ€è¦æ›´é•¿æ—¶é—´å†å²è®°å½•çš„åœºæ™¯ï¼Œå¯ä»¥è€ƒè™‘ï¼š

- **æ•°æ®åº“æŒä¹…åŒ–**ï¼šå°†å†å²è®°å½•å­˜å‚¨åˆ°æ•°æ®åº“
- **åˆ†å±‚å­˜å‚¨**ï¼šåŒºåˆ†çŸ­æœŸæ´»è·ƒè®°å½•å’Œé•¿æœŸå½’æ¡£è®°å½•
- **å‹ç¼©ç®—æ³•**ï¼šå¯¹å†å²è®°å½•è¿›è¡Œå‹ç¼©å­˜å‚¨

**ç« èŠ‚æ¥æº**
- [order_status_handler.py](file://order_status_handler.py#L442-L445)

## é€€æ¬¾æ’¤é”€åœºæ™¯å¤„ç†

### çŠ¶æ€å›é€€æœºåˆ¶

ç³»ç»Ÿæä¾›äº†å®Œæ•´çš„é€€æ¬¾æ’¤é”€çŠ¶æ€å›é€€æœºåˆ¶ï¼š

```mermaid
sequenceDiagram
participant User as "ç”¨æˆ·"
participant System as "ç³»ç»Ÿ"
participant Handler as "çŠ¶æ€å¤„ç†å™¨"
participant History as "çŠ¶æ€å†å²"
User->>System : æ’¤é”€é€€æ¬¾ç”³è¯·
System->>Handler : æ¥æ”¶refund_cancelledçŠ¶æ€
Handler->>History : æŸ¥è¯¢ä¸Šä¸€æ¬¡çŠ¶æ€
History-->>Handler : è¿”å›ä¸Šä¸€æ¬¡çŠ¶æ€
Handler->>Handler : ç¡®è®¤çŠ¶æ€æœ‰æ•ˆæ€§
Handler->>System : å›é€€åˆ°ä¸Šä¸€æ¬¡çŠ¶æ€
System-->>User : çŠ¶æ€æ›´æ–°æˆåŠŸ
```

**å›¾è¡¨æ¥æº**
- [order_status_handler.py](file://order_status_handler.py#L260-L269)

### å›é€€é€»è¾‘å®ç°

```python
# å¤„ç†é€€æ¬¾æ’¤é”€çš„ç‰¹æ®Šé€»è¾‘
if new_status == 'refund_cancelled':
    # ä»å†å²è®°å½•ä¸­è·å–ä¸Šä¸€æ¬¡çŠ¶æ€
    previous_status = self._get_previous_status(order_id)
    if previous_status:
        logger.info(f"ğŸ”„ é€€æ¬¾æ’¤é”€ï¼Œå›é€€åˆ°ä¸Šä¸€æ¬¡çŠ¶æ€: {previous_status}")
        new_status = previous_status
    else:
        logger.warning(f"âš ï¸ é€€æ¬¾æ’¤é”€ä½†æ— æ³•è·å–ä¸Šä¸€æ¬¡çŠ¶æ€ï¼Œä¿æŒå½“å‰çŠ¶æ€: {current_status}")
        new_status = current_status
```

### å¼‚å¸¸å¤„ç†ç­–ç•¥

1. **çŠ¶æ€ç¼ºå¤±å¤„ç†**ï¼šå½“å†å²è®°å½•ä¸ºç©ºæ—¶ä¿æŒå½“å‰çŠ¶æ€
2. **çŠ¶æ€éªŒè¯**ï¼šç¡®ä¿å›é€€çŠ¶æ€çš„æœ‰æ•ˆæ€§
3. **æ—¥å¿—è®°å½•**ï¼šè¯¦ç»†è®°å½•å›é€€è¿‡ç¨‹å’Œç»“æœ
4. **ç”¨æˆ·é€šçŸ¥**ï¼šå‘ç”¨æˆ·åé¦ˆçŠ¶æ€å›é€€çš„ç»“æœ

### ä¸šåŠ¡è§„åˆ™çº¦æŸ

- **ä¸å¯é€†çŠ¶æ€**ï¼šå·²å®Œæˆçš„è®¢å•ä¸èƒ½å›é€€åˆ°å¤„ç†ä¸­
- **çŠ¶æ€ä¼˜å…ˆçº§**ï¼šæ ¹æ®ä¸šåŠ¡è§„åˆ™ç¡®å®šåˆæ³•çš„å›é€€è·¯å¾„
- **äº‹åŠ¡ä¸€è‡´æ€§**ï¼šç¡®ä¿çŠ¶æ€å›é€€çš„åŸå­æ€§

**ç« èŠ‚æ¥æº**
- [order_status_handler.py](file://order_status_handler.py#L260-L269)

## çŠ¶æ€å†å²è®¿é—®ä¸è°ƒè¯•

### è®¿é—®æ¥å£è®¾è®¡

ç³»ç»Ÿæä¾›äº†å¤šç§æ–¹å¼è®¿é—®çŠ¶æ€å†å²ï¼š

```python
# ç›´æ¥è®¿é—®å†å²è®°å½•
def get_order_status_history(self, order_id: str) -> List[Dict]:
    """è·å–è®¢å•çŠ¶æ€å†å²"""
    with self._lock:
        return self._order_status_history.get(order_id, [])

# è·å–ç‰¹å®šçŠ¶æ€çš„å†å²è®°å½•
def get_status_change_events(self, order_id: str, target_status: str) -> List[Dict]:
    """è·å–ç‰¹å®šçŠ¶æ€å˜æ›´äº‹ä»¶"""
    with self._lock:
        history = self._order_status_history.get(order_id, [])
        return [event for event in history if event['to_status'] == target_status]
```

### è°ƒè¯•å·¥å…·

1. **çŠ¶æ€å¿«ç…§**ï¼šå®šæœŸå¯¼å‡ºçŠ¶æ€å†å²ç”¨äºåˆ†æ
2. **å®æ—¶ç›‘æ§**ï¼šç›‘æ§çŠ¶æ€å˜æ›´é¢‘ç‡å’Œæ¨¡å¼
3. **å¼‚å¸¸æ£€æµ‹**ï¼šè¯†åˆ«å¼‚å¸¸çš„çŠ¶æ€å˜æ›´æ¨¡å¼
4. **æ€§èƒ½åˆ†æ**ï¼šåˆ†æçŠ¶æ€å˜æ›´çš„æ€§èƒ½ç‰¹å¾

### æ—¥å¿—é›†æˆ

```python
# è¯¦ç»†çš„è°ƒè¯•æ—¥å¿—
logger.debug(f"ğŸ“ è®°å½•è®¢å•çŠ¶æ€å†å²: {order_id} {from_status} -> {to_status}")
logger.info(f"ğŸ“Š è®¢å• {order_id} çŠ¶æ€å†å²ç»Ÿè®¡: {len(history)} æ¡è®°å½•")
```

### åˆ†ææŒ‡æ ‡

- **çŠ¶æ€å˜æ›´é¢‘ç‡**ï¼šå•ä½æ—¶é—´å†…çŠ¶æ€å˜æ›´æ¬¡æ•°
- **å¹³å‡åœç•™æ—¶é—´**ï¼šå„çŠ¶æ€çš„å¹³å‡åœç•™æ—¶é•¿
- **çŠ¶æ€è½¬æ¢æ¦‚ç‡**ï¼šä¸åŒçŠ¶æ€é—´çš„è½¬æ¢æ¦‚ç‡
- **å¼‚å¸¸çŠ¶æ€è¯†åˆ«**ï¼šè¯†åˆ«å¼‚å¸¸çš„çŠ¶æ€å˜æ›´æ¨¡å¼

**ç« èŠ‚æ¥æº**
- [order_status_handler.py](file://order_status_handler.py#L418-L447)

## æ•°æ®åº“æŒä¹…åŒ–æ–¹æ¡ˆ

### æŒä¹…åŒ–æ¶æ„

è™½ç„¶å½“å‰ç³»ç»Ÿä¸»è¦ä½¿ç”¨å†…å­˜å­˜å‚¨çŠ¶æ€å†å²ï¼Œä½†å¯ä»¥é€šè¿‡æ•°æ®åº“å®ç°æŒä¹…åŒ–ï¼š

```mermaid
erDiagram
ORDER_STATUS_HISTORY {
uuid id PK
string order_id FK
string from_status
string to_status
string context
timestamp timestamp
timestamp created_at
}
ORDERS {
string order_id PK
string order_status
timestamp created_at
timestamp updated_at
}
ORDER_STATUS_HISTORY ||--|| ORDERS : "belongs to"
```

**å›¾è¡¨æ¥æº**
- [db_manager.py](file://db_manager.py#L220-L234)

### æŒä¹…åŒ–å®ç°æ–¹æ¡ˆ

#### æ–¹æ¡ˆä¸€ï¼šç‹¬ç«‹å†å²è¡¨
```sql
CREATE TABLE order_status_history (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    order_id TEXT NOT NULL,
    from_status TEXT NOT NULL,
    to_status TEXT NOT NULL,
    context TEXT,
    timestamp DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (order_id) REFERENCES orders(order_id)
);
```

#### æ–¹æ¡ˆäºŒï¼šäº‹ä»¶æº¯æº
å°†çŠ¶æ€å˜æ›´ä½œä¸ºäº‹ä»¶å­˜å‚¨ï¼Œæ”¯æŒå®Œæ•´çš„çŠ¶æ€é‡å»ºã€‚

#### æ–¹æ¡ˆä¸‰ï¼šæ··åˆå­˜å‚¨
- å†…å­˜ï¼šæœ€è¿‘10æ¡è®°å½•ï¼Œç”¨äºå®æ—¶çŠ¶æ€ç®¡ç†
- æ•°æ®åº“ï¼šå®Œæ•´å†å²è®°å½•ï¼Œç”¨äºå®¡è®¡å’Œåˆ†æ

### æ•°æ®è¿ç§»ç­–ç•¥

```python
def migrate_memory_to_database(self):
    """å°†å†…å­˜ä¸­çš„çŠ¶æ€å†å²è¿ç§»åˆ°æ•°æ®åº“"""
    with self._lock:
        for order_id, history in self._order_status_history.items():
            for entry in history:
                db_manager.insert_status_history({
                    'order_id': order_id,
                    'from_status': entry['from_status'],
                    'to_status': entry['to_status'],
                    'context': entry['context'],
                    'timestamp': entry['timestamp']
                })
```

### æ¸…ç†ç­–ç•¥

```python
def cleanup_old_history(days: int = 90):
    """æ¸…ç†è¿‡æœŸçš„çŠ¶æ€å†å²è®°å½•"""
    return db_manager.cleanup_old_data(table='order_status_history', days=days)
```

**ç« èŠ‚æ¥æº**
- [db_manager.py](file://db_manager.py#L5071-L5102)
- [XianyuAutoAsync.py](file://XianyuAutoAsync.py#L5358-L5371)

## æœ€ä½³å®è·µæŒ‡å¯¼

### å¼€å‘è€…ä½¿ç”¨æŒ‡å—

#### 1. çŠ¶æ€å†å²æŸ¥è¯¢

```python
# è·å–è®¢å•çš„å®Œæ•´çŠ¶æ€å†å²
history = status_handler.get_order_status_history(order_id)

# è·å–ç‰¹å®šæ—¶é—´æ®µçš„çŠ¶æ€å˜æ›´
recent_history = [entry for entry in history 
                 if entry['timestamp'] > cutoff_timestamp]

# ç»Ÿè®¡çŠ¶æ€å˜æ›´é¢‘ç‡
status_counts = {}
for entry in history:
    status_counts[entry['to_status']] = status_counts.get(entry['to_status'], 0) + 1
```

#### 2. çŠ¶æ€å¼‚å¸¸æ’æŸ¥

```python
# æ£€æŸ¥å¼‚å¸¸çš„çŠ¶æ€å˜æ›´æ¨¡å¼
def detect_anomalies(history):
    anomalies = []
    for i in range(1, len(history)):
        prev_status = history[i-1]['to_status']
        curr_status = history[i]['to_status']
        
        # æ£€æŸ¥éæ³•çŠ¶æ€è½¬æ¢
        if not is_valid_transition(prev_status, curr_status):
            anomalies.append({
                'index': i,
                'prev_status': prev_status,
                'curr_status': curr_status,
                'timestamp': history[i]['timestamp']
            })
    return anomalies
```

#### 3. çŠ¶æ€å†å²åˆ†æ

```python
# åˆ†æçŠ¶æ€åœç•™æ—¶é—´
def analyze_stay_times(history):
    stay_times = []
    for i in range(len(history) - 1):
        start_time = history[i]['timestamp']
        end_time = history[i+1]['timestamp']
        stay_times.append({
            'status': history[i]['to_status'],
            'duration': end_time - start_time
        })
    return stay_times
```

### æ‰©å±•å¼€å‘å»ºè®®

#### è‡ªå®šä¹‰å†å²è®°å½•å™¨

```python
class CustomStatusHistoryLogger:
    def __init__(self, handler: OrderStatusHandler):
        self.handler = handler
    
    def log_custom_event(self, order_id: str, status: str, custom_context: dict):
        """è®°å½•è‡ªå®šä¹‰çŠ¶æ€äº‹ä»¶"""
        context = {
            'type': 'custom',
            'details': custom_context,
            'original_context': 'è‡ªå®šä¹‰äº‹ä»¶'
        }
        self.handler._record_status_history(order_id, status, status, context)
```

#### çŠ¶æ€å†å²ç›‘æ§

```python
class StatusHistoryMonitor:
    def __init__(self, threshold: int = 5):
        self.threshold = threshold
    
    def check_frequent_changes(self, order_id: str):
        """æ£€æŸ¥è®¢å•çŠ¶æ€å˜æ›´è¿‡äºé¢‘ç¹"""
        history = self.handler.get_order_status_history(order_id)
        if len(history) > self.threshold:
            return True
        return False
```

### æ€§èƒ½ä¼˜åŒ–å»ºè®®

1. **æ‰¹é‡å¤„ç†**ï¼šå¯¹äºå¤§é‡è®¢å•çš„çŠ¶æ€æ›´æ–°ï¼Œä½¿ç”¨æ‰¹é‡å¤„ç†
2. **å¼‚æ­¥è®°å½•**ï¼šå°†çŠ¶æ€å†å²è®°å½•æ“ä½œå¼‚æ­¥åŒ–
3. **ç¼“å­˜ç­–ç•¥**ï¼šå¯¹é¢‘ç¹è®¿é—®çš„çŠ¶æ€å†å²è¿›è¡Œç¼“å­˜
4. **ç´¢å¼•ä¼˜åŒ–**ï¼šåœ¨æ•°æ®åº“ä¸­ä¸ºè®¢å•IDå’Œæ—¶é—´æˆ³å»ºç«‹ç´¢å¼•

**ç« èŠ‚æ¥æº**
- [order_status_handler.py](file://order_status_handler.py#L418-L447)

## æ•…éšœæ’é™¤æŒ‡å—

### å¸¸è§é—®é¢˜è¯Šæ–­

#### 1. çŠ¶æ€å†å²ä¸¢å¤±

**ç—‡çŠ¶**ï¼šçŠ¶æ€å†å²è®°å½•ä¸å®Œæ•´æˆ–ä¸¢å¤±

**å¯èƒ½åŸå› **ï¼š
- ç³»ç»Ÿé‡å¯å¯¼è‡´å†…å­˜æ•°æ®ä¸¢å¤±
- å¼‚å¸¸æƒ…å†µä¸‹å†å²è®°å½•æœªæ­£ç¡®ä¿å­˜
- é”ç«äº‰å¯¼è‡´éƒ¨åˆ†è®°å½•ä¸¢å¤±

**è§£å†³æ–¹æ¡ˆ**ï¼š
```python
# å¯ç”¨è°ƒè¯•æ—¥å¿—
logger.setLevel('DEBUG')

# æ£€æŸ¥å†å²è®°å½•å®Œæ•´æ€§
def check_history_integrity(order_id: str):
    history = status_handler.get_order_status_history(order_id)
    if not history:
        logger.warning(f"è®¢å• {order_id} æ— çŠ¶æ€å†å²è®°å½•")
        return False
    
    # æ£€æŸ¥æ—¶é—´æˆ³è¿ç»­æ€§
    timestamps = [entry['timestamp'] for entry in history]
    if sorted(timestamps) != timestamps:
        logger.error(f"è®¢å• {order_id} çŠ¶æ€å†å²æ—¶é—´æˆ³ä¸è¿ç»­")
        return False
    
    return True
```

#### 2. çº¿ç¨‹å®‰å…¨é—®é¢˜

**ç—‡çŠ¶**ï¼šçŠ¶æ€å†å²è®°å½•å‡ºç°ä¸ä¸€è‡´æˆ–æŸå

**è¯Šæ–­æ–¹æ³•**ï¼š
```python
# æ£€æŸ¥é”ä½¿ç”¨æƒ…å†µ
def debug_lock_usage():
    # ç›‘æ§é”çš„è·å–å’Œé‡Šæ”¾
    original_acquire = threading.RLock.acquire
    original_release = threading.RLock.release
    
    def debug_acquire(lock, blocking=True):
        print(f"è·å–é”: {lock}")
        return original_acquire(lock, blocking)
    
    def debug_release(lock):
        print(f"é‡Šæ”¾é”: {lock}")
        return original_release(lock)
    
    threading.RLock.acquire = debug_acquire
    threading.RLock.release = debug_release
```

#### 3. å†…å­˜æ³„æ¼é—®é¢˜

**ç—‡çŠ¶**ï¼šç³»ç»Ÿè¿è¡Œä¸€æ®µæ—¶é—´åå†…å­˜ä½¿ç”¨æŒç»­å¢é•¿

**è¯Šæ–­æ­¥éª¤**ï¼š
```python
# ç›‘æ§å†å²è®°å½•å†…å­˜ä½¿ç”¨
def monitor_memory_usage():
    import psutil
    import os
    
    process = psutil.Process(os.getpid())
    memory_mb = process.memory_info().rss / 1024 / 1024
    
    # æ£€æŸ¥å†å²è®°å½•å¤§å°
    total_entries = sum(len(hist) for hist in 
                       status_handler._order_status_history.values())
    
    logger.info(f"å†…å­˜ä½¿ç”¨: {memory_mb:.2f}MB, "
               f"å†å²è®°å½•æ¡ç›®: {total_entries}")
```

### æ€§èƒ½é—®é¢˜è§£å†³

#### 1. çŠ¶æ€æ›´æ–°ç¼“æ…¢

**ä¼˜åŒ–æªæ–½**ï¼š
- å‡å°‘ä¸å¿…è¦çš„çŠ¶æ€å˜æ›´
- ä½¿ç”¨æ‰¹é‡æ›´æ–°æœºåˆ¶
- ä¼˜åŒ–çŠ¶æ€éªŒè¯é€»è¾‘

#### 2. å†…å­˜ä½¿ç”¨è¿‡é«˜

**è§£å†³æ–¹æ¡ˆ**ï¼š
```python
# å®šæœŸæ¸…ç†è¿‡æœŸçš„å†å²è®°å½•
def periodic_cleanup():
    while True:
        time.sleep(3600)  # æ¯å°æ—¶æ¸…ç†ä¸€æ¬¡
        with status_handler._lock:
            # æ¸…ç†è¶…è¿‡ä¸€å®šå¹´é¾„çš„å†å²è®°å½•
            for order_id, history in list(status_handler._order_status_history.items()):
                if len(history) > 10:
                    status_handler._order_status_history[order_id] = history[-10:]
```

### ç›‘æ§å’Œå‘Šè­¦

#### å…³é”®æŒ‡æ ‡ç›‘æ§

```python
class StatusHistoryMonitor:
    def __init__(self):
        self.alert_thresholds = {
            'max_history_entries': 1000,
            'max_memory_usage': 100 * 1024 * 1024,  # 100MB
            'min_history_entries': 1
        }
    
    def check_metrics(self):
        total_entries = sum(len(hist) for hist in 
                           status_handler._order_status_history.values())
        
        if total_entries > self.alert_thresholds['max_history_entries']:
            logger.warning(f"çŠ¶æ€å†å²æ¡ç›®è¿‡å¤š: {total_entries}")
        
        # æ£€æŸ¥å†…å­˜ä½¿ç”¨
        process = psutil.Process(os.getpid())
        memory_usage = process.memory_info().rss
        
        if memory_usage > self.alert_thresholds['max_memory_usage']:
            logger.warning(f"å†…å­˜ä½¿ç”¨è¿‡é«˜: {memory_usage / 1024 / 1024:.2f}MB")
```

### æ¢å¤ç­–ç•¥

#### 1. ç³»ç»Ÿé‡å¯åçš„æ¢å¤

```python
def recover_from_restart():
    """ä»ç³»ç»Ÿé‡å¯ä¸­æ¢å¤çŠ¶æ€å†å²"""
    # é‡æ–°åŠ è½½æŒä¹…åŒ–çš„çŠ¶æ€å†å²
    persisted_history = db_manager.load_persisted_status_history()
    
    with status_handler._lock:
        # åˆå¹¶ç°æœ‰çš„å†…å­˜å†å²å’ŒæŒä¹…åŒ–å†å²
        for order_id, history in persisted_history.items():
            if order_id not in status_handler._order_status_history:
                status_handler._order_status_history[order_id] = []
            
            # è¿‡æ»¤æ‰å·²ç»å­˜åœ¨äºå†…å­˜ä¸­çš„è®°å½•
            memory_set = set((entry['from_status'], entry['to_status']) 
                           for entry in status_handler._order_status_history[order_id])
            
            for entry in history:
                if (entry['from_status'], entry['to_status']) not in memory_set:
                    status_handler._order_status_history[order_id].append(entry)
```

#### 2. æ•°æ®æŸåä¿®å¤

```python
def repair_corrupted_history(order_id: str):
    """ä¿®å¤æŸåçš„çŠ¶æ€å†å²"""
    with status_handler._lock:
        history = status_handler._order_status_history.get(order_id, [])
        
        # ä¿®å¤æ—¶é—´æˆ³
        for i in range(1, len(history)):
            if history[i]['timestamp'] <= history[i-1]['timestamp']:
                history[i]['timestamp'] = history[i-1]['timestamp'] + 0.001
        
        # ä¿®å¤çŠ¶æ€é“¾
        for i in range(1, len(history)):
            if history[i]['from_status'] != history[i-1]['to_status']:
                history[i]['from_status'] = history[i-1]['to_status']
        
        status_handler._order_status_history[order_id] = history
```

**ç« èŠ‚æ¥æº**
- [order_status_handler.py](file://order_status_handler.py#L418-L447)

## ç»“è®º

è®¢å•çŠ¶æ€å†å²ç®¡ç†ç³»ç»Ÿæ˜¯Xianyu Auto Replyé¡¹ç›®ä¸­çš„é‡è¦åŸºç¡€è®¾æ–½ï¼Œé€šè¿‡`_order_status_history`å­—å…¸å®ç°äº†é«˜æ•ˆã€å®‰å…¨çš„çŠ¶æ€å˜æ›´è¿½è¸ªã€‚è¯¥ç³»ç»Ÿå…·æœ‰ä»¥ä¸‹æ ¸å¿ƒä¼˜åŠ¿ï¼š

1. **å¯é æ€§**ï¼šé€šè¿‡é”æœºåˆ¶ç¡®ä¿çº¿ç¨‹å®‰å…¨ï¼Œé¿å…æ•°æ®ç«äº‰
2. **çµæ´»æ€§**ï¼šæ”¯æŒé€€æ¬¾æ’¤é”€ç­‰å¤æ‚ä¸šåŠ¡åœºæ™¯
3. **å¯æ‰©å±•æ€§**ï¼šæä¾›å¤šç§æ‰©å±•ç‚¹å’ŒæŒä¹…åŒ–æ–¹æ¡ˆ
4. **å¯è§‚æµ‹æ€§**ï¼šå®Œå–„çš„æ—¥å¿—è®°å½•å’Œè°ƒè¯•æ”¯æŒ

å¯¹äºå¼€å‘è€…è€Œè¨€ï¼Œç†è§£è¿™å¥—çŠ¶æ€å†å²ç®¡ç†æœºåˆ¶ä¸ä»…æœ‰åŠ©äºæ›´å¥½åœ°ä½¿ç”¨ç°æœ‰åŠŸèƒ½ï¼Œä¹Ÿä¸ºç³»ç»Ÿçš„ç»´æŠ¤å’Œæ‰©å±•æä¾›äº†åšå®çš„åŸºç¡€ã€‚éšç€ä¸šåŠ¡çš„å‘å±•ï¼Œå¯ä»¥è€ƒè™‘å¼•å…¥æ•°æ®åº“æŒä¹…åŒ–ã€åˆ†å¸ƒå¼å­˜å‚¨ç­‰é«˜çº§ç‰¹æ€§ï¼Œè¿›ä¸€æ­¥æå‡ç³»ç»Ÿçš„å¯é æ€§å’Œæ€§èƒ½ã€‚