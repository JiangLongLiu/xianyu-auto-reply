# çº¢è‰²æé†’å¤„ç†æµç¨‹è¯¦ç»†è¯´æ˜

<cite>
**æœ¬æ–‡æ¡£å¼•ç”¨çš„æ–‡ä»¶**
- [order_status_handler.py](file://order_status_handler.py)
- [XianyuAutoAsync.py](file://XianyuAutoAsync.py)
- [db_manager.py](file://db_manager.py)
</cite>

## ç›®å½•
1. [æ¦‚è¿°](#æ¦‚è¿°)
2. [ç³»ç»Ÿæ¶æ„](#ç³»ç»Ÿæ¶æ„)
3. [æ ¸å¿ƒç»„ä»¶åˆ†æ](#æ ¸å¿ƒç»„ä»¶åˆ†æ)
4. [handle_red_reminder_messageæ–¹æ³•è¯¦è§£](#handle_red_reminder_messageæ–¹æ³•è¯¦è§£)
5. [è®¢å•IDæå–æœºåˆ¶](#è®¢å•idæå–æœºåˆ¶)
6. [å¾…å¤„ç†é˜Ÿåˆ—å¤„ç†](#å¾…å¤„ç†é˜Ÿåˆ—å¤„ç†)
7. [ç³»ç»Ÿæ¶ˆæ¯å¤„ç†å¯¹æ¯”](#ç³»ç»Ÿæ¶ˆæ¯å¤„ç†å¯¹æ¯”)
8. [æ€§èƒ½ä¼˜åŒ–ç­–ç•¥](#æ€§èƒ½ä¼˜åŒ–ç­–ç•¥)
9. [æ‰©å±•å»ºè®®](#æ‰©å±•å»ºè®®)
10. [æ•…éšœæ’é™¤æŒ‡å—](#æ•…éšœæ’é™¤æŒ‡å—)

## æ¦‚è¿°

çº¢è‰²æé†’æ¶ˆæ¯å¤„ç†æ˜¯é—²é±¼è‡ªåŠ¨å›å¤ç³»ç»Ÿä¸­çš„å…³é”®åŠŸèƒ½æ¨¡å—ï¼Œä¸“é—¨è´Ÿè´£è¯†åˆ«å’Œå¤„ç†"äº¤æ˜“å…³é—­"è¿™ä¸€ç‰¹å®šç±»å‹çš„çº¢è‰²æé†’æ¶ˆæ¯ã€‚è¯¥ç³»ç»Ÿé‡‡ç”¨åŒé‡å¤„ç†ç­–ç•¥ï¼šç›´æ¥å¤„ç†å’Œå»¶è¿Ÿå¤„ç†ï¼Œç¡®ä¿è®¢å•çŠ¶æ€æ›´æ–°çš„æœ€ç»ˆä¸€è‡´æ€§ã€‚

### ä¸»è¦ç‰¹æ€§

- **æ™ºèƒ½è¯†åˆ«**ï¼šä»…å¤„ç†"äº¤æ˜“å…³é—­"ç±»å‹çš„çº¢è‰²æé†’
- **çµæ´»æå–**ï¼šæ”¯æŒå¤šç§è®¢å•IDæå–æ–¹å¼
- **å»¶è¿Ÿå¤„ç†**ï¼šé€šè¿‡å¾…å¤„ç†é˜Ÿåˆ—ä¿è¯çŠ¶æ€æ›´æ–°çš„å¯é æ€§
- **æœ€ç»ˆä¸€è‡´æ€§**ï¼šç¡®ä¿å³ä½¿æ¶ˆæ¯ä¸¢å¤±ä¹Ÿèƒ½æ¢å¤çŠ¶æ€æ›´æ–°
- **é«˜æ€§èƒ½**ï¼šé‡‡ç”¨å¼‚æ­¥å¤„ç†å’Œé˜Ÿåˆ—ç®¡ç†æœºåˆ¶

## ç³»ç»Ÿæ¶æ„

```mermaid
graph TB
subgraph "æ¶ˆæ¯æ¥æ”¶å±‚"
WS[WebSocketè¿æ¥]
MSG[åŸå§‹æ¶ˆæ¯]
end
subgraph "æ¶ˆæ¯åˆ†ç±»å¤„ç†"
SYS_MSG[ç³»ç»Ÿæ¶ˆæ¯å¤„ç†]
RED_MSG[çº¢è‰²æé†’æ¶ˆæ¯å¤„ç†]
end
subgraph "è®¢å•çŠ¶æ€å¤„ç†å™¨"
OSH[OrderStatusHandler]
EXTRACT[extract_order_id]
UPDATE[update_order_status]
end
subgraph "é˜Ÿåˆ—ç®¡ç†ç³»ç»Ÿ"
PENDING_SYS[å¾…å¤„ç†ç³»ç»Ÿæ¶ˆæ¯é˜Ÿåˆ—]
PENDING_RED[å¾…å¤„ç†çº¢è‰²æé†’é˜Ÿåˆ—]
PENDING_UPDATES[å¾…å¤„ç†æ›´æ–°é˜Ÿåˆ—]
end
subgraph "æ•°æ®åº“å±‚"
DB[(SQLiteæ•°æ®åº“)]
end
WS --> MSG
MSG --> SYS_MSG
MSG --> RED_MSG
SYS_MSG --> OSH
RED_MSG --> OSH
OSH --> EXTRACT
OSH --> UPDATE
OSH --> PENDING_SYS
OSH --> PENDING_RED
OSH --> PENDING_UPDATES
UPDATE --> DB
```

**å›¾è¡¨æ¥æº**
- [order_status_handler.py](file://order_status_handler.py#L60-L66)
- [XianyuAutoAsync.py](file://XianyuAutoAsync.py#L7456-L7493)

## æ ¸å¿ƒç»„ä»¶åˆ†æ

### OrderStatusHandlerç±»

OrderStatusHandleræ˜¯è®¢å•çŠ¶æ€å¤„ç†çš„æ ¸å¿ƒç±»ï¼Œè´Ÿè´£åè°ƒå„ç§æ¶ˆæ¯ç±»å‹çš„å¤„ç†æµç¨‹ã€‚

```mermaid
classDiagram
class OrderStatusHandler {
+dict config
+dict status_mapping
+dict pending_updates
+dict _pending_system_messages
+dict _pending_red_reminder_messages
+dict _order_status_history
+RLock _lock
+handle_red_reminder_message(message, red_reminder, user_id, cookie_id, msg_time) bool
+extract_order_id(message) Optional~str~
+update_order_status(order_id, new_status, cookie_id, context) bool
+on_order_id_extracted(order_id, cookie_id, message) void
+clear_old_pending_updates(max_age_hours) void
-_add_to_pending_updates(order_id, new_status, cookie_id, context) void
-_record_status_history(order_id, from_status, to_status, context) void
}
class DBManager {
+get_order_by_id(order_id) dict
+insert_or_update_order(order_id, order_status, cookie_id) bool
}
OrderStatusHandler --> DBManager : "ä½¿ç”¨"
```

**å›¾è¡¨æ¥æº**
- [order_status_handler.py](file://order_status_handler.py#L26-L1074)

**ç« èŠ‚æ¥æº**
- [order_status_handler.py](file://order_status_handler.py#L26-L1074)

### é˜Ÿåˆ—ç®¡ç†ç»“æ„

ç³»ç»Ÿç»´æŠ¤ä¸‰ä¸ªä¸»è¦é˜Ÿåˆ—æ¥å¤„ç†ä¸åŒç±»å‹çš„æ¶ˆæ¯ï¼š

| é˜Ÿåˆ—åç§° | ç±»å‹ | ç”¨é€” | æ¸…ç†ç­–ç•¥ |
|---------|------|------|----------|
| pending_updates | `{order_id: [update_info, ...]}` | å­˜å‚¨å¾…å¤„ç†çš„è®¢å•çŠ¶æ€æ›´æ–° | æŒ‰è®¢å•IDåˆ†ç»„ï¼Œæ”¯æŒæ‰¹é‡å¤„ç† |
| _pending_system_messages | `{cookie_id: [message_info, ...]}` | å­˜å‚¨å¾…å¤„ç†çš„ç³»ç»Ÿæ¶ˆæ¯ | æŒ‰è´¦å·åˆ†ç»„ï¼Œæ”¯æŒæ¶ˆæ¯åŒ¹é… |
| _pending_red_reminder_messages | `{cookie_id: [message_info, ...]}` | å­˜å‚¨å¾…å¤„ç†çš„çº¢è‰²æé†’æ¶ˆæ¯ | æŒ‰è´¦å·åˆ†ç»„ï¼Œæ”¯æŒå»¶è¿Ÿå¤„ç† |

**ç« èŠ‚æ¥æº**
- [order_status_handler.py](file://order_status_handler.py#L60-L66)

## handle_red_reminder_messageæ–¹æ³•è¯¦è§£

### æ–¹æ³•ç­¾åä¸èŒè´£

`handle_red_reminder_message`æ–¹æ³•æ˜¯çº¢è‰²æé†’å¤„ç†çš„æ ¸å¿ƒå…¥å£ï¼Œä¸“é—¨å¤„ç†"äº¤æ˜“å…³é—­"ç±»å‹çš„çº¢è‰²æé†’æ¶ˆæ¯ã€‚

### å¤„ç†æµç¨‹å›¾

```mermaid
flowchart TD
START([å¼€å§‹å¤„ç†çº¢è‰²æé†’]) --> CHECK_REMINDER{æ£€æŸ¥æé†’ç±»å‹}
CHECK_REMINDER --> |ä¸æ˜¯äº¤æ˜“å…³é—­| RETURN_FALSE[è¿”å›False]
CHECK_REMINDER --> |æ˜¯äº¤æ˜“å…³é—­| EXTRACT_ID[æå–è®¢å•ID]
EXTRACT_ID --> ID_FOUND{IDæ˜¯å¦æå–æˆåŠŸ?}
ID_FOUND --> |æˆåŠŸ| UPDATE_STATUS[æ›´æ–°è®¢å•çŠ¶æ€ä¸ºå·²å…³é—­]
ID_FOUND --> |å¤±è´¥| CHECK_QUEUE{æ£€æŸ¥æ˜¯å¦å¯ç”¨å¾…å¤„ç†é˜Ÿåˆ—}
CHECK_QUEUE --> |å¯ç”¨| ADD_PENDING[æ·»åŠ åˆ°å¾…å¤„ç†é˜Ÿåˆ—]
CHECK_QUEUE --> |ç¦ç”¨| LOG_ERROR[è®°å½•é”™è¯¯æ—¥å¿—]
ADD_PENDING --> CREATE_TEMP[åˆ›å»ºä¸´æ—¶è®¢å•ID]
CREATE_TEMP --> ADD_TO_QUEUE[æ·»åŠ åˆ°çº¢è‰²æé†’é˜Ÿåˆ—]
ADD_TO_QUEUE --> RETURN_TRUE[è¿”å›True]
UPDATE_STATUS --> SUCCESS{æ›´æ–°æ˜¯å¦æˆåŠŸ?}
SUCCESS --> |æˆåŠŸ| LOG_SUCCESS[è®°å½•æˆåŠŸæ—¥å¿—]
SUCCESS --> |å¤±è´¥| LOG_ERROR2[è®°å½•é”™è¯¯æ—¥å¿—]
LOG_SUCCESS --> RETURN_TRUE
LOG_ERROR2 --> RETURN_TRUE
LOG_ERROR --> RETURN_FALSE
```

**å›¾è¡¨æ¥æº**
- [order_status_handler.py](file://order_status_handler.py#L760-L833)

### å…³é”®å¤„ç†æ­¥éª¤

#### 1. æé†’ç±»å‹è¿‡æ»¤
```python
# åªå¤„ç†äº¤æ˜“å…³é—­çš„æƒ…å†µ
if red_reminder != 'äº¤æ˜“å…³é—­':
    return False
```

#### 2. è®¢å•IDæå–
ç³»ç»Ÿé‡‡ç”¨å¤šå±‚æå–ç­–ç•¥ï¼Œä¼˜å…ˆä»æ¶ˆæ¯ç»“æ„ä¸­æå–è®¢å•IDï¼š

```python
# æå–è®¢å•ID
order_id = self.extract_order_id(message)
```

#### 3. IDç¼ºå¤±å¤„ç†
å½“æ— æ³•æå–è®¢å•IDæ—¶ï¼Œç³»ç»Ÿæ ¹æ®é…ç½®å†³å®šå¤„ç†ç­–ç•¥ï¼š

```python
if not order_id:
    if self.config.get('use_pending_queue', True):
        logger.info(f'[{msg_time}] ã€{cookie_id}ã€‘äº¤æ˜“å…³é—­ï¼Œæš‚æ—¶æ— æ³•æå–è®¢å•IDï¼Œæ·»åŠ åˆ°å¾…å¤„ç†é˜Ÿåˆ—')
    else:
        logger.error(f'[{msg_time}] ã€{cookie_id}ã€‘äº¤æ˜“å…³é—­ï¼Œæ— æ³•æå–è®¢å•IDä¸”æœªå¯ç”¨å¾…å¤„ç†é˜Ÿåˆ—ï¼Œè·³è¿‡å¤„ç†')
    return False
```

#### 4. çŠ¶æ€æ›´æ–°
æˆåŠŸæå–è®¢å•IDåï¼Œç³»ç»Ÿæ‰§è¡ŒçŠ¶æ€æ›´æ–°ï¼š

```python
success = self.update_order_status(
    order_id=order_id,
    new_status='cancelled',
    cookie_id=cookie_id,
    context=f"äº¤æ˜“å…³é—­ - ç”¨æˆ·{user_id} - {msg_time}"
)
```

**ç« èŠ‚æ¥æº**
- [order_status_handler.py](file://order_status_handler.py#L760-L833)

## è®¢å•IDæå–æœºåˆ¶

### extract_order_idæ–¹æ³•è¯¦è§£

extract_order_idæ–¹æ³•å®ç°äº†å¤æ‚çš„è®¢å•IDæå–é€»è¾‘ï¼Œæ”¯æŒå¤šç§æå–æ–¹å¼ï¼š

```mermaid
flowchart TD
START_EXTRACT([å¼€å§‹æå–è®¢å•ID]) --> LOG_MESSAGE[è®°å½•å®Œæ•´æ¶ˆæ¯ç»“æ„]
LOG_MESSAGE --> CHECK_TYPE{æ£€æŸ¥message['1']ç±»å‹}
CHECK_TYPE --> |å­—å…¸| CHECK_1_6{æ£€æŸ¥message['1']['6']}
CHECK_TYPE --> |åˆ—è¡¨| SKIP_LIST[è·³è¿‡åˆ—è¡¨ç±»å‹]
CHECK_TYPE --> |å­—ç¬¦ä¸²| SKIP_STRING[è·³è¿‡å­—ç¬¦ä¸²ç±»å‹]
CHECK_TYPE --> |å…¶ä»–| SKIP_OTHER[è·³è¿‡å…¶ä»–ç±»å‹]
CHECK_1_6 --> |å­—å…¸| PARSE_JSON[è§£æJSONå†…å®¹]
CHECK_1_6 --> |éå­—å…¸| LOG_TYPE[è®°å½•ç±»å‹ä¿¡æ¯]
PARSE_JSON --> METHOD1[æ–¹æ³•1: ä»button URLæå–]
METHOD1 --> METHOD1A[ä»targetUrlæå–orderId]
METHOD1 --> METHOD1B[ä»main targetUrlæå–]
METHOD1A --> CHECK_METHOD1{æ–¹æ³•1æ˜¯å¦æˆåŠŸ?}
METHOD1B --> CHECK_METHOD1
CHECK_METHOD1 --> |æˆåŠŸ| RETURN_ID[è¿”å›è®¢å•ID]
CHECK_METHOD1 --> |å¤±è´¥| METHOD2[æ–¹æ³•2: ä»dynamicOperationæå–]
METHOD2 --> METHOD2A[ä»order_detail URLæå–]
METHOD2A --> CHECK_METHOD2{æ–¹æ³•2æ˜¯å¦æˆåŠŸ?}
CHECK_METHOD2 --> |æˆåŠŸ| RETURN_ID
CHECK_METHOD2 --> |å¤±è´¥| METHOD3[æ–¹æ³•3: æ­£åˆ™è¡¨è¾¾å¼æœç´¢]
METHOD3 --> SEARCH_PATTERNS[æœç´¢å„ç§è®¢å•IDæ¨¡å¼]
SEARCH_PATTERNS --> CHECK_METHOD3{æ–¹æ³•3æ˜¯å¦æˆåŠŸ?}
CHECK_METHOD3 --> |æˆåŠŸ| RETURN_ID
CHECK_METHOD3 --> |å¤±è´¥| LOG_FAIL[è®°å½•æå–å¤±è´¥]
SKIP_LIST --> LOG_FAIL
SKIP_STRING --> LOG_FAIL
SKIP_OTHER --> LOG_FAIL
LOG_FAIL --> RETURN_NONE[è¿”å›None]
```

**å›¾è¡¨æ¥æº**
- [order_status_handler.py](file://order_status_handler.py#L80-L189)

### æå–ç­–ç•¥è¯¦è§£

#### æ–¹æ³•1: ä»Button URLæå–
```python
# ä»buttonçš„targetUrlä¸­æå–orderId
target_url = content_data.get('dxCard', {}).get('item', {}).get('main', {}).get('exContent', {}).get('button', {}).get('targetUrl', '')
if target_url:
    order_match = re.search(r'orderId=(\d+)', target_url)
    if order_match:
        order_id = order_match.group(1)
```

#### æ–¹æ³•2: ä»Dynamic Operationæå–
```python
# ä»dynamicOperationä¸­çš„order_detail URLæå–
dynamic_target_url = content_data.get('dynamicOperation', {}).get('changeContent', {}).get('dxCard', {}).get('item', {}).get('main', {}).get('exContent', {}).get('button', {}).get('targetUrl', '')
if dynamic_target_url:
    order_match = re.search(r'order_detail\?id=(\d+)', dynamic_target_url)
    if order_match:
        order_id = order_match.group(1)
```

#### æ–¹æ³•3: æ­£åˆ™è¡¨è¾¾å¼æœç´¢
```python
patterns = [
    r'orderId[=:](\d{10,})',  # orderId=123456789
    r'order_detail\?id=(\d{10,})',  # order_detail?id=123456789
    r'"id"\s*:\s*"?(\d{10,})"?',  # "id":"123456789"
    r'bizOrderId[=:](\d{10,})',  # bizOrderId=123456789
]
```

**ç« èŠ‚æ¥æº**
- [order_status_handler.py](file://order_status_handler.py#L80-L189)

## å¾…å¤„ç†é˜Ÿåˆ—å¤„ç†

### å»¶è¿Ÿå¤„ç†æœºåˆ¶

å½“è®¢å•IDæ— æ³•ç«‹å³æå–æ—¶ï¼Œç³»ç»Ÿä¼šå°†æ¶ˆæ¯æ·»åŠ åˆ°å¾…å¤„ç†é˜Ÿåˆ—ï¼Œç­‰å¾…åç»­å¤„ç†ï¼š

```mermaid
sequenceDiagram
participant MSG as åŸå§‹æ¶ˆæ¯
participant HANDLER as OrderStatusHandler
participant QUEUE as å¾…å¤„ç†é˜Ÿåˆ—
participant PROC as å¤„ç†å™¨
participant DB as æ•°æ®åº“
MSG->>HANDLER : handle_red_reminder_message()
HANDLER->>HANDLER : extract_order_id()
HANDLER->>QUEUE : æ·»åŠ åˆ°_pending_red_reminder_messages
QUEUE->>PROC : on_order_id_extracted()
PROC->>DB : æŸ¥è¯¢è®¢å•è¯¦æƒ…
DB-->>PROC : è¿”å›è®¢å•ä¿¡æ¯
PROC->>HANDLER : update_order_status()
HANDLER->>DB : æ›´æ–°è®¢å•çŠ¶æ€
DB-->>HANDLER : ç¡®è®¤æ›´æ–°
HANDLER-->>PROC : è¿”å›å¤„ç†ç»“æœ
```

**å›¾è¡¨æ¥æº**
- [order_status_handler.py](file://order_status_handler.py#L950-L1070)

### é˜Ÿåˆ—æ¸…ç†ç­–ç•¥

ç³»ç»Ÿå®ç°äº†æ™ºèƒ½çš„é˜Ÿåˆ—æ¸…ç†æœºåˆ¶ï¼š

```python
def clear_old_pending_updates(self, max_age_hours: int = None):
    """æ¸…ç†è¿‡æœŸçš„å¾…å¤„ç†æ›´æ–°"""
    if max_age_hours is None:
        max_age_hours = self.config.get('max_pending_age_hours', 24)
    
    current_time = time.time()
    max_age_seconds = max_age_hours * 3600
    
    # æ¸…ç†è¿‡æœŸçš„å¾…å¤„ç†æ›´æ–°
    expired_orders = []
    for order_id, updates in self.pending_updates.items():
        valid_updates = [
            update for update in updates 
            if current_time - update['timestamp'] < max_age_seconds
        ]
        if not valid_updates:
            expired_orders.append(order_id)
        else:
            self.pending_updates[order_id] = valid_updates
```

**ç« èŠ‚æ¥æº**
- [order_status_handler.py](file://order_status_handler.py#L555-L631)

## ç³»ç»Ÿæ¶ˆæ¯å¤„ç†å¯¹æ¯”

### å¤„ç†æµç¨‹å·®å¼‚

| ç‰¹æ€§ | ç³»ç»Ÿæ¶ˆæ¯å¤„ç† | çº¢è‰²æé†’å¤„ç† |
|------|-------------|-------------|
| æ¶ˆæ¯ç±»å‹ | `[ä¹°å®¶ç¡®è®¤æ”¶è´§]`, `[ä½ å·²å‘è´§]`ç­‰ | `äº¤æ˜“å…³é—­` |
| è®¢å•IDæå–æ—¶æœº | æ¶ˆæ¯åˆ°è¾¾æ—¶ | æ¶ˆæ¯åˆ°è¾¾æ—¶ |
| çŠ¶æ€æ›´æ–°ä¼˜å…ˆçº§ | é«˜ä¼˜å…ˆçº§ï¼Œç«‹å³å¤„ç† | ä½ä¼˜å…ˆçº§ï¼Œå»¶è¿Ÿå¤„ç† |
| é˜Ÿåˆ—ä½¿ç”¨ | ç³»ç»Ÿæ¶ˆæ¯é˜Ÿåˆ— | çº¢è‰²æé†’é˜Ÿåˆ— |
| åŒ¹é…ç­–ç•¥ | æ–‡æœ¬åŒ¹é… | ç±»å‹åŒ¹é… |
| é”™è¯¯å¤„ç† | ä¸¥æ ¼éªŒè¯ | å®½æ¾éªŒè¯ |

### å¤„ç†é¡ºåº

```mermaid
flowchart TD
MSG_RECEIVED[æ¶ˆæ¯åˆ°è¾¾] --> CHECK_SYSTEM{æ˜¯å¦ä¸ºç³»ç»Ÿæ¶ˆæ¯?}
CHECK_SYSTEM --> |æ˜¯| HANDLE_SYSTEM[handle_system_message]
CHECK_SYSTEM --> |å¦| CHECK_RED{æ˜¯å¦ä¸ºçº¢è‰²æé†’?}
HANDLE_SYSTEM --> EXTRACT_ID_SYS[æå–è®¢å•ID]
EXTRACT_ID_SYS --> UPDATE_SYS[ç«‹å³æ›´æ–°çŠ¶æ€]
CHECK_RED --> |æ˜¯| HANDLE_RED[handle_red_reminder_message]
CHECK_RED --> |å¦| IGNORE[å¿½ç•¥æ¶ˆæ¯]
HANDLE_RED --> EXTRACT_ID_RED[æå–è®¢å•ID]
EXTRACT_ID_RED --> UPDATE_RED{IDæ˜¯å¦æå–æˆåŠŸ?}
UPDATE_RED --> |æˆåŠŸ| IMMEDIATE_UPDATE[ç«‹å³æ›´æ–°çŠ¶æ€]
UPDATE_RED --> |å¤±è´¥| DELAYED_PROCESSING[å»¶è¿Ÿå¤„ç†]
IMMEDIATE_UPDATE --> LOG_SUCCESS[è®°å½•æˆåŠŸæ—¥å¿—]
DELAYED_PROCESSING --> ADD_TO_QUEUE[æ·»åŠ åˆ°é˜Ÿåˆ—]
ADD_TO_QUEUE --> WAIT_FOR_ID[ç­‰å¾…è®¢å•IDæå–]
```

**å›¾è¡¨æ¥æº**
- [XianyuAutoAsync.py](file://XianyuAutoAsync.py#L7456-L7493)

**ç« èŠ‚æ¥æº**
- [XianyuAutoAsync.py](file://XianyuAutoAsync.py#L7456-L7493)

## æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

### é«˜å¹¶å‘åœºæ™¯ä¼˜åŒ–

#### 1. é”æœºåˆ¶ä¼˜åŒ–
```python
# ä½¿ç”¨threading.RLockä¿æŠ¤å¹¶å‘è®¿é—®
self._lock = threading.RLock()

def update_order_status(self, order_id: str, new_status: str, cookie_id: str, context: str = "") -> bool:
    with self._lock:
        # æ‰§è¡Œæ•°æ®åº“æ“ä½œ
        pass
```

#### 2. å¼‚æ­¥å¤„ç†åˆ†ç¦»
```python
def _process_updates_outside_lock(self, order_id: str, updates: list):
    """åœ¨é”å¤–å¤„ç†æ›´æ–°ï¼Œé¿å…æ­»é”"""
    processed_count = 0
    for update_info in updates:
        # åœ¨é”å¤–æ‰§è¡Œè€—æ—¶æ“ä½œ
        success = self.update_order_status(...)
        if success:
            processed_count += 1
```

#### 3. æ‰¹é‡å¤„ç†ä¼˜åŒ–
```python
def process_all_pending_updates(self) -> int:
    """æ‰¹é‡å¤„ç†æ‰€æœ‰å¾…å¤„ç†çš„æ›´æ–°"""
    with self._lock:
        if not self.pending_updates:
            return 0
        order_ids = list(self.pending_updates.keys())
    
    processed_orders = 0
    for order_id in order_ids:
        if self.process_pending_updates(order_id):
            processed_orders += 1
    
    return processed_orders
```

### å†…å­˜ç®¡ç†ä¼˜åŒ–

#### 1. é˜Ÿåˆ—å¤§å°æ§åˆ¶
```python
# é™åˆ¶å†å²è®°å½•æ•°é‡ï¼Œåªä¿ç•™æœ€è¿‘10æ¡
if len(self._order_status_history[order_id]) > 10:
    self._order_status_history[order_id] = self._order_status_history[order_id][-10:]
```

#### 2. å®šæœŸæ¸…ç†æœºåˆ¶
```python
# å®šæœŸæ¸…ç†è¿‡æœŸçš„å¾…å¤„ç†æ›´æ–°
def clear_old_pending_updates(self, max_age_hours: int = None):
    # æ¸…ç†è¿‡æœŸé¡¹ç›®
    current_time = time.time()
    max_age_seconds = max_age_hours * 3600
    
    # æ‰¹é‡æ¸…ç†å¤šä¸ªé˜Ÿåˆ—
    expired_cookies_red = []
    for cookie_id, messages in self._pending_red_reminder_messages.items():
        valid_messages = [
            msg for msg in messages 
            if current_time - msg.get('timestamp', 0) < max_age_seconds
        ]
        if not valid_messages:
            expired_cookies_red.append(cookie_id)
    
    for cookie_id in expired_cookies_red:
        del self._pending_red_reminder_messages[cookie_id]
```

## æ‰©å±•å»ºè®®

### æ”¯æŒæ›´å¤šçº¢è‰²æé†’ç±»å‹

åŸºäºç°æœ‰çš„å¤„ç†æ¡†æ¶ï¼Œå¯ä»¥è½»æ¾æ‰©å±•æ”¯æŒå…¶ä»–ç±»å‹çš„çº¢è‰²æé†’ï¼š

```python
# æ‰©å±•æ¶ˆæ¯ç±»å‹æ˜ å°„
red_reminder_mapping = {
    'äº¤æ˜“å…³é—­': 'cancelled',
    'ç­‰å¾…ä¹°å®¶ä»˜æ¬¾': 'pending_payment',
    'ç­‰å¾…å–å®¶å‘è´§': 'pending_shipment',
    'é€€æ¬¾ç”³è¯·': 'refunding',
    'é€€æ¬¾æˆåŠŸ': 'refunded'
}

def handle_red_reminder_message(self, message: dict, red_reminder: str, user_id: str, cookie_id: str, msg_time: str) -> bool:
    # æ£€æŸ¥æ˜¯å¦æ”¯æŒçš„æé†’ç±»å‹
    if red_reminder not in red_reminder_mapping:
        logger.info(f'[{msg_time}] ã€{cookie_id}ã€‘ä¸æ”¯æŒçš„çº¢è‰²æé†’ç±»å‹: {red_reminder}')
        return False
    
    new_status = red_reminder_mapping[red_reminder]
    
    # ç»§ç»­å¤„ç†...
```

### è‡ªå®šä¹‰å¤„ç†ç­–ç•¥

```python
# é…ç½®è‡ªå®šä¹‰å¤„ç†ç­–ç•¥
CUSTOM_HANDLING_RULES = {
    'äº¤æ˜“å…³é—­': {
        'delay_processing': True,
        'retry_attempts': 3,
        'fallback_status': 'cancelled'
    },
    'é€€æ¬¾ç”³è¯·': {
        'delay_processing': False,
        'notify_admin': True,
        'audit_required': True
    }
}
```

### ç›‘æ§å’Œå‘Šè­¦

```python
def handle_red_reminder_message(self, message: dict, red_reminder: str, user_id: str, cookie_id: str, msg_time: str) -> bool:
    try:
        # æ·»åŠ ç›‘æ§æŒ‡æ ‡
        self.metrics.increment('red_reminder.processed')
        
        success = self._handle_red_reminder_internal(...)
        
        if success:
            self.metrics.increment('red_reminder.success')
        else:
            self.metrics.increment('red_reminder.failed')
            self.alert_manager.send_alert('çº¢è‰²æé†’å¤„ç†å¤±è´¥', {
                'red_reminder': red_reminder,
                'user_id': user_id,
                'cookie_id': cookie_id
            })
        
        return success
    except Exception as e:
        self.metrics.increment('red_reminder.error')
        raise
```

## æ•…éšœæ’é™¤æŒ‡å—

### å¸¸è§é—®é¢˜åŠè§£å†³æ–¹æ¡ˆ

#### 1. è®¢å•IDæå–å¤±è´¥

**ç—‡çŠ¶**: çº¢è‰²æé†’æ¶ˆæ¯è¢«è·³è¿‡ï¼Œæœªæ·»åŠ åˆ°å¾…å¤„ç†é˜Ÿåˆ—

**è¯Šæ–­æ­¥éª¤**:
```python
# å¯ç”¨è¯¦ç»†æ—¥å¿—
logger.info(f"ğŸ” å®Œæ•´æ¶ˆæ¯ç»“æ„: {message}")
logger.info(f"ğŸ” message['1'] ç»“æ„: {message.get('1', {})}")
```

**è§£å†³æ–¹æ¡ˆ**:
- æ£€æŸ¥æ¶ˆæ¯æ ¼å¼æ˜¯å¦ç¬¦åˆé¢„æœŸ
- éªŒè¯extract_order_idæ–¹æ³•çš„æ­£åˆ™è¡¨è¾¾å¼
- ç¡®è®¤æ¶ˆæ¯ä¸­çš„JSONç»“æ„

#### 2. çŠ¶æ€æ›´æ–°å¤±è´¥

**ç—‡çŠ¶**: è®¢å•çŠ¶æ€æœªæ­£ç¡®æ›´æ–°ï¼Œä½†æœªæŠ›å‡ºå¼‚å¸¸

**è¯Šæ–­æ­¥éª¤**:
```python
# æ£€æŸ¥æ•°æ®åº“è¿æ¥
from db_manager import db_manager
current_order = db_manager.get_order_by_id(order_id)
logger.info(f"ğŸ“Š å½“å‰è®¢å•çŠ¶æ€: {current_order}")

# æ£€æŸ¥çŠ¶æ€è½¬æ¢è§„åˆ™
valid_transitions = self._get_allowed_transitions(current_status)
logger.info(f"âœ… å…è®¸çš„çŠ¶æ€è½¬æ¢: {valid_transitions}")
```

**è§£å†³æ–¹æ¡ˆ**:
- éªŒè¯æ•°æ®åº“è¿æ¥å’Œæƒé™
- æ£€æŸ¥çŠ¶æ€è½¬æ¢è§„åˆ™é…ç½®
- ç¡®è®¤è®¢å•æ˜¯å¦å­˜åœ¨

#### 3. å¾…å¤„ç†é˜Ÿåˆ—ç§¯å‹

**ç—‡çŠ¶**: é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯é•¿æ—¶é—´æœªå¤„ç†

**è¯Šæ–­æ­¥éª¤**:
```python
# æ£€æŸ¥é˜Ÿåˆ—çŠ¶æ€
logger.info(f"ğŸ“Š å¾…å¤„ç†é˜Ÿåˆ—å¤§å°: {len(self._pending_red_reminder_messages)}")
logger.info(f"ğŸ“Š è¿‡æœŸæ¶ˆæ¯æ•°é‡: {sum(len(msgs) for msgs in self._pending_red_reminder_messages.values())}")
```

**è§£å†³æ–¹æ¡ˆ**:
- è°ƒæ•´é˜Ÿåˆ—æ¸…ç†é¢‘ç‡
- å¢åŠ å¤„ç†çº¿ç¨‹æ•°é‡
- ä¼˜åŒ–è®¢å•IDæå–é€»è¾‘

### æ€§èƒ½ç›‘æ§æŒ‡æ ‡

| æŒ‡æ ‡åç§° | æè¿° | æ­£å¸¸èŒƒå›´ |
|---------|------|----------|
| red_reminder.processed | å¤„ç†çš„çº¢è‰²æé†’æ•°é‡ | æ¯åˆ†é’Ÿ > 10 |
| red_reminder.success | æˆåŠŸå¤„ç†çš„æ•°é‡ | æˆåŠŸç‡ > 95% |
| red_reminder.failed | å¤„ç†å¤±è´¥çš„æ•°é‡ | å¤±è´¥ç‡ < 5% |
| pending_queue.size | å¾…å¤„ç†é˜Ÿåˆ—å¤§å° | < 1000 |
| order_id_extraction.time | è®¢å•IDæå–è€—æ—¶ | < 1ç§’ |

**ç« èŠ‚æ¥æº**
- [order_status_handler.py](file://order_status_handler.py#L760-L833)

## æ€»ç»“

çº¢è‰²æé†’å¤„ç†ç³»ç»Ÿé€šè¿‡ç²¾å¿ƒè®¾è®¡çš„åŒé‡å¤„ç†ç­–ç•¥ï¼Œç¡®ä¿äº†è®¢å•çŠ¶æ€æ›´æ–°çš„å¯é æ€§å’Œæœ€ç»ˆä¸€è‡´æ€§ã€‚ç³»ç»Ÿçš„ä¸»è¦ä¼˜åŠ¿åŒ…æ‹¬ï¼š

1. **æ™ºèƒ½è¯†åˆ«**ï¼šå‡†ç¡®è¯†åˆ«"äº¤æ˜“å…³é—­"ç±»å‹çš„çº¢è‰²æé†’
2. **çµæ´»æå–**ï¼šæ”¯æŒå¤šç§è®¢å•IDæå–æ–¹å¼ï¼Œæé«˜æˆåŠŸç‡
3. **å»¶è¿Ÿå¤„ç†**ï¼šé€šè¿‡å¾…å¤„ç†é˜Ÿåˆ—ä¿è¯çŠ¶æ€æ›´æ–°çš„å¯é æ€§
4. **æ€§èƒ½ä¼˜åŒ–**ï¼šé‡‡ç”¨é”åˆ†ç¦»å’Œæ‰¹é‡å¤„ç†æå‡å¹¶å‘æ€§èƒ½
5. **æ‰©å±•æ€§å¼º**ï¼šæ˜“äºæ”¯æŒæ–°çš„çº¢è‰²æé†’ç±»å‹å’Œè‡ªå®šä¹‰å¤„ç†ç­–ç•¥

è¯¥ç³»ç»Ÿä¸ºé—²é±¼è‡ªåŠ¨å›å¤å¹³å°æä¾›äº†ç¨³å®šå¯é çš„è®¢å•çŠ¶æ€ç®¡ç†èƒ½åŠ›ï¼Œæ˜¯æ•´ä¸ªè‡ªåŠ¨åŒ–ç³»ç»Ÿçš„é‡è¦ç»„æˆéƒ¨åˆ†ã€‚