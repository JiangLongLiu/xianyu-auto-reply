# 数据库版本检测机制

<cite>
**本文档引用的文件**
- [db_manager.py](file://db_manager.py)
- [config.py](file://config.py)
</cite>

## 目录
1. [简介](#简介)
2. [系统架构概览](#系统架构概览)
3. [核心组件分析](#核心组件分析)
4. [版本检测机制详解](#版本检测机制详解)
5. [升级流程分析](#升级流程分析)
6. [日志记录与异常处理](#日志记录与异常处理)
7. [版本控制策略](#版本控制策略)
8. [性能考虑](#性能考虑)
9. [故障排除指南](#故障排除指南)
10. [总结](#总结)

## 简介

db_manager.py中的`check_and_upgrade_db()`方法是整个系统数据库版本管理的核心组件，负责通过system_settings表中的db_version字段判断当前数据库版本，并按照版本号顺序执行从1.0到1.5的逐步升级流程。该方法确保了数据库结构演进的一致性和安全性，为系统的持续发展提供了可靠的版本控制机制。

## 系统架构概览

系统采用分层架构设计，数据库管理层负责维护数据持久化和版本控制：

```mermaid
graph TB
subgraph "应用层"
A[主程序入口] --> B[数据库初始化]
end
subgraph "数据库管理层"
B --> C[DBManager类]
C --> D[check_and_upgrade_db方法]
D --> E[版本检测逻辑]
D --> F[升级流程控制]
end
subgraph "数据访问层"
F --> G[system_settings表]
F --> H[各业务表升级]
G --> I[db_version字段]
end
subgraph "存储层"
I --> J[SQLite数据库]
H --> J
end
```

**图表来源**
- [db_manager.py](file://db_manager.py#L16-L50)
- [db_manager.py](file://db_manager.py#L557-L608)

## 核心组件分析

### DBManager类

DBManager类是数据库管理的核心控制器，负责：
- 数据库连接管理
- 表结构初始化
- 版本检测与升级
- 系统设置管理

### system_settings表

system_settings表是版本控制的核心存储机制，包含以下关键字段：

| 字段名 | 类型 | 描述 |
|--------|------|------|
| key | TEXT | 设置键名，主键 |
| value | TEXT | 设置值 |
| description | TEXT | 设置描述 |
| updated_at | TIMESTAMP | 更新时间戳 |

**节来源**
- [db_manager.py](file://db_manager.py#L368-L376)

## 版本检测机制详解

### 版本获取逻辑

版本检测的核心逻辑位于第560-561行：

```mermaid
flowchart TD
A[开始版本检测] --> B[查询system_settings表]
B --> C{db_version存在?}
C --> |是| D[获取当前版本]
C --> |否| E[使用默认版本1.0]
D --> F[版本比较判断]
E --> F
F --> G[确定升级路径]
G --> H[执行相应升级]
```

**图表来源**
- [db_manager.py](file://db_manager.py#L560-L562)

### 版本比较算法

版本比较采用字符串比较方式，确保语义版本控制的正确性：

```mermaid
sequenceDiagram
participant V as 版本检测器
participant S as system_settings表
participant U as 升级控制器
V->>S : 查询db_version
S-->>V : 返回当前版本
V->>V : 字符串比较(current_version < target_version)
V->>U : 触发升级流程
U->>U : 执行具体升级操作
U->>S : 更新db_version
U-->>V : 升级完成确认
```

**图表来源**
- [db_manager.py](file://db_manager.py#L570-L604)

**节来源**
- [db_manager.py](file://db_manager.py#L557-L608)

## 升级流程分析

### 1.0版本升级 - 基础功能完善

当检测到版本为1.0时，执行基础功能完善升级：

```mermaid
flowchart TD
A[版本1.0检测] --> B[创建admin用户]
B --> C[绑定历史数据]
C --> D[添加user_id字段]
D --> E[添加auto_confirm字段]
E --> F[添加多规格字段]
F --> G[修复约束问题]
G --> H[更新db_version=1.0]
```

**图表来源**
- [db_manager.py](file://db_manager.py#L564-L568)

### 1.1版本升级 - 通知渠道优化

升级notification_channels表，优化表结构：

```mermaid
flowchart TD
A[版本1.1检测] --> B[检查表存在性]
B --> C[备份现有数据]
C --> D[创建新表结构]
D --> E[数据迁移]
E --> F[类型映射处理]
F --> G[删除旧表]
G --> H[重命名新表]
H --> I[更新db_version=1.1]
```

**图表来源**
- [db_manager.py](file://db_manager.py#L571-L575)

### 1.2/1.4版本升级 - 通知渠道类型扩展

支持更多通知渠道类型，包括：
- 钉钉通知 (dingtalk)
- 飞书通知 (feishu/lark)
- Bark通知 (bark)
- 邮件通知 (email)
- Webhook通知 (webhook)
- 微信通知 (wechat)
- Telegram通知 (telegram)

### 1.3版本升级 - 图片支持增强

为keywords表添加图片URL字段，支持图片回复功能：

```mermaid
classDiagram
class KeywordsTable {
+string cookie_id
+string keyword
+string reply
+string item_id
+string type
+string image_url
+addImageSupport()
+updateConstraints()
}
class UpgradeProcess {
+upgradeKeywordsTable()
+addImageUrlField()
+updateUniqueConstraints()
}
KeywordsTable --> UpgradeProcess : "升级时修改"
```

**图表来源**
- [db_manager.py](file://db_manager.py#L585-L589)

### 1.5版本升级 - 账号登录功能

为cookies表添加账号登录相关字段：

| 字段名 | 类型 | 默认值 | 描述 |
|--------|------|--------|------|
| username | TEXT | '' | 用于密码登录的用户名 |
| password | TEXT | '' | 用于密码登录的密码 |
| show_browser | INTEGER | 0 | 登录时是否显示浏览器 |

**节来源**
- [db_manager.py](file://db_manager.py#L599-L604)

## 日志记录与异常处理

### 日志记录策略

系统采用分级日志记录策略：

```mermaid
flowchart LR
A[INFO级别] --> B[版本检测开始]
A --> C[升级步骤执行]
A --> D[数据迁移完成]
B --> E[DEBUG级别] --> F[系统设置获取]
C --> G[ERROR级别] --> H[升级失败处理]
D --> G
E --> I[WARNING级别] --> J[兼容性警告]
```

### 异常处理机制

异常处理遵循以下原则：

```mermaid
flowchart TD
A[异常发生] --> B{异常类型}
B --> |数据库错误| C[记录错误日志]
B --> |网络错误| D[重试机制]
B --> |业务逻辑错误| E[回滚操作]
C --> F[抛出异常]
D --> G[指数退避重试]
E --> H[清理资源]
F --> I[程序终止]
G --> J{重试次数}
J --> |未超限| K[重新执行]
J --> |超限| L[记录最终失败]
```

**节来源**
- [db_manager.py](file://db_manager.py#L609-L611)

## 版本控制策略

### 渐进式升级策略

系统采用渐进式升级策略，确保每个版本的稳定性：

```mermaid
graph LR
A[1.0基础版] --> B[1.1优化版]
B --> C[1.2扩展版]
C --> D[1.3增强版]
D --> E[1.4完善版]
E --> F[1.5完整版]
A -.-> G[向后兼容]
B -.-> G
C -.-> G
D -.-> G
E -.-> G
F -.-> G
```

### 版本状态持久化

每次升级完成后，系统都会更新db_version设置：

```mermaid
sequenceDiagram
participant U as 升级器
participant S as system_settings表
participant V as 版本控制器
U->>S : 开始升级前查询当前版本
S-->>U : 返回当前版本号
U->>U : 执行升级操作
U->>S : INSERT OR REPLACE更新db_version
S-->>U : 确认更新成功
U->>V : 升级完成通知
```

**图表来源**
- [db_manager.py](file://db_manager.py#L567-L568)
- [db_manager.py](file://db_manager.py#L575-L576)

### 数据一致性保障

系统通过以下机制保障数据一致性：

1. **事务控制**：每个升级步骤都在独立事务中执行
2. **回滚机制**：升级失败时自动回滚所有更改
3. **完整性检查**：升级前后进行数据完整性验证
4. **备份策略**：关键升级前创建数据备份

**节来源**
- [db_manager.py](file://db_manager.py#L2389-L2404)

## 性能考虑

### 升级性能优化

系统在升级过程中采用了多种性能优化策略：

1. **批量操作**：大量数据迁移采用批量处理
2. **索引优化**：升级过程中智能管理索引创建和删除
3. **内存管理**：大数据量处理时的内存使用优化
4. **并发控制**：使用线程锁防止并发升级冲突

### 版本检测性能

版本检测采用高效查询策略：
- 直接查询system_settings表的db_version字段
- 使用主键索引快速定位
- 缓存查询结果减少重复查询

## 故障排除指南

### 常见问题及解决方案

| 问题类型 | 症状 | 解决方案 |
|----------|------|----------|
| 版本检测失败 | 无法识别当前版本 | 检查system_settings表结构，确保db_version字段存在 |
| 升级中断 | 部分升级未完成 | 查看错误日志，手动执行剩余升级步骤 |
| 数据丢失 | 升级后数据异常 | 检查备份文件，恢复到升级前状态 |
| 性能问题 | 升级过程缓慢 | 优化数据库连接参数，增加硬件资源 |

### 调试技巧

1. **启用详细日志**：设置SQL_LOG_ENABLED=true获取详细执行日志
2. **版本追踪**：定期备份system_settings表内容
3. **增量测试**：对单个升级步骤进行单元测试
4. **监控指标**：监控升级过程中的资源使用情况

**节来源**
- [db_manager.py](file://db_manager.py#L55-L62)

## 总结

db_manager.py中的`check_and_upgrade_db()`方法构建了一个完整而可靠的数据库版本控制系统。该系统通过以下特性确保了数据库结构演进的安全性和一致性：

1. **精确的版本检测**：基于system_settings表的db_version字段进行版本识别
2. **渐进式升级流程**：从1.0到1.5的有序升级路径
3. **完善的异常处理**：多层次的错误处理和恢复机制
4. **数据安全保障**：事务控制和回滚机制
5. **性能优化策略**：高效的查询和批量处理

这种设计不仅保证了系统的稳定运行，还为未来的功能扩展提供了坚实的基础。通过版本控制机制，开发者可以放心地添加新功能，而不必担心破坏现有数据结构或影响系统稳定性。