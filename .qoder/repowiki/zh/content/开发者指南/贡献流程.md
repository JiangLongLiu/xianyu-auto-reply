# è´¡çŒ®æµç¨‹

<cite>
**æœ¬æ–‡æ¡£å¼•ç”¨çš„æ–‡ä»¶**
- [README.md](file://README.md)
- [requirements.txt](file://requirements.txt)
- [Dockerfile](file://Dockerfile)
- [config.py](file://config.py)
- [Start.py](file://Start.py)
- [global_config.yml](file://global_config.yml)
- [docker-compose.yml](file://docker-compose.yml)
- [utils/xianyu_utils.py](file://utils/xianyu_utils.py)
- [utils/image_utils.py](file://utils/image_utils.py)
- [utils/item_search.py](file://utils/item_search.py)
- [file_log_collector.py](file://file_log_collector.py)
- [utils/captcha_remote_control.py](file://utils/captcha_remote_control.py)
</cite>

## ç›®å½•
1. [é¡¹ç›®ç®€ä»‹](#é¡¹ç›®ç®€ä»‹)
2. [å¼€å‘ç¯å¢ƒæ­å»º](#å¼€å‘ç¯å¢ƒæ­å»º)
3. [åˆ†æ”¯ç®¡ç†ç­–ç•¥](#åˆ†æ”¯ç®¡ç†ç­–ç•¥)
4. [ä»£ç æäº¤è§„èŒƒ](#ä»£ç æäº¤è§„èŒƒ)
5. [Pull Requestå®¡æŸ¥æ ‡å‡†](#pull-requestå®¡æŸ¥æ ‡å‡†)
6. [å•å…ƒæµ‹è¯•ç¼–å†™æŒ‡å—](#å•å…ƒæµ‹è¯•ç¼–å†™æŒ‡å—)
7. [æ–‡æ¡£æ›´æ–°è¦æ±‚](#æ–‡æ¡£æ›´æ–°è¦æ±‚)
8. [è°ƒè¯•å’Œæµ‹è¯•æŒ‡å—](#è°ƒè¯•å’Œæµ‹è¯•æŒ‡å—)
9. [éƒ¨ç½²å’Œå‘å¸ƒæµç¨‹](#éƒ¨ç½²å’Œå‘å¸ƒæµç¨‹)
10. [å¸¸è§é—®é¢˜è§£ç­”](#å¸¸è§é—®é¢˜è§£ç­”)

## é¡¹ç›®ç®€ä»‹

é—²é±¼è‡ªåŠ¨å›å¤ç³»ç»Ÿæ˜¯ä¸€ä¸ªåŠŸèƒ½å®Œæ•´çš„é—²é±¼è‡ªåŠ¨å›å¤å’Œç®¡ç†ç³»ç»Ÿï¼Œé‡‡ç”¨ç°ä»£åŒ–çš„æŠ€æœ¯æ¶æ„ï¼Œæ”¯æŒå¤šç”¨æˆ·ã€å¤šè´¦å·ç®¡ç†ï¼Œå…·å¤‡æ™ºèƒ½å›å¤ã€è‡ªåŠ¨å‘è´§ã€è‡ªåŠ¨ç¡®è®¤å‘è´§ã€å•†å“ç®¡ç†ç­‰ä¼ä¸šçº§åŠŸèƒ½ã€‚ç³»ç»ŸåŸºäºPythonå¼‚æ­¥ç¼–ç¨‹ï¼Œä½¿ç”¨FastAPIæä¾›RESTful APIï¼ŒSQLiteæ•°æ®åº“å­˜å‚¨ï¼Œæ”¯æŒDockerä¸€é”®éƒ¨ç½²ã€‚

### æ ¸å¿ƒç‰¹æ€§
- **å¤šç”¨æˆ·ç³»ç»Ÿ**ï¼šæ”¯æŒç”¨æˆ·æ³¨å†Œç™»å½•ã€æ•°æ®å®Œå…¨éš”ç¦»ã€æƒé™ç®¡ç†
- **å¤šè´¦å·ç®¡ç†**ï¼šæ”¯æŒæ— é™è´¦å·ã€ç‹¬ç«‹è¿è¡Œã€å®æ—¶çŠ¶æ€ç›‘æ§
- **æ™ºèƒ½å›å¤ç³»ç»Ÿ**ï¼šæ”¯æŒå…³é”®è¯åŒ¹é…ã€AIæ™ºèƒ½å›å¤ã€å˜é‡æ›¿æ¢
- **è‡ªåŠ¨å‘è´§åŠŸèƒ½**ï¼šæ”¯æŒæ™ºèƒ½åŒ¹é…ã€å¤šè§„æ ¼æ”¯æŒã€é˜²é‡å¤å‘è´§
- **å•†å“æœç´¢åŠŸèƒ½**ï¼šåŸºäºPlaywrightçš„çœŸå®æ•°æ®è·å–ã€æ™ºèƒ½æ’åº
- **å®æ—¶ç›‘æ§**ï¼šWebSocketå®æ—¶é€šä¿¡ã€ç³»ç»ŸçŠ¶æ€ç›‘æ§

## å¼€å‘ç¯å¢ƒæ­å»º

### ç³»ç»Ÿè¦æ±‚
- **Python**: 3.11+
- **Node.js**: 16+ (ç”¨äºJavaScriptæ‰§è¡Œ)
- **ç³»ç»Ÿ**: Windows/Linux/macOS
- **æ¶æ„**: x86_64 (amd64) / ARM64 (aarch64)
- **å†…å­˜**: å»ºè®®2GB+
- **å­˜å‚¨**: å»ºè®®10GB+

### æœ¬åœ°å¼€å‘ç¯å¢ƒé…ç½®

#### 1. å…‹éš†é¡¹ç›®
```bash
git clone https://github.com/zhinianboke/xianyu-auto-reply.git
cd xianyu-auto-reply
```

#### 2. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ
```bash
# åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ
python -m venv venv

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
# Linux/macOS
source venv/bin/activate
# Windows
venv\Scripts\activate
```

#### 3. å®‰è£…ä¾èµ–
```bash
# å‡çº§pip
pip install --upgrade pip

# å®‰è£…Pythonä¾èµ–
pip install -r requirements.txt

# å®‰è£…Playwrightæµè§ˆå™¨
playwright install chromium
playwright install-deps chromium  # Linuxéœ€è¦
```

#### 4. ç¯å¢ƒå˜é‡é…ç½®
ç³»ç»Ÿæ”¯æŒé€šè¿‡ç¯å¢ƒå˜é‡è¿›è¡Œé…ç½®ï¼Œä¸»è¦é…ç½®é¡¹åŒ…æ‹¬ï¼š

```bash
# åŸºç¡€é…ç½®
WEB_PORT=8080                          # WebæœåŠ¡ç«¯å£
API_HOST=0.0.0.0                       # APIæœåŠ¡ä¸»æœº
TZ=Asia/Shanghai                       # æ—¶åŒºè®¾ç½®

# æ•°æ®åº“é…ç½®
DB_PATH=data/xianyu_data.db            # æ•°æ®åº“æ–‡ä»¶è·¯å¾„

# ç®¡ç†å‘˜é…ç½®
ADMIN_USERNAME=admin                   # ç®¡ç†å‘˜ç”¨æˆ·å
ADMIN_PASSWORD=admin123                # ç®¡ç†å‘˜å¯†ç ï¼ˆè¯·ä¿®æ”¹ï¼‰
JWT_SECRET_KEY=your-secret-key         # JWTå¯†é’¥ï¼ˆè¯·ä¿®æ”¹ï¼‰

# åŠŸèƒ½å¼€å…³
AUTO_REPLY_ENABLED=true                # å¯ç”¨è‡ªåŠ¨å›å¤
AUTO_DELIVERY_ENABLED=true             # å¯ç”¨è‡ªåŠ¨å‘è´§
AI_REPLY_ENABLED=false                 # å¯ç”¨AIå›å¤

# æ—¥å¿—é…ç½®
LOG_LEVEL=INFO                         # æ—¥å¿—çº§åˆ«
SQL_LOG_ENABLED=true                   # SQLæ—¥å¿—
```

#### 5. å¯åŠ¨ç³»ç»Ÿ
```bash
# å¯åŠ¨ç³»ç»Ÿ
python Start.py

# è®¿é—®ç³»ç»Ÿ
# http://localhost:8080
```

### Dockerå¼€å‘ç¯å¢ƒ

#### 1. å›½é™…ç‰ˆå¼€å‘ç¯å¢ƒ
```bash
# ä½¿ç”¨å®Œæ•´ç‰ˆé…ç½®ï¼ˆåŒ…å«Redisç¼“å­˜ç­‰å¢å¼ºåŠŸèƒ½ï¼‰
docker-compose up -d --build
```

#### 2. ä¸­å›½ç‰ˆå¼€å‘ç¯å¢ƒ
```bash
# ä½¿ç”¨ä¸­å›½é•œåƒæºé…ç½®ï¼ˆä¸‹è½½é€Ÿåº¦æ›´å¿«ï¼‰
docker-compose -f docker-compose-cn.yml up -d --build
```

**ç« èŠ‚æ¥æº**
- [README.md](file://README.md#L362-L427)
- [requirements.txt](file://requirements.txt#L1-L93)
- [Dockerfile](file://Dockerfile#L1-L138)
- [Start.py](file://Start.py#L1-L602)

## åˆ†æ”¯ç®¡ç†ç­–ç•¥

### åˆ†æ”¯å‘½åè§„èŒƒ
- **main**: ä¸»åˆ†æ”¯ï¼ŒåŒ…å«ç¨³å®šçš„ç”Ÿäº§ä»£ç 
- **develop**: å¼€å‘åˆ†æ”¯ï¼ŒåŒ…å«æœ€æ–°çš„å¼€å‘ä»£ç 
- **feature/**: åŠŸèƒ½åˆ†æ”¯ï¼Œç”¨äºå¼€å‘æ–°åŠŸèƒ½
- **bugfix/**: ä¿®å¤åˆ†æ”¯ï¼Œç”¨äºä¿®å¤bug
- **hotfix/**: çƒ­ä¿®å¤åˆ†æ”¯ï¼Œç”¨äºç´§æ€¥ä¿®å¤
- **release/**: å‘å¸ƒåˆ†æ”¯ï¼Œç”¨äºå‡†å¤‡å‘å¸ƒç‰ˆæœ¬

### åˆ†æ”¯åˆ›å»ºæµç¨‹
1. **ä»developåˆ›å»ºåŠŸèƒ½åˆ†æ”¯**
```bash
git checkout develop
git pull origin develop
git checkout -b feature/your-feature-name
```

2. **å¼€å‘å®Œæˆååˆå¹¶åˆ°develop**
```bash
git checkout develop
git pull origin develop
git merge --no-ff feature/your-feature-name
git push origin develop
```

3. **ä»mainåˆ›å»ºå‘å¸ƒåˆ†æ”¯**
```bash
git checkout main
git pull origin main
git checkout -b release/1.0.0
```

4. **å‘å¸ƒå®Œæˆååˆå¹¶åˆ°mainå’Œdevelop**
```bash
git checkout main
git merge --no-ff release/1.0.0
git tag -a v1.0.0 -m "Release version 1.0.0"
git push origin main
git push origin --tags

git checkout develop
git merge --no-ff release/1.0.0
git push origin develop
```

### åˆ†æ”¯ç®¡ç†æœ€ä½³å®è·µ
- **é¢‘ç¹æäº¤**ï¼šä¿æŒå°è€Œé¢‘ç¹çš„æäº¤ï¼Œä¾¿äºè¿½è¸ªå’Œå›æ»š
- **æ¸…æ™°çš„æäº¤ä¿¡æ¯**ï¼šéµå¾ªçº¦å®šçš„æäº¤ä¿¡æ¯æ ¼å¼
- **ä»£ç å®¡æŸ¥**ï¼šæ‰€æœ‰åŠŸèƒ½åˆ†æ”¯éƒ½éœ€è¦ä»£ç å®¡æŸ¥æ‰èƒ½åˆå¹¶
- **æµ‹è¯•è¦†ç›–**ï¼šç¡®ä¿æ–°åŠŸèƒ½æœ‰ç›¸åº”çš„æµ‹è¯•è¦†ç›–

## ä»£ç æäº¤è§„èŒƒ

### æäº¤ä¿¡æ¯æ ¼å¼
```
<type>(<scope>): <subject>

<body>

<footer>
```

#### Typeç±»å‹
- **feat**: æ–°åŠŸèƒ½
- **fix**: bugä¿®å¤
- **docs**: æ–‡æ¡£æ›´æ–°
- **style**: ä»£ç æ ¼å¼è°ƒæ•´
- **refactor**: ä»£ç é‡æ„
- **test**: æµ‹è¯•ç›¸å…³
- **chore**: æ„å»ºè¿‡ç¨‹æˆ–è¾…åŠ©å·¥å…·çš„å˜åŠ¨

#### ScopeèŒƒå›´
- **utils**: å·¥å…·å‡½æ•°æ¨¡å—
- **api**: APIæ¥å£
- **ui**: ç”¨æˆ·ç•Œé¢
- **config**: é…ç½®æ–‡ä»¶
- **docker**: Dockerç›¸å…³
- **test**: æµ‹è¯•æ–‡ä»¶

#### Subjectæè¿°
- ä½¿ç”¨ç¥ˆä½¿å¥ï¼Œä¸è¶…è¿‡50å­—ç¬¦
- é¦–å­—æ¯å¤§å†™
- ä¸ä»¥`.`ç»“å°¾

#### ç¤ºä¾‹
```
feat(utils): æ·»åŠ å›¾ç‰‡å‹ç¼©å·¥å…·å‡½æ•°

- æ–°å¢ImageCompressorç±»
- æ”¯æŒJPEGã€PNGæ ¼å¼å‹ç¼©
- æ·»åŠ è´¨é‡æ§åˆ¶å‚æ•°
- å®ç°æ‰¹é‡å¤„ç†åŠŸèƒ½

Closes #123
```

### æäº¤å‰æ£€æŸ¥æ¸…å•
- [ ] ä»£ç ç¬¦åˆé¡¹ç›®ç¼–ç è§„èŒƒ
- [ ] æ‰€æœ‰æµ‹è¯•é€šè¿‡
- [ ] æ–°åŠŸèƒ½æœ‰ç›¸åº”æµ‹è¯•
- [ ] æ–‡æ¡£å·²æ›´æ–°
- [ ] æäº¤ä¿¡æ¯æ¸…æ™°æ˜ç¡®
- [ ] ä»£ç å®¡æŸ¥å·²å®Œæˆ

## Pull Requestå®¡æŸ¥æ ‡å‡†

### ä»£ç è´¨é‡æ ‡å‡†

#### 1. ä»£ç é£æ ¼
- **PEP 8è§„èŒƒ**ï¼šéµå¾ªPythonå®˜æ–¹ç¼–ç è§„èŒƒ
- **å‘½åè§„èŒƒ**ï¼šä½¿ç”¨æœ‰æ„ä¹‰çš„å˜é‡å’Œå‡½æ•°å
- **æ³¨é‡Šè§„èŒƒ**ï¼šå…³é”®é€»è¾‘æ·»åŠ ä¸­æ–‡æ³¨é‡Š
- **å¯¼å…¥é¡ºåº**ï¼šæ ‡å‡†åº“ã€ç¬¬ä¸‰æ–¹åº“ã€é¡¹ç›®æ¨¡å—åˆ†ç»„å¯¼å…¥

#### 2. ä»£ç ç»“æ„
- **æ¨¡å—åŒ–è®¾è®¡**ï¼šåŠŸèƒ½å•ä¸€ï¼ŒèŒè´£åˆ†ç¦»
- **é”™è¯¯å¤„ç†**ï¼šå®Œå–„çš„å¼‚å¸¸æ•è·å’Œå¤„ç†
- **æ€§èƒ½è€ƒè™‘**ï¼šé¿å…ä¸å¿…è¦çš„è®¡ç®—å’Œå†…å­˜æ¶ˆè€—
- **å®‰å…¨æ€§**ï¼šé˜²æ­¢SQLæ³¨å…¥ã€XSSç­‰å®‰å…¨æ¼æ´

#### 3. æ€§èƒ½å½±å“è¯„ä¼°
- **æ—¶é—´å¤æ‚åº¦**ï¼šç®—æ³•æ•ˆç‡åˆç†
- **ç©ºé—´å¤æ‚åº¦**ï¼šå†…å­˜ä½¿ç”¨å¯æ§
- **å¹¶å‘å¤„ç†**ï¼šæ”¯æŒå¼‚æ­¥æ“ä½œ
- **èµ„æºç®¡ç†**ï¼šæ­£ç¡®ä½¿ç”¨èµ„æºä¸Šä¸‹æ–‡

### å®‰å…¨æ€§æ£€æŸ¥

#### 1. è¾“å…¥éªŒè¯
- **å‚æ•°æ ¡éªŒ**ï¼šæ‰€æœ‰å¤–éƒ¨è¾“å…¥éƒ½è¿›è¡ŒéªŒè¯
- **ç±»å‹æ£€æŸ¥**ï¼šç¡®ä¿æ•°æ®ç±»å‹æ­£ç¡®
- **è¾¹ç•Œæ£€æŸ¥**ï¼šé˜²æ­¢æ•°ç»„è¶Šç•Œç­‰é—®é¢˜

#### 2. æƒé™æ§åˆ¶
- **èº«ä»½éªŒè¯**ï¼šç¡®ä¿ç”¨æˆ·èº«ä»½åˆæ³•
- **æƒé™æ£€æŸ¥**ï¼šéªŒè¯ç”¨æˆ·æ“ä½œæƒé™
- **æ•°æ®éš”ç¦»**ï¼šç¡®ä¿ç”¨æˆ·æ•°æ®ç›¸äº’éš”ç¦»

#### 3. æ•æ„Ÿä¿¡æ¯ä¿æŠ¤
- **å¯†ç å¤„ç†**ï¼šä½¿ç”¨å®‰å…¨çš„å¯†ç å­˜å‚¨æ–¹å¼
- **APIå¯†é’¥**ï¼šä¸ç¡¬ç¼–ç æ•æ„Ÿä¿¡æ¯
- **æ—¥å¿—è„±æ•**ï¼šé¿å…åœ¨æ—¥å¿—ä¸­è®°å½•æ•æ„Ÿä¿¡æ¯

### æ–‡æ¡£æ›´æ–°è¦æ±‚

#### 1. ä»£ç æ³¨é‡Š
- **å‡½æ•°æ³¨é‡Š**ï¼šæ¯ä¸ªå…¬å…±å‡½æ•°æ·»åŠ docstring
- **å¤æ‚é€»è¾‘**ï¼šå…³é”®ç®—æ³•æ·»åŠ ä¸­æ–‡æ³¨é‡Š
- **å‚æ•°è¯´æ˜**ï¼šè¯¦ç»†è¯´æ˜å‡½æ•°å‚æ•°å«ä¹‰

#### 2. APIæ–‡æ¡£
- **æ¥å£è¯´æ˜**ï¼šæ›´æ–°APIæ–‡æ¡£
- **å‚æ•°åˆ—è¡¨**ï¼šåˆ—å‡ºæ‰€æœ‰å‚æ•°åŠå…¶ç±»å‹
- **è¿”å›å€¼**ï¼šè¯´æ˜è¿”å›å€¼ç»“æ„

#### 3. ç”¨æˆ·æ–‡æ¡£
- **ä½¿ç”¨è¯´æ˜**ï¼šæ–°åŠŸèƒ½çš„ä½¿ç”¨æ–¹æ³•
- **é…ç½®æŒ‡å—**ï¼šç›¸å…³é…ç½®é¡¹è¯´æ˜
- **æ•…éšœæ’é™¤**ï¼šå¸¸è§é—®é¢˜è§£å†³æ–¹æ¡ˆ

### æµ‹è¯•è¦†ç›–ç‡è¦æ±‚

#### 1. å•å…ƒæµ‹è¯•
- **å·¥å…·å‡½æ•°**ï¼š100%æµ‹è¯•è¦†ç›–ç‡
- **æ ¸å¿ƒä¸šåŠ¡é€»è¾‘**ï¼šè‡³å°‘80%æµ‹è¯•è¦†ç›–ç‡
- **è¾¹ç•Œæ¡ä»¶**ï¼šæµ‹è¯•å„ç§è¾¹ç•Œæƒ…å†µ

#### 2. é›†æˆæµ‹è¯•
- **APIæ¥å£**ï¼šå®Œæ•´çš„APIæµ‹è¯•
- **æ•°æ®åº“æ“ä½œ**ï¼šæ•°æ®åº“äº¤äº’æµ‹è¯•
- **å¤–éƒ¨æœåŠ¡**ï¼šç¬¬ä¸‰æ–¹æœåŠ¡é›†æˆæµ‹è¯•

**ç« èŠ‚æ¥æº**
- [config.py](file://config.py#L1-L126)
- [global_config.yml](file://global_config.yml#L1-L77)

## å•å…ƒæµ‹è¯•ç¼–å†™æŒ‡å—

### æµ‹è¯•æ¡†æ¶é€‰æ‹©
é¡¹ç›®ä½¿ç”¨Pythonæ ‡å‡†åº“çš„unittestæ¡†æ¶ï¼Œé…åˆpytestè¿›è¡Œæµ‹è¯•ã€‚

### æµ‹è¯•æ–‡ä»¶ç»„ç»‡
```
tests/
â”œâ”€â”€ utils/
â”‚   â”œâ”€â”€ test_xianyu_utils.py
â”‚   â”œâ”€â”€ test_image_utils.py
â”‚   â””â”€â”€ test_item_search.py
â”œâ”€â”€ api/
â”‚   â””â”€â”€ test_api_endpoints.py
â”œâ”€â”€ conftest.py
â””â”€â”€ test_requirements.txt
```

### å·¥å…·å‡½æ•°æµ‹è¯•ç¤ºä¾‹

#### 1. æµ‹è¯•xianyu_utils.pyä¸­çš„å‡½æ•°

```python
import unittest
from utils.xianyu_utils import trans_cookies, generate_mid, generate_uuid

class TestXianyuUtils(unittest.TestCase):
    """æµ‹è¯•é—²é±¼å·¥å…·å‡½æ•°"""
    
    def test_trans_cookies(self):
        """æµ‹è¯•cookiesè½¬æ¢å‡½æ•°"""
        cookies_str = "key1=value1; key2=value2; key3=value3"
        expected = {"key1": "value1", "key2": "value2", "key3": "value3"}
        result = trans_cookies(cookies_str)
        self.assertEqual(result, expected)
        
        # æµ‹è¯•ç©ºå­—ç¬¦ä¸²
        with self.assertRaises(ValueError):
            trans_cookies("")
    
    def test_generate_mid(self):
        """æµ‹è¯•ç”Ÿæˆmidå‡½æ•°"""
        mid = generate_mid()
        self.assertIsInstance(mid, str)
        self.assertGreater(len(mid), 0)
        
        # æµ‹è¯•å¤šæ¬¡ç”Ÿæˆçš„ç»“æœä¸åŒ
        mid2 = generate_mid()
        self.assertNotEqual(mid, mid2)
    
    def test_generate_uuid(self):
        """æµ‹è¯•ç”Ÿæˆuuidå‡½æ•°"""
        uuid = generate_uuid()
        self.assertIsInstance(uuid, str)
        self.assertTrue(uuid.startswith("-"))
        self.assertGreater(len(uuid), 0)
```

#### 2. æµ‹è¯•image_utils.pyä¸­çš„å‡½æ•°

```python
import unittest
from utils.image_utils import ImageManager

class TestImageUtils(unittest.TestCase):
    """æµ‹è¯•å›¾ç‰‡å¤„ç†å·¥å…·"""
    
    def setUp(self):
        """æµ‹è¯•å‰å‡†å¤‡"""
        self.image_manager = ImageManager()
        
    def test_save_image(self):
        """æµ‹è¯•ä¿å­˜å›¾ç‰‡åŠŸèƒ½"""
        # å‡†å¤‡æµ‹è¯•å›¾ç‰‡æ•°æ®
        test_image_data = b'\x89PNG\r\n\x1a\n\x00\x00\x00\rIHDR\x00\x00\x00\x01\x00\x00\x00\x01\x08\x02\x00\x00\x00\x90wS\xde\x00\x00\x00\x0cIDAT\x08\xd7c\xf8\xff\xff?\x00\x05\xfe\x02\xfe\xdc\xcc\xe7\x00\x00\x00\x00IEND\xaeB`\x82'
        
        # æµ‹è¯•ä¿å­˜å›¾ç‰‡
        result = self.image_manager.save_image(test_image_data, "test.png")
        self.assertIsNotNone(result)
        self.assertTrue(result.endswith(".jpg"))
        
        # æµ‹è¯•æ–‡ä»¶å­˜åœ¨
        import os
        self.assertTrue(os.path.exists(result))
        
        # æ¸…ç†æµ‹è¯•æ–‡ä»¶
        os.remove(result)
    
    def test_validate_image_data(self):
        """æµ‹è¯•å›¾ç‰‡æ•°æ®éªŒè¯"""
        # æµ‹è¯•æœ‰æ•ˆå›¾ç‰‡
        valid_image = b'\x89PNG\r\n\x1a\n\x00\x00\x00\rIHDR\x00\x00\x00\x01\x00\x00\x00\x01\x08\x02\x00\x00\x00\x90wS\xde\x00\x00\x00\x0cIDAT\x08\xd7c\xf8\xff\xff?\x00\x05\xfe\x02\xfe\xdc\xcc\xe7\x00\x00\x00\x00IEND\xaeB`\x82'
        self.assertTrue(self.image_manager._validate_image_data(valid_image))
        
        # æµ‹è¯•æ— æ•ˆå›¾ç‰‡
        invalid_image = b'invalid image data'
        self.assertFalse(self.image_manager._validate_image_data(invalid_image))
```

### æµ‹è¯•é…ç½®æ–‡ä»¶

#### 1. conftest.pyé…ç½®
```python
import pytest
import asyncio
from utils.image_utils import ImageManager

@pytest.fixture
def image_manager():
    """æä¾›å›¾ç‰‡ç®¡ç†å™¨å®ä¾‹"""
    return ImageManager()

@pytest.fixture
def event_loop():
    """æä¾›äº‹ä»¶å¾ªç¯"""
    loop = asyncio.new_event_loop()
    yield loop
    loop.close()
```

#### 2. æµ‹è¯•è¿è¡Œé…ç½®
```bash
# å®‰è£…æµ‹è¯•ä¾èµ–
pip install pytest pytest-asyncio coverage

# è¿è¡Œæ‰€æœ‰æµ‹è¯•
pytest tests/

# è¿è¡Œç‰¹å®šæ¨¡å—æµ‹è¯•
pytest tests/utils/test_xianyu_utils.py

# ç”Ÿæˆæµ‹è¯•è¦†ç›–ç‡æŠ¥å‘Š
pytest --cov=utils tests/
```

### æµ‹è¯•æœ€ä½³å®è·µ

#### 1. æµ‹è¯•éš”ç¦»
- æ¯ä¸ªæµ‹è¯•ç”¨ä¾‹ç‹¬ç«‹è¿è¡Œ
- ä½¿ç”¨setUpå’ŒtearDownæ¸…ç†èµ„æº
- é¿å…æµ‹è¯•é—´çš„ä¾èµ–å…³ç³»

#### 2. æµ‹è¯•æ•°æ®
- ä½¿ç”¨mockå¯¹è±¡æ›¿ä»£å¤–éƒ¨ä¾èµ–
- å‡†å¤‡å……åˆ†çš„æµ‹è¯•æ•°æ®
- è€ƒè™‘è¾¹ç•Œæ¡ä»¶å’Œå¼‚å¸¸æƒ…å†µ

#### 3. æµ‹è¯•è¦†ç›–
- ç¡®ä¿æ ¸å¿ƒåŠŸèƒ½100%è¦†ç›–
- é‡è§†è¾¹ç•Œæ¡ä»¶æµ‹è¯•
- è€ƒè™‘å¹¶å‘åœºæ™¯æµ‹è¯•

**ç« èŠ‚æ¥æº**
- [utils/xianyu_utils.py](file://utils/xianyu_utils.py#L1-L200)
- [utils/image_utils.py](file://utils/image_utils.py#L1-L200)
- [utils/item_search.py](file://utils/item_search.py#L1-L200)

## æ–‡æ¡£æ›´æ–°è¦æ±‚

### README.mdæ›´æ–°

#### 1. æ–°åŠŸèƒ½è¯´æ˜
å½“æ·»åŠ æ–°åŠŸèƒ½æ—¶ï¼Œéœ€è¦åœ¨README.mdä¸­æ›´æ–°ç›¸å…³éƒ¨åˆ†ï¼š

```markdown
### ğŸ‰ æ–°åŠŸèƒ½ç‰¹æ€§

#### æ™ºèƒ½å›¾ç‰‡å¤„ç†
- æ”¯æŒJPEGã€PNGã€GIFã€WEBPæ ¼å¼
- è‡ªåŠ¨å‹ç¼©å’Œå°ºå¯¸è°ƒæ•´
- æ‰¹é‡å¤„ç†åŠŸèƒ½
- è´¨é‡æ§åˆ¶å‚æ•°å¯é…ç½®
```

#### 2. ä½¿ç”¨ç¤ºä¾‹
æ·»åŠ æ–°åŠŸèƒ½çš„ä½¿ç”¨ç¤ºä¾‹ï¼š

```markdown
### ğŸš€ ä½¿ç”¨ç¤ºä¾‹

#### å›¾ç‰‡å¤„ç†ç¤ºä¾‹
```python
from utils.image_utils import ImageManager

# åˆå§‹åŒ–å›¾ç‰‡ç®¡ç†å™¨
image_manager = ImageManager()

# ä¿å­˜å›¾ç‰‡
with open("input.jpg", "rb") as f:
    image_data = f.read()
    result = image_manager.save_image(image_data, "output.jpg")
    print(f"å›¾ç‰‡ä¿å­˜æˆåŠŸ: {result}")
```
```

### APIæ–‡æ¡£æ›´æ–°

#### 1. æ¥å£æ–‡æ¡£
ä½¿ç”¨Swagger/OpenAPIæ ¼å¼æ›´æ–°APIæ–‡æ¡£ï¼š

```yaml
paths:
  /api/images/upload:
    post:
      summary: ä¸Šä¼ å›¾ç‰‡
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              properties:
                image:
                  type: string
                  format: binary
                quality:
                  type: integer
                  default: 85
      responses:
        '200':
          description: å›¾ç‰‡ä¸Šä¼ æˆåŠŸ
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  file_path:
                    type: string
                  message:
                    type: string
```

#### 2. é…ç½®æ–‡æ¡£
æ›´æ–°é…ç½®æ–‡ä»¶è¯´æ˜ï¼š

```markdown
### ğŸ“‹ é…ç½®è¯´æ˜

#### å›¾ç‰‡å¤„ç†é…ç½®
```yaml
IMAGE_PROCESSING:
  max_size: 5242880  # æœ€å¤§æ–‡ä»¶å¤§å°5MB
  max_width: 1920    # æœ€å¤§å®½åº¦
  max_height: 1080   # æœ€å¤§é«˜åº¦
  quality: 85        # å‹ç¼©è´¨é‡
  allowed_formats: ['JPEG', 'PNG', 'GIF', 'WEBP']
```
```

### å¼€å‘è€…æŒ‡å—æ›´æ–°

#### 1. è´¡çŒ®æŒ‡å—
æ›´æ–°è´¡çŒ®æµç¨‹æ–‡æ¡£ï¼š

```markdown
## ğŸ¤ è´¡çŒ®æŒ‡å—

### 1. å¼€å‘ç¯å¢ƒæ­å»º
- å…‹éš†é¡¹ç›®åˆ°æœ¬åœ°
- åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ
- å®‰è£…ä¾èµ–ï¼š`pip install -r requirements.txt`
- å®‰è£…Playwrightï¼š`playwright install chromium`

### 2. ä»£ç è§„èŒƒ
- éµå¾ªPEP 8ç¼–ç è§„èŒƒ
- æ·»åŠ å¿…è¦çš„æ³¨é‡Š
- ç¼–å†™å•å…ƒæµ‹è¯•

### 3. æäº¤è§„èŒƒ
- ä½¿ç”¨æ¸…æ™°çš„æäº¤ä¿¡æ¯
- åŒ…å«ç›¸å…³çš„Issueç¼–å·
- é€šè¿‡æ‰€æœ‰æµ‹è¯•
```

#### 2. è°ƒè¯•æŒ‡å—
æ·»åŠ è°ƒè¯•ç›¸å…³æ–‡æ¡£ï¼š

```markdown
## ğŸ” è°ƒè¯•æŒ‡å—

### å¯ç”¨è¯¦ç»†æ—¥å¿—
è®¾ç½®ç¯å¢ƒå˜é‡ï¼š
```bash
export LOG_LEVEL=DEBUG
export SQL_LOG_ENABLED=true
```

### ä½¿ç”¨Playwrightè°ƒè¯•
```bash
# å¯ç”¨Playwrightè°ƒè¯•æ¨¡å¼
export PLAYWRIGHT_DEBUG=1
python Start.py
```
```

**ç« èŠ‚æ¥æº**
- [README.md](file://README.md#L1-L800)
- [file_log_collector.py](file://file_log_collector.py#L58-L240)

## è°ƒè¯•å’Œæµ‹è¯•æŒ‡å—

### å¯ç”¨è¯¦ç»†æ—¥å¿—

#### 1. ç¯å¢ƒå˜é‡é…ç½®
è®¾ç½®æ—¥å¿—çº§åˆ«ä¸ºDEBUGä»¥è·å–è¯¦ç»†ä¿¡æ¯ï¼š

```bash
# è®¾ç½®æ—¥å¿—çº§åˆ«ä¸ºDEBUG
export LOG_LEVEL=DEBUG

# å¯ç”¨SQLæ—¥å¿—
export SQL_LOG_ENABLED=true

# å¯ç”¨è¯¦ç»†è¾“å‡º
export PYTHONUNBUFFERED=1
```

#### 2. é…ç½®æ–‡ä»¶ä¿®æ”¹
åœ¨global_config.ymlä¸­é…ç½®æ—¥å¿—ï¼š

```yaml
LOG_CONFIG:
  level: DEBUG
  format: '{time:YYYY-MM-DD HH:mm:ss.SSS} | {level} | {name}:{function}:{line} - {message}'
  rotation: 1 day
  retention: 7 days
```

#### 3. å®æ—¶æ—¥å¿—æŸ¥çœ‹
ç³»ç»Ÿæä¾›Webç•Œé¢æŸ¥çœ‹å®æ—¶æ—¥å¿—ï¼š

```python
# å¯åŠ¨æ—¥å¿—æ”¶é›†å™¨
from file_log_collector import setup_file_logging
setup_file_logging()

# æŸ¥çœ‹æ—¥å¿—
from file_log_collector import get_file_log_collector
collector = get_file_log_collector()
logs = collector.get_logs(lines=100, level_filter="DEBUG")
```

### ä½¿ç”¨Playwrightè°ƒè¯•æ¨¡å¼

#### 1. å¯ç”¨è°ƒè¯•æ¨¡å¼
```bash
# å¯ç”¨Playwrightè°ƒè¯•æ¨¡å¼
export PLAYWRIGHT_DEBUG=1

# å¯ç”¨æµè§ˆå™¨è°ƒè¯•
export PWDEBUG=1
```

#### 2. æµè§ˆå™¨è¡Œä¸ºç›‘æ§
```python
# åœ¨ä»£ç ä¸­å¯ç”¨è°ƒè¯•
from playwright.async_api import async_playwright

async def debug_browser():
    async with async_playwright() as p:
        browser = await p.chromium.launch(headless=False, slow_mo=1000)
        page = await browser.new_page()
        
        # è®¾ç½®æ–­ç‚¹
        page.on("pageerror", lambda msg: print(f"é¡µé¢é”™è¯¯: {msg}"))
        page.on("console", lambda msg: print(f"æ§åˆ¶å°: {msg.text}"))
        
        await page.goto("https://www.goofish.com")
        
        # æ‰‹åŠ¨æ“ä½œæµè§ˆå™¨
        input("æŒ‰å›è½¦ç»§ç»­...")
        
        await browser.close()
```

#### 3. è¿œç¨‹æ§åˆ¶è°ƒè¯•
ç³»ç»Ÿæä¾›è¿œç¨‹æ»‘å—éªŒè¯æ§åˆ¶ï¼š

```bash
# å¯åŠ¨è¿œç¨‹æ§åˆ¶æœåŠ¡
python -m utils.captcha_remote_control

# è®¿é—®æ§åˆ¶é¡µé¢
# http://localhost:8000/api/captcha/control
```

### ä½¿ç”¨Dockerè¿›è¡Œé›†æˆæµ‹è¯•

#### 1. å¼€å‘ç¯å¢ƒæµ‹è¯•
```bash
# æ„å»ºå¼€å‘é•œåƒ
docker-compose -f docker-compose.yml build

# å¯åŠ¨æµ‹è¯•ç¯å¢ƒ
docker-compose -f docker-compose.yml up -d

# æŸ¥çœ‹æ—¥å¿—
docker-compose -f docker-compose.yml logs -f

# è¿›å…¥å®¹å™¨
docker-compose -f docker-compose.yml exec xianyu-app bash
```

#### 2. ç”Ÿäº§ç¯å¢ƒæµ‹è¯•
```bash
# ä½¿ç”¨ç”Ÿäº§é•œåƒæµ‹è¯•
docker run -d \
  -p 8080:8080 \
  --restart always \
  -v $(pwd)/data:/app/data \
  -e LOG_LEVEL=DEBUG \
  -e DEBUG=true \
  xianyu-auto-reply:latest

# å¥åº·æ£€æŸ¥
curl http://localhost:8080/health
```

#### 3. ç«¯åˆ°ç«¯æµ‹è¯•
```bash
# å®Œæ•´æµ‹è¯•æµç¨‹
docker-compose -f docker-compose.yml up -d --build
sleep 30  # ç­‰å¾…æœåŠ¡å¯åŠ¨

# æ‰§è¡ŒAPIæµ‹è¯•
curl -X POST http://localhost:8080/api/test \
  -H "Content-Type: application/json" \
  -d '{"test": "integration"}'

# æ£€æŸ¥æ—¥å¿—
docker-compose -f docker-compose.yml logs xianyu-app | tail -50
```

### æ€§èƒ½æµ‹è¯•å’Œç›‘æ§

#### 1. æ€§èƒ½æŒ‡æ ‡ç›‘æ§
```python
# ç³»ç»Ÿèµ„æºç›‘æ§
import psutil
import time

def monitor_performance():
    while True:
        cpu_percent = psutil.cpu_percent()
        memory_percent = psutil.virtual_memory().percent
        disk_usage = psutil.disk_usage('/').percent
        
        print(f"CPU: {cpu_percent}%, Memory: {memory_percent}%, Disk: {disk_usage}%")
        time.sleep(10)
```

#### 2. APIæ€§èƒ½æµ‹è¯•
```bash
# ä½¿ç”¨wrkè¿›è¡Œå‹åŠ›æµ‹è¯•
wrk -t12 -c400 -d30s http://localhost:8080/api/test

# ä½¿ç”¨abè¿›è¡ŒåŸºå‡†æµ‹è¯•
ab -n 1000 -c 10 http://localhost:8080/api/test
```

#### 3. å†…å­˜æ³„æ¼æ£€æµ‹
```python
# å†…å­˜ä½¿ç”¨ç›‘æ§
import tracemalloc

def track_memory_leaks():
    tracemalloc.start()
    
    # æ‰§è¡Œæµ‹è¯•ä»£ç 
    # ...
    
    snapshot = tracemalloc.take_snapshot()
    top_stats = snapshot.statistics('lineno')
    
    print("[ Top 10 memory allocations ]")
    for stat in top_stats[:10]:
        print(stat)
```

### å¸¸è§è°ƒè¯•æŠ€å·§

#### 1. ç½‘ç»œè¯·æ±‚è°ƒè¯•
```python
# å¯ç”¨HTTPè°ƒè¯•
import http.client
http.client.HTTPConnection.debuglevel = 1

# ä½¿ç”¨requestsè°ƒè¯•
import requests
requests.get('http://localhost:8080', timeout=30)
```

#### 2. æ•°æ®åº“è°ƒè¯•
```python
# å¯ç”¨SQLAlchemyè°ƒè¯•
import logging
logging.basicConfig()
logging.getLogger('sqlalchemy.engine').setLevel(logging.INFO)

# ç›´æ¥æ‰§è¡ŒSQLæŸ¥è¯¢
from db_manager import db_manager
result = db_manager.execute_query("SELECT * FROM users LIMIT 10")
```

#### 3. å¼‚æ­¥ä»£ç è°ƒè¯•
```python
# ä½¿ç”¨asyncioè°ƒè¯•
import asyncio

async def debug_coroutine():
    try:
        # å¼‚æ­¥æ“ä½œ
        await asyncio.sleep(1)
    except Exception as e:
        print(f"å¼‚å¸¸: {e}")
        import traceback
        traceback.print_exc()

# è¿è¡Œè°ƒè¯•
asyncio.run(debug_coroutine())
```

**ç« èŠ‚æ¥æº**
- [file_log_collector.py](file://file_log_collector.py#L58-L240)
- [utils/captcha_remote_control.py](file://utils/captcha_remote_control.py#L191-L234)
- [docker-compose.yml](file://docker-compose.yml#L1-L106)

## éƒ¨ç½²å’Œå‘å¸ƒæµç¨‹

### å¼€å‘ç¯å¢ƒéƒ¨ç½²

#### 1. æœ¬åœ°éƒ¨ç½²
```bash
# 1. å…‹éš†é¡¹ç›®
git clone https://github.com/zhinianboke/xianyu-auto-reply.git
cd xianyu-auto-reply

# 2. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ
python -m venv venv
source venv/bin/activate  # Linux/macOS
# æˆ– venv\Scripts\activate  # Windows

# 3. å®‰è£…ä¾èµ–
pip install --upgrade pip
pip install -r requirements.txt

# 4. å®‰è£…Playwright
playwright install chromium
playwright install-deps chromium  # Linuxéœ€è¦

# 5. å¯åŠ¨æœåŠ¡
python Start.py
```

#### 2. Dockeréƒ¨ç½²
```bash
# å›½é™…ç‰ˆéƒ¨ç½²
docker run -d \
  -p 8080:8080 \
  --restart always \
  -v $(pwd)/data:/app/data \
  --name xianyu-auto-reply \
  zhinianblog/xianyu-auto-reply:latest

# ä¸­å›½ç‰ˆéƒ¨ç½²
docker run -d \
  -p 8080:8080 \
  --restart always \
  -v $(pwd)/data:/app/data \
  --name xianyu-auto-reply \
  registry.cn-shanghai.aliyuncs.com/zhinian-software/xianyu-auto-reply:latest
```

### ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²

#### 1. æœåŠ¡å™¨å‡†å¤‡
```bash
# UbuntuæœåŠ¡å™¨
sudo apt update
sudo apt install -y python3 python3-pip nginx certbot

# CentOSæœåŠ¡å™¨
sudo yum update
sudo yum install -y python3 python3-pip nginx certbot
```

#### 2. åº”ç”¨éƒ¨ç½²
```bash
# 1. åˆ›å»ºåº”ç”¨ç›®å½•
sudo mkdir -p /opt/xianyu-auto-reply
sudo chown $USER:$USER /opt/xianyu-auto-reply

# 2. éƒ¨ç½²åº”ç”¨
git clone https://github.com/zhinianboke/xianyu-auto-reply.git /opt/xianyu-auto-reply
cd /opt/xianyu-auto-reply

# 3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ
python3 -m venv venv
source venv/bin/activate
pip install --upgrade pip
pip install -r requirements.txt

# 4. é…ç½®ç¯å¢ƒå˜é‡
cat > /opt/xianyu-auto-reply/.env << EOF
WEB_PORT=8080
API_HOST=0.0.0.0
TZ=Asia/Shanghai
DB_PATH=/opt/xianyu-auto-reply/data/xianyu_data.db
LOG_LEVEL=INFO
EOF

# 5. å¯åŠ¨åº”ç”¨
nohup python Start.py > app.log 2>&1 &
```

#### 3. Nginxåå‘ä»£ç†é…ç½®
```nginx
server {
    listen 80;
    server_name your-domain.com;
    
    location / {
        proxy_pass http://127.0.0.1:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}

# HTTPSé…ç½®
server {
    listen 443 ssl;
    server_name your-domain.com;
    
    ssl_certificate /etc/letsencrypt/live/your-domain.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/your-domain.com/privkey.pem;
    
    location / {
        proxy_pass http://127.0.0.1:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

### CI/CDæµç¨‹

#### 1. GitHub Actionsé…ç½®
```yaml
name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - name: Set up Python
      uses: actions/setup-python@v2
      with:
        python-version: '3.11'
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        playwright install chromium
    - name: Run tests
      run: |
        pytest tests/ --cov=utils --cov-report=xml
    - name: Upload coverage
      uses: codecov/codecov-action@v2

  build:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
    - uses: actions/checkout@v2
    - name: Build Docker image
      run: |
        docker build -t xianyu-auto-reply:${GITHUB_SHA} .
        docker tag xianyu-auto-reply:${GITHUB_SHA} xianyu-auto-reply:latest
    - name: Push to Docker Hub
      run: |
        echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin
        docker push xianyu-auto-reply:${GITHUB_SHA}
        docker push xianyu-auto-reply:latest
```

#### 2. è‡ªåŠ¨éƒ¨ç½²è„šæœ¬
```bash
#!/bin/bash
# deploy.sh

set -e

# é…ç½®
APP_NAME="xianyu-auto-reply"
DOCKER_IMAGE="zhinianblog/xianyu-auto-reply"
REMOTE_SERVER="user@your-server.com"
REMOTE_PATH="/opt/xianyu-auto-reply"

echo "å¼€å§‹éƒ¨ç½² $APP_NAME..."

# 1. åœæ­¢ç°æœ‰å®¹å™¨
ssh $REMOTE_SERVER "docker stop $APP_NAME || true"
ssh $REMOTE_SERVER "docker rm $APP_NAME || true"

# 2. æ‹‰å–æœ€æ–°é•œåƒ
ssh $REMOTE_SERVER "docker pull $DOCKER_IMAGE:latest"

# 3. å¯åŠ¨æ–°å®¹å™¨
ssh $REMOTE_SERVER "docker run -d \
  --name $APP_NAME \
  --restart always \
  -p 80:8080 \
  -v $REMOTE_PATH/data:/app/data \
  -v $REMOTE_PATH/logs:/app/logs \
  -e LOG_LEVEL=INFO \
  $DOCKER_IMAGE:latest"

# 4. æ¸…ç†æ—§é•œåƒ
ssh $REMOTE_SERVER "docker image prune -f"

echo "éƒ¨ç½²å®Œæˆï¼"
```

### ç›‘æ§å’Œå‘Šè­¦

#### 1. å¥åº·æ£€æŸ¥
```python
# å¥åº·æ£€æŸ¥ç«¯ç‚¹
@app.get("/health")
async def health_check():
    """å¥åº·æ£€æŸ¥"""
    try:
        # æ£€æŸ¥æ•°æ®åº“è¿æ¥
        db_status = await db_manager.check_connection()
        
        # æ£€æŸ¥å¤–éƒ¨æœåŠ¡
        external_status = await check_external_services()
        
        return {
            "status": "healthy" if db_status and external_status else "unhealthy",
            "database": db_status,
            "external_services": external_status,
            "timestamp": datetime.utcnow().isoformat()
        }
    except Exception as e:
        return {"status": "unhealthy", "error": str(e)}
```

#### 2. ç›‘æ§æŒ‡æ ‡
```python
# PrometheusæŒ‡æ ‡
from prometheus_client import Counter, Histogram, start_http_server

# å®šä¹‰æŒ‡æ ‡
request_count = Counter('http_requests_total', 'HTTP Requests Total', ['method', 'endpoint'])
request_duration = Histogram('http_request_duration_seconds', 'HTTP Request Duration')

@app.middleware("http")
async def metrics_middleware(request, call_next):
    """HTTPè¯·æ±‚ä¸­é—´ä»¶"""
    start_time = time.time()
    
    try:
        response = await call_next(request)
        request_count.labels(method=request.method, endpoint=request.url.path).inc()
    finally:
        duration = time.time() - start_time
        request_duration.labels(method=request.method, endpoint=request.url.path).observe(duration)
    
    return response

# å¯åŠ¨ç›‘æ§æœåŠ¡å™¨
start_http_server(8000)
```

**ç« èŠ‚æ¥æº**
- [Dockerfile](file://Dockerfile#L1-L138)
- [docker-compose.yml](file://docker-compose.yml#L1-L106)
- [Start.py](file://Start.py#L446-L486)

## å¸¸è§é—®é¢˜è§£ç­”

### å¼€å‘ç¯å¢ƒé—®é¢˜

#### Q1: å¦‚ä½•è§£å†³Playwrightæµè§ˆå™¨å®‰è£…å¤±è´¥ï¼Ÿ
**A:** Playwrightæµè§ˆå™¨å®‰è£…å¤±è´¥é€šå¸¸æ˜¯ç½‘ç»œé—®é¢˜å¯¼è‡´çš„ã€‚å¯ä»¥å°è¯•ä»¥ä¸‹æ–¹æ³•ï¼š

```bash
# æ–¹æ³•1: ä½¿ç”¨å›½å†…é•œåƒæº
export PLAYWRIGHT_DOWNLOAD_HOST=https://npmmirror.com/mirrors/playwright/
playwright install chromium

# æ–¹æ³•2: æ‰‹åŠ¨ä¸‹è½½æµè§ˆå™¨
# ä¸‹è½½å¯¹åº”å¹³å°çš„æµè§ˆå™¨æ–‡ä»¶
# Windows: https://playwright.azureedge.net/builds/chromium/<version>/win64/chrome-win.zip
# Linux: https://playwright.azureedge.net/builds/chromium/<version>/linux64/chrome-linux.zip
# macOS: https://playwright.azureedge.net/builds/chromium/<version>/mac64/chrome-mac.zip

# è§£å‹åˆ°æŒ‡å®šç›®å½•
export PLAYWRIGHT_BROWSERS_PATH=/path/to/chromium
```

#### Q2: å¦‚ä½•è§£å†³ä¾èµ–å†²çªï¼Ÿ
**A:** ä½¿ç”¨è™šæ‹Ÿç¯å¢ƒéš”ç¦»ä¾èµ–ï¼š

```bash
# åˆ›å»ºæ–°çš„è™šæ‹Ÿç¯å¢ƒ
python -m venv new_env
source new_env/bin/activate  # Linux/macOS
# æˆ– new_env\Scripts\activate  # Windows

# å‡çº§pip
pip install --upgrade pip

# å®‰è£…ä¾èµ–
pip install -r requirements.txt
```

#### Q3: å¦‚ä½•è§£å†³æ•°æ®åº“è¿æ¥é—®é¢˜ï¼Ÿ
**A:** æ£€æŸ¥æ•°æ®åº“æ–‡ä»¶æƒé™å’Œè·¯å¾„ï¼š

```bash
# æ£€æŸ¥æ•°æ®ç›®å½•æƒé™
ls -la data/

# ç¡®ä¿æ•°æ®ç›®å½•å­˜åœ¨
mkdir -p data

# æ£€æŸ¥æ•°æ®åº“æ–‡ä»¶æƒé™
chmod 666 data/xianyu_data.db
```

### è¿è¡Œæ—¶é—®é¢˜

#### Q4: å¦‚ä½•å¯ç”¨è°ƒè¯•æ¨¡å¼ï¼Ÿ
**A:** è®¾ç½®ç¯å¢ƒå˜é‡å¯ç”¨è¯¦ç»†æ—¥å¿—ï¼š

```bash
# å¯ç”¨DEBUGæ—¥å¿—
export LOG_LEVEL=DEBUG
export SQL_LOG_ENABLED=true

# å¯ç”¨è¯¦ç»†è¾“å‡º
export PYTHONUNBUFFERED=1

# å¯åŠ¨åº”ç”¨
python Start.py
```

#### Q5: å¦‚ä½•è§£å†³æ»‘å—éªŒè¯é—®é¢˜ï¼Ÿ
**A:** ç³»ç»Ÿæä¾›å¤šç§æ»‘å—éªŒè¯è§£å†³æ–¹æ¡ˆï¼š

```bash
# æ–¹æ³•1: ä½¿ç”¨è¿œç¨‹æ§åˆ¶
python -m utils.captcha_remote_control

# æ–¹æ³•2: å¯ç”¨äººå·¥éªŒè¯
export CAPTCHA_ENABLED=true

# æ–¹æ³•3: ä½¿ç”¨é¢„ç¼–è¯‘äºŒè¿›åˆ¶æ¨¡å—
# ç¡®ä¿utils/ç›®å½•ä¸‹æœ‰å¯¹åº”çš„äºŒè¿›åˆ¶æ–‡ä»¶
```

#### Q6: å¦‚ä½•è§£å†³å†…å­˜ä¸è¶³é—®é¢˜ï¼Ÿ
**A:** ä¼˜åŒ–å†…å­˜ä½¿ç”¨é…ç½®ï¼š

```yaml
# global_config.yml
MEMORY_LIMIT: 1024  # é™ä½å†…å­˜é™åˆ¶
CPU_LIMIT: 1.0      # é™ä½CPUé™åˆ¶
MAX_CONCURRENT_TASKS: 2  # é™åˆ¶å¹¶å‘ä»»åŠ¡æ•°
```

### éƒ¨ç½²é—®é¢˜

#### Q7: å¦‚ä½•è§£å†³Dockeréƒ¨ç½²å¤±è´¥ï¼Ÿ
**A:** æ£€æŸ¥Dockeré…ç½®å’Œèµ„æºï¼š

```bash
# æ£€æŸ¥DockerçŠ¶æ€
docker info

# æ£€æŸ¥ç«¯å£å ç”¨
netstat -tulpn | grep :8080

# æ£€æŸ¥å·æŒ‚è½½æƒé™
ls -la data/
chmod -R 777 data/
```

#### Q8: å¦‚ä½•è§£å†³SSLè¯ä¹¦é—®é¢˜ï¼Ÿ
**A:** ä½¿ç”¨Let's Encryptè‡ªåŠ¨è·å–è¯ä¹¦ï¼š

```bash
# å®‰è£…Certbot
sudo apt install certbot python3-certbot-nginx

# è·å–è¯ä¹¦
sudo certbot --nginx -d your-domain.com

# è‡ªåŠ¨ç»­æœŸ
sudo certbot renew --dry-run
```

#### Q9: å¦‚ä½•è§£å†³æ€§èƒ½é—®é¢˜ï¼Ÿ
**A:** ä¼˜åŒ–ç³»ç»Ÿé…ç½®ï¼š

```yaml
# global_config.yml
# å¢åŠ å¹¶å‘å¤„ç†èƒ½åŠ›
MAX_CONCURRENT_REQUESTS: 100
REQUEST_TIMEOUT: 30
CACHE_ENABLED: true
CACHE_TTL: 300
```

### å¼€å‘é—®é¢˜

#### Q10: å¦‚ä½•æ·»åŠ æ–°çš„å·¥å…·å‡½æ•°ï¼Ÿ
**A:** éµå¾ªä»¥ä¸‹æ­¥éª¤ï¼š

```python
# 1. åœ¨utilsç›®å½•åˆ›å»ºæ–°æ–‡ä»¶
# utils/new_feature.py

# 2. ç¼–å†™å‡½æ•°
def new_utility_function(param1, param2):
    """
    æ–°å·¥å…·å‡½æ•°è¯´æ˜
    
    Args:
        param1: å‚æ•°1è¯´æ˜
        param2: å‚æ•°2è¯´æ˜
        
    Returns:
        è¿”å›å€¼è¯´æ˜
    """
    # å®ç°é€»è¾‘
    pass

# 3. æ·»åŠ æµ‹è¯•
# tests/utils/test_new_feature.py

# 4. æ›´æ–°æ–‡æ¡£
# README.mdå’ŒAPIæ–‡æ¡£
```

#### Q11: å¦‚ä½•æ·»åŠ æ–°çš„APIæ¥å£ï¼Ÿ
**A:** æŒ‰ç…§ä»¥ä¸‹ç»“æ„æ·»åŠ ï¼š

```python
# åœ¨reply_server.pyä¸­æ·»åŠ è·¯ç”±
from fastapi import APIRouter, Depends
from auth import get_current_user

router = APIRouter(prefix="/api", tags=["new_feature"])

@router.post("/new-endpoint")
async def new_endpoint(
    data: NewEndpointRequest,
    current_user: dict = Depends(get_current_user)
):
    """
    æ–°APIæ¥å£è¯´æ˜
    
    Args:
        data: è¯·æ±‚æ•°æ®
        current_user: å½“å‰ç”¨æˆ·
        
    Returns:
        å“åº”æ•°æ®
    """
    # å®ç°é€»è¾‘
    return {"success": True, "data": result}
```

#### Q12: å¦‚ä½•è§£å†³CI/CDé—®é¢˜ï¼Ÿ
**A:** æ£€æŸ¥GitHub Actionsé…ç½®ï¼š

```yaml
# .github/workflows/ci.yml
name: CI Checks

on: [push, pull_request]

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - name: Set up Python
      uses: actions/setup-python@v2
      with:
        python-version: '3.11'
    - name: Install dependencies
      run: |
        pip install flake8 black
    - name: Lint with flake8
      run: |
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
    - name: Format with black
      run: |
        black . --check
```

### æ€§èƒ½ä¼˜åŒ–

#### Q13: å¦‚ä½•ä¼˜åŒ–ç³»ç»Ÿæ€§èƒ½ï¼Ÿ
**A:** å¤šæ–¹é¢è¿›è¡Œä¼˜åŒ–ï¼š

```python
# 1. æ•°æ®åº“ä¼˜åŒ–
from db_manager import db_manager
db_manager.enable_pragma_optimization()

# 2. ç¼“å­˜ä¼˜åŒ–
from redis import Redis
redis_client = Redis.from_url("redis://localhost")

# 3. å¹¶å‘ä¼˜åŒ–
import asyncio
asyncio.set_event_loop_policy(asyncio.DefaultEventLoopPolicy())

# 4. å†…å­˜ä¼˜åŒ–
import gc
gc.collect()
```

#### Q14: å¦‚ä½•ç›‘æ§ç³»ç»Ÿæ€§èƒ½ï¼Ÿ
**A:** ä½¿ç”¨æ€§èƒ½ç›‘æ§å·¥å…·ï¼š

```python
# æ€§èƒ½ç›‘æ§è£…é¥°å™¨
import time
from functools import wraps

def monitor_performance(func):
    @wraps(func)
    def wrapper(*args, **kwargs):
        start_time = time.time()
        result = func(*args, **kwargs)
        duration = time.time() - start_time
        
        print(f"{func.__name__} took {duration:.2f}s")
        return result
    return wrapper
```

**ç« èŠ‚æ¥æº**
- [Start.py](file://Start.py#L146-L400)
- [utils/captcha_remote_control.py](file://utils/captcha_remote_control.py#L191-L234)
- [global_config.yml](file://global_config.yml#L1-L77)