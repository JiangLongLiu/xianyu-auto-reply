# 开发环境搭建指南

<cite>
**本文档引用的文件**
- [README.md](file://README.md)
- [requirements.txt](file://requirements.txt)
- [Start.py](file://Start.py)
- [global_config.yml](file://global_config.yml)
- [docker-compose.yml](file://docker-compose.yml)
- [Dockerfile](file://Dockerfile)
- [config.py](file://config.py)
</cite>

## 目录
1. [简介](#简介)
2. [系统要求](#系统要求)
3. [Python环境配置](#python环境配置)
4. [Node.js环境配置](#nodejs环境配置)
5. [Playwright浏览器安装](#playwright浏览器安装)
6. [依赖包安装](#依赖包安装)
7. [环境变量配置](#环境变量配置)
8. [Docker开发环境](#docker开发环境)
9. [平台特定配置](#平台特定配置)
10. [环境验证](#环境验证)
11. [故障排除](#故障排除)

## 简介

本指南详细介绍了闲鱼自动回复系统的本地开发环境搭建过程。该系统采用Python 3.11+作为主要开发语言，使用FastAPI框架提供Web服务，并集成了Playwright浏览器自动化技术来实现闲鱼平台的自动交互功能。

## 系统要求

### 基础要求
- **Python**: 3.11+ (推荐使用3.11.x版本)
- **Node.js**: 16+ (用于JavaScript代码执行)
- **操作系统**: Windows/Linux/macOS
- **架构**: x86_64 (amd64) / ARM64 (aarch64)
- **内存**: 建议2GB+
- **存储**: 建议10GB+

### 开发工具
- Git (用于代码版本控制)
- 文本编辑器或IDE (如VS Code、PyCharm)
- 终端/命令行工具

## Python环境配置

### Python安装

#### Windows系统
1. 从[Python官网](https://www.python.org/downloads/)下载Python 3.11+安装包
2. 运行安装程序，勾选"Add Python 3.x to PATH"选项
3. 安装完成后验证安装：
```cmd
python --version
pip --version
```

#### Linux系统
大多数Linux发行版自带Python，但需要确保版本符合要求：

```bash
# Ubuntu/Debian
sudo apt update
sudo apt install python3.11 python3.11-venv python3.11-pip

# CentOS/RHEL/Fedora
sudo yum install python3.11 python3.11-virtualenv python3.11-pip
# 或
sudo dnf install python3.11 python3.11-virtualenv python3.11-pip

# 检查版本
python3.11 --version
```

#### macOS系统
```bash
# 使用Homebrew安装
brew install python@3.11

# 或使用官方安装包
# 从Python官网下载并安装
```

### 虚拟环境创建

推荐为项目创建独立的虚拟环境：

```bash
# 创建虚拟环境
python -m venv venv

# 激活虚拟环境
# Windows
venv\Scripts\activate
# Linux/macOS
source venv/bin/activate
```

## Node.js环境配置

### Node.js安装

#### Windows系统
1. 从[Node.js官网](https://nodejs.org/)下载LTS版本安装包
2. 运行安装程序，默认设置即可
3. 验证安装：
```cmd
node --version
npm --version
```

#### Linux系统
```bash
# Ubuntu/Debian
curl -fsSL https://deb.nodesource.com/setup_lts.x | sudo -E bash -
sudo apt-get install -y nodejs

# CentOS/RHEL/Fedora
curl -fsSL https://rpm.nodesource.com/setup_lts.x | sudo bash -
sudo yum install -y nodejs

# 检查版本
node --version
```

#### macOS系统
```bash
# 使用Homebrew
brew install node

# 或使用官方安装包
# 从Node.js官网下载并安装
```

## Playwright浏览器安装

Playwright是系统的核心组件，用于模拟浏览器行为来与闲鱼平台交互。

### 基础安装

```bash
# 安装Playwright Chromium浏览器
playwright install chromium
```

### Linux系统额外依赖

对于Linux系统，需要安装额外的系统依赖：

```bash
# Ubuntu/Debian
sudo apt-get install -y \
    libnss3 \
    libatk-bridge2.0-0 \
    libdrm2 \
    libxkbcommon0 \
    libxcomposite1 \
    libxdamage1 \
    libxrandr2 \
    libgbm1 \
    libxss1 \
    libasound2 \
    libgtk-3-0 \
    libgdk-pixbuf2.0-0 \
    libxcursor1 \
    libxi6 \
    libxrender1 \
    libxext6 \
    libx11-6 \
    libxft2 \
    libxinerama1 \
    libxtst6 \
    libappindicator3-1 \
    libx11-xcb1 \
    libxfixes3 \
    xdg-utils \
    xvfb \
    chromium \
    x11vnc \
    fluxbox

# 安装Playwright系统依赖
playwright install-deps chromium
```

### Windows系统注意事项

Windows系统通常不需要额外安装系统依赖，但如果遇到问题，可以尝试：

```cmd
# 检查Windows版本兼容性
# 确保系统满足最低要求
```

### 验证安装

```bash
# 验证Playwright安装
playwright --version

# 测试浏览器启动
playwright show-trace <trace-file>
```

## 依赖包安装

### 安装步骤

```bash
# 升级pip到最新版本
pip install --upgrade pip

# 安装项目依赖
pip install -r requirements.txt
```

### 依赖包说明

根据`requirements.txt`文件，系统需要以下主要依赖包：

| 组件类别 | 主要包 | 版本要求 | 功能描述 |
|---------|--------|----------|----------|
| Web框架 | fastapi | >=0.111.0 | 主要Web框架 |
| Web框架 | uvicorn | >=0.29.0 | ASGI服务器 |
| 日志记录 | loguru | >=0.7.0 | 结构化日志 |
| 网络通信 | websockets | >=10.0,<13.0 | WebSocket支持 |
| 网络通信 | aiohttp | >=3.9.0 | 异步HTTP客户端 |
| 配置处理 | PyYAML | >=6.0.0 | YAML配置文件解析 |
| JavaScript引擎 | PyExecJS | >=1.5.1 | JavaScript代码执行 |
| 图像处理 | Pillow | >=10.0.0 | 图像处理和二维码生成 |
| 浏览器自动化 | playwright | >=1.40.0 | 浏览器自动化 |

### 可选依赖

系统还提供了可选的性能优化依赖：

```bash
# 用于编译性能关键模块（可选）
pip install nuitka>=2.7 ordered-set>=4.1.0 zstandard>=0.22.0
```

## 环境变量配置

系统支持通过环境变量覆盖`global_config.yml`中的默认设置。

### 基础配置变量

```bash
# Web服务配置
WEB_PORT=8080
API_HOST=0.0.0.0
TZ=Asia/Shanghai

# 数据库配置
DB_PATH=data/xianyu_data.db

# 管理员配置
ADMIN_USERNAME=admin
ADMIN_PASSWORD=admin123
JWT_SECRET_KEY=your-secret-key

# 功能开关
AUTO_REPLY_ENABLED=true
AUTO_DELIVERY_ENABLED=true
AI_REPLY_ENABLED=false

# 日志配置
LOG_LEVEL=INFO
SQL_LOG_ENABLED=true

# 资源限制
MEMORY_LIMIT=2048
CPU_LIMIT=2.0
```

### Docker环境变量

在Docker环境中，可以通过以下方式设置环境变量：

```yaml
# docker-compose.yml中的环境变量配置
environment:
  - WEB_PORT=8080
  - API_HOST=0.0.0.0
  - TZ=Asia/Shanghai
  - DB_PATH=/app/data/xianyu_data.db
  - LOG_LEVEL=INFO
```

### 配置文件优先级

系统按照以下优先级加载配置：
1. 环境变量
2. `global_config.yml`配置文件
3. 默认值

## Docker开发环境

### Docker安装

#### Windows系统
1. 下载[Docker Desktop](https://www.docker.com/products/docker-desktop)
2. 运行安装程序，按照向导完成安装
3. 启动Docker Desktop

#### Linux系统
```bash
# Ubuntu/Debian
curl -fsSL https://get.docker.com -o get-docker.sh
sudo sh get-docker.sh

# CentOS/RHEL/Fedora
sudo yum install docker-ce docker-ce-cli containerd.io

# 启动Docker服务
sudo systemctl start docker
sudo systemctl enable docker
```

#### macOS系统
1. 下载[Docker Desktop](https://www.docker.com/products/docker-desktop)
2. 运行安装程序，按照向导完成安装
3. 启动Docker Desktop

### Docker Compose安装

#### Windows和macOS
Docker Desktop通常包含Docker Compose，无需单独安装。

#### Linux系统
```bash
# 下载Docker Compose
sudo curl -L "https://github.com/docker/compose/releases/download/v2.20.2/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
sudo chmod +x /usr/local/bin/docker-compose
```

### 构建和启动

#### 国际版构建
```bash
# 克隆项目
git clone https://github.com/zhinianboke/xianyu-auto-reply.git
cd xianyu-auto-reply

# 使用完整版配置构建
docker-compose up -d --build
```

#### 中国版构建（推荐国内用户）
```bash
# 使用中国镜像源配置
docker-compose -f docker-compose-cn.yml up -d --build
```

### Docker服务管理

```bash
# 启动服务
docker-compose up -d

# 停止服务
docker-compose down

# 查看日志
docker-compose logs -f

# 重建服务
docker-compose up -d --force-recreate --build

# 查看容器状态
docker-compose ps
```

### Docker部署脚本

系统提供了跨平台的部署脚本：

```bash
# Linux/macOS
./docker-deploy.sh

# Windows
docker-deploy.bat
```

## 平台特定配置

### Windows控制台UTF-8编码设置

Windows系统可能存在编码问题，系统在`Start.py`中自动处理：

```python
# Windows UTF-8编码设置
if sys.platform == 'win32':
    # 设置环境变量
    os.environ['PYTHONIOENCODING'] = 'utf-8'
    
    # 设置控制台代码页为UTF-8
    try:
        import ctypes
        kernel32 = ctypes.windll.kernel32
        kernel32.SetConsoleOutputCP(65001)  # UTF-8代码页
    except Exception:
        pass
```

### Linux系统注意事项

1. **事件循环策略**：Linux系统需要正确设置异步事件循环策略
2. **权限问题**：确保Docker容器有足够的权限访问必要资源
3. **防火墙配置**：确保8080端口开放

### macOS系统注意事项

1. **系统完整性保护**：可能需要允许某些系统权限
2. **沙盒限制**：注意macOS的沙盒限制可能影响某些功能
3. **硬件兼容性**：确保M1/M2芯片的兼容性

## 环境验证

### 启动服务

```bash
# 方法1：直接运行Python脚本
python Start.py

# 方法2：使用Docker
docker-compose up -d
```

### 访问验证

1. 打开浏览器访问：http://localhost:8080
2. 预期结果：
   - 显示Web管理界面
   - 可以正常登录（默认账号：admin/admin123）
   - API文档可用（http://localhost:8080/docs）

### 功能验证

1. **登录功能**：使用默认管理员账号登录
2. **WebSocket连接**：检查控制台是否有WebSocket连接成功的日志
3. **Playwright功能**：验证浏览器自动化功能是否正常
4. **数据库连接**：检查数据库文件是否正确创建

### 日志检查

```bash
# 查看启动日志
docker-compose logs -f

# 或查看本地日志文件
tail -f logs/app.log
```

## 故障排除

### 常见问题及解决方案

#### 1. Python版本不兼容
**问题**：`SyntaxError: invalid syntax` 或 `ModuleNotFoundError`
**解决方案**：
```bash
# 检查Python版本
python --version

# 确保使用Python 3.11+
python3.11 --version
```

#### 2. Playwright安装失败
**问题**：`playwright install` 命令执行失败
**解决方案**：
```bash
# 清理Playwright缓存
playwright uninstall chromium

# 重新安装
playwright install chromium
playwright install-deps chromium  # Linux系统

# 或使用Docker自动安装
docker-compose up -d --build
```

#### 3. 端口冲突
**问题**：`Address already in use` 错误
**解决方案**：
```bash
# 查找占用端口的进程
# Windows
netstat -ano | findstr :8080

# Linux/macOS
lsof -i :8080

# 修改端口配置
export WEB_PORT=8081
python Start.py
```

#### 4. 权限问题
**问题**：`Permission denied` 错误
**解决方案**：
```bash
# Linux/macOS
chmod +x Start.py
chmod +x entrypoint.sh

# 或使用Docker避免权限问题
docker-compose up -d
```

#### 5. 网络连接问题
**问题**：WebSocket连接失败
**解决方案**：
1. 检查防火墙设置
2. 确保网络连接正常
3. 验证代理设置

### 调试技巧

1. **启用调试模式**：
```bash
export LOG_LEVEL=DEBUG
python Start.py
```

2. **检查依赖安装**：
```bash
pip list | grep -E "(fastapi|playwright|uvicorn)"
```

3. **验证配置文件**：
```bash
python -c "from config import config; print(config.config)"
```

### 获取帮助

如果遇到无法解决的问题，可以：

1. 查看项目[README.md](file://README.md)文档
2. 检查[Dockerfile](file://Dockerfile)中的详细配置
3. 参考[Start.py](file://Start.py)中的启动逻辑
4. 在项目Issue中寻求帮助