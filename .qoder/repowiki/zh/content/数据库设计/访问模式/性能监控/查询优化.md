# æŸ¥è¯¢ä¼˜åŒ–

<cite>
**æœ¬æ–‡æ¡£å¼•ç”¨çš„æ–‡ä»¶**
- [db_manager.py](file://db_manager.py)
- [config.py](file://config.py)
- [simple_stats_server.py](file://simple_stats_server.py)
</cite>

## ç›®å½•
1. [ç®€ä»‹](#ç®€ä»‹)
2. [æ•°æ®åº“æ¶æ„æ¦‚è¿°](#æ•°æ®åº“æ¶æ„æ¦‚è¿°)
3. [å¸¸è§æŸ¥è¯¢æ¨¡å¼åˆ†æ](#å¸¸è§æŸ¥è¯¢æ¨¡å¼åˆ†æ)
4. [EXPLAINè¯­å¥åˆ†ææŸ¥è¯¢æ‰§è¡Œè®¡åˆ’](#explainè¯­å¥åˆ†ææŸ¥è¯¢æ‰§è¡Œè®¡åˆ’)
5. [ç´¢å¼•ä¼˜åŒ–ç­–ç•¥](#ç´¢å¼•ä¼˜åŒ–ç­–ç•¥)
6. [å¤æ‚æŸ¥è¯¢ä¼˜åŒ–ç¤ºä¾‹](#å¤æ‚æŸ¥è¯¢ä¼˜åŒ–ç¤ºä¾‹)
7. [æŸ¥è¯¢é‡æ„ä¸æ€§èƒ½ä¼˜åŒ–](#æŸ¥è¯¢é‡æ„ä¸æ€§èƒ½ä¼˜åŒ–)
8. [æ€§èƒ½ç›‘æ§ä¸è¯Šæ–­](#æ€§èƒ½ç›‘æ§ä¸è¯Šæ–­)
9. [æœ€ä½³å®è·µå»ºè®®](#æœ€ä½³å®è·µå»ºè®®)
10. [æ€»ç»“](#æ€»ç»“)

## ç®€ä»‹

æœ¬æ–‡æ¡£åŸºäº`db_manager.py`ä¸­çš„å®é™…æŸ¥è¯¢æ–¹æ³•ï¼Œæ·±å…¥åˆ†ææ•°æ®åº“æŸ¥è¯¢æ€§èƒ½ä¼˜åŒ–æŠ€æœ¯ã€‚é€šè¿‡åˆ†æé¡¹ç›®ä¸­çš„å…·ä½“æŸ¥è¯¢åœºæ™¯ï¼Œæä¾›å®ç”¨çš„ä¼˜åŒ–ç­–ç•¥å’Œæœ€ä½³å®è·µï¼Œå¸®åŠ©å¼€å‘è€…è¯†åˆ«æ€§èƒ½ç“¶é¢ˆå¹¶æå‡æ•°æ®åº“æŸ¥è¯¢æ•ˆç‡ã€‚

## æ•°æ®åº“æ¶æ„æ¦‚è¿°

è¯¥é¡¹ç›®é‡‡ç”¨SQLiteæ•°æ®åº“ï¼Œä¸»è¦åŒ…å«ä»¥ä¸‹æ ¸å¿ƒè¡¨ç»“æ„ï¼š

```mermaid
erDiagram
USERS {
integer id PK
string username UK
string email UK
string password_hash
boolean is_active
timestamp created_at
timestamp updated_at
}
COOKIES {
string id PK
text value
integer user_id FK
integer auto_confirm
text remark
integer pause_duration
text username
text password
integer show_browser
timestamp created_at
}
KEYWORDS {
string cookie_id FK
text keyword
text reply
text item_id
text type
text image_url
}
ORDERS {
string order_id PK
text item_id
text buyer_id
text spec_name
text spec_value
text quantity
text amount
text order_status
string cookie_id FK
timestamp created_at
timestamp updated_at
}
ITEM_INFO {
integer id PK
string cookie_id FK
string item_id
text item_title
text item_description
text item_category
text item_price
text item_detail
boolean is_multi_spec
timestamp created_at
timestamp updated_at
}
AI_REPLY_SETTINGS {
string cookie_id PK
boolean ai_enabled
text model_name
text api_key
text base_url
integer max_discount_percent
integer max_discount_amount
integer max_bargain_rounds
text custom_prompts
timestamp created_at
timestamp updated_at
}
USERS ||--o{ COOKIES : "belongs to"
COOKIES ||--o{ KEYWORDS : "has"
COOKIES ||--o{ ORDERS : "generates"
COOKIES ||--o{ ITEM_INFO : "manages"
COOKIES ||--|| AI_REPLY_SETTINGS : "configured by"
```

**å›¾è¡¨æ¥æº**
- [db_manager.py](file://db_manager.py#L74-L234)

**èŠ‚æ¥æº**
- [db_manager.py](file://db_manager.py#L74-L234)

## å¸¸è§æŸ¥è¯¢æ¨¡å¼åˆ†æ

### é€šè¿‡cookie_idè¿›è¡Œæ•°æ®æ£€ç´¢

é¡¹ç›®ä¸­æœ€é¢‘ç¹çš„æŸ¥è¯¢æ¨¡å¼æ˜¯åŸºäºcookie_idçš„æ•°æ®æ£€ç´¢ï¼Œä¸»è¦ç”¨äºï¼š

#### 1. è·å–Cookieè¯¦ç»†ä¿¡æ¯
```python
# æŸ¥è¯¢ç¤ºä¾‹ï¼šè·å–å•ä¸ªCookieçš„è¯¦ç»†ä¿¡æ¯
cursor.execute("SELECT id, value, user_id, auto_confirm, remark, pause_duration FROM cookies WHERE id = ?", (cookie_id,))
```

#### 2. è·å–å…³é”®å­—åˆ—è¡¨
```python
# æŸ¥è¯¢ç¤ºä¾‹ï¼šè·å–ç‰¹å®šCookieçš„æ‰€æœ‰å…³é”®å­—
cursor.execute("SELECT keyword, reply, item_id, type FROM keywords WHERE cookie_id = ?", (cookie_id,))
```

#### 3. è·å–è®¢å•ä¿¡æ¯
```python
# æŸ¥è¯¢ç¤ºä¾‹ï¼šè·å–ç‰¹å®šCookieçš„è®¢å•åˆ—è¡¨
cursor.execute("SELECT order_id, item_id, buyer_id, spec_name, spec_value FROM orders WHERE cookie_id = ? ORDER BY created_at DESC LIMIT ?", (cookie_id, limit))
```

### é€šè¿‡user_idè¿›è¡Œæ•°æ®æ£€ç´¢

```python
# æŸ¥è¯¢ç¤ºä¾‹ï¼šè·å–ç”¨æˆ·çš„æ‰€æœ‰Cookie
cursor.execute("SELECT id, value FROM cookies WHERE user_id = ?", (user_id,))
```

**èŠ‚æ¥æº**
- [db_manager.py](file://db_manager.py#L1213-L1237)
- [db_manager.py](file://db_manager.py#L3885-L3918)
- [db_manager.py](file://db_manager.py#L4507-L4538)

## EXPLAINè¯­å¥åˆ†ææŸ¥è¯¢æ‰§è¡Œè®¡åˆ’

### SQLite EXPLAIN QUERY PLAN

SQLiteæä¾›äº†`EXPLAIN QUERY PLAN`è¯­å¥æ¥åˆ†ææŸ¥è¯¢æ‰§è¡Œè®¡åˆ’ï¼š

```sql
EXPLAIN QUERY PLAN SELECT * FROM cookies WHERE id = 'some_cookie_id';
```

### æŸ¥è¯¢æ‰§è¡Œè®¡åˆ’åˆ†æè¦ç‚¹

1. **å…¨è¡¨æ‰«æè¯†åˆ«**ï¼šå½“æ‰§è¡Œè®¡åˆ’æ˜¾ç¤º`SCAN TABLE`æ—¶ï¼Œè¡¨ç¤ºè¿›è¡Œäº†å…¨è¡¨æ‰«æ
2. **ç´¢å¼•ä½¿ç”¨æƒ…å†µ**ï¼šæ£€æŸ¥æ˜¯å¦ä½¿ç”¨äº†é€‚å½“çš„ç´¢å¼•æ¥åŠ é€ŸæŸ¥è¯¢
3. **æŸ¥è¯¢æˆæœ¬ä¼°ç®—**ï¼šå…³æ³¨SQLiteä¼°ç®—çš„æŸ¥è¯¢æˆæœ¬å€¼

### å®é™…æŸ¥è¯¢åˆ†æç¤ºä¾‹

#### ä½æ•ˆæŸ¥è¯¢ï¼ˆæ— ç´¢å¼•ï¼‰
```sql
-- ä½æ•ˆæŸ¥è¯¢ï¼šæ²¡æœ‰ç´¢å¼•çš„WHEREæ¡ä»¶
EXPLAIN QUERY PLAN SELECT * FROM cookies WHERE user_id = 1;
```

#### é«˜æ•ˆæŸ¥è¯¢ï¼ˆä½¿ç”¨ç´¢å¼•ï¼‰
```sql
-- é«˜æ•ˆæŸ¥è¯¢ï¼šä½¿ç”¨äº†idx_cards_user_idç´¢å¼•
EXPLAIN QUERY PLAN SELECT * FROM cards WHERE user_id = 1;
```

**èŠ‚æ¥æº**
- [db_manager.py](file://db_manager.py#L243-L245)

## ç´¢å¼•ä¼˜åŒ–ç­–ç•¥

### ç°æœ‰ç´¢å¼•åˆ†æ

é¡¹ç›®ä¸­å·²ç»å®ç°äº†å¤šä¸ªå…³é”®ç´¢å¼•ï¼š

```mermaid
graph TD
A[æ•°æ®åº“ç´¢å¼•ç­–ç•¥] --> B[ä¸»é”®ç´¢å¼•]
A --> C[å¤–é”®ç´¢å¼•]
A --> D[å¤åˆç´¢å¼•]
A --> E[å”¯ä¸€ç´¢å¼•]
B --> B1[PRIMARY KEY]
B --> B2[è‡ªåŠ¨åˆ›å»ºçš„ä¸»é”®ç´¢å¼•]
C --> C1[FOREIGN KEY]
C --> C2[å¤–é”®çº¦æŸè‡ªåŠ¨åˆ›å»ºç´¢å¼•]
D --> D1[å¤åˆç´¢å¼•]
D --> D2[å¤šåˆ—ç»„åˆç´¢å¼•]
E --> E1[UNIQUEçº¦æŸ]
E --> E2[å”¯ä¸€æ€§ä¿è¯]
```

### å…³é”®ç´¢å¼•å®ç°

#### 1. ç”¨æˆ·IDç´¢å¼•
```python
# åœ¨cardsè¡¨ä¸Šåˆ›å»ºuser_idç´¢å¼•
self._execute_sql(cursor, "CREATE INDEX IF NOT EXISTS idx_cards_user_id ON cards(user_id)")
```

#### 2. å…³é”®å­—å”¯ä¸€ç´¢å¼•
```python
# åˆ›å»ºå¤åˆå”¯ä¸€ç´¢å¼•
cursor.execute('''
CREATE UNIQUE INDEX idx_keywords_unique_with_item
ON keywords(cookie_id, keyword, item_id)
WHERE item_id IS NOT NULL AND item_id != ''
''')
```

#### 3. ç»Ÿè®¡æœåŠ¡ç´¢å¼•
```python
# åœ¨ç»Ÿè®¡æœåŠ¡ä¸­åˆ›å»ºçš„ç´¢å¼•
cursor.execute('CREATE INDEX IF NOT EXISTS idx_anonymous_id ON user_stats(anonymous_id)')
cursor.execute('CREATE INDEX IF NOT EXISTS idx_last_seen ON user_stats(last_seen)')
```

### ç´¢å¼•ä¼˜åŒ–å»ºè®®

#### 1. æ·»åŠ ç¼ºå¤±ç´¢å¼•
```sql
-- ä¸ºé¢‘ç¹æŸ¥è¯¢çš„å­—æ®µæ·»åŠ ç´¢å¼•
CREATE INDEX idx_cookies_user_id ON cookies(user_id);
CREATE INDEX idx_keywords_cookie_id ON keywords(cookie_id);
CREATE INDEX idx_orders_cookie_id ON orders(cookie_id);
CREATE INDEX idx_item_info_cookie_id ON item_info(cookie_id);
```

#### 2. å¤åˆç´¢å¼•è®¾è®¡
```sql
-- è®¾è®¡å¤åˆç´¢å¼•ä»¥æ”¯æŒå¤šæ¡ä»¶æŸ¥è¯¢
CREATE INDEX idx_orders_status_created ON orders(order_status, created_at);
CREATE INDEX idx_ai_conversations_chat_item ON ai_conversations(chat_id, item_id);
```

**èŠ‚æ¥æº**
- [db_manager.py](file://db_manager.py#L243-L245)
- [db_manager.py](file://db_manager.py#L1078-L1083)
- [simple_stats_server.py](file://simple_stats_server.py#L48-L49)

## å¤æ‚æŸ¥è¯¢ä¼˜åŒ–ç¤ºä¾‹

### å¤šè¡¨è¿æ¥æŸ¥è¯¢ä¼˜åŒ–

#### ä¼˜åŒ–å‰ï¼šåµŒå¥—å­æŸ¥è¯¢
```sql
-- ä½æ•ˆæŸ¥è¯¢ï¼šå¤šæ¬¡åµŒå¥—å­æŸ¥è¯¢
SELECT c.id, c.value, k.keyword, k.reply
FROM cookies c
LEFT JOIN keywords k ON c.id = k.cookie_id
WHERE c.user_id = ?
AND k.keyword LIKE ?
ORDER BY c.created_at DESC
LIMIT 100;
```

#### ä¼˜åŒ–åï¼šåˆç†ä½¿ç”¨ç´¢å¼•å’Œè¿æ¥
```sql
-- é«˜æ•ˆæŸ¥è¯¢ï¼šåˆ©ç”¨ç´¢å¼•å’Œé€‚å½“è¿æ¥
SELECT c.id, c.value, k.keyword, k.reply
FROM cookies c
LEFT JOIN keywords k ON c.id = k.cookie_id
WHERE c.user_id = ?
AND k.keyword LIKE ?
AND c.id IN (SELECT cookie_id FROM keywords WHERE keyword LIKE ?)
ORDER BY c.created_at DESC
LIMIT 100;
```

### åˆ†é¡µæŸ¥è¯¢ä¼˜åŒ–

#### ä¼ ç»Ÿåˆ†é¡µé—®é¢˜
```sql
-- ä¼ ç»Ÿåˆ†é¡µï¼šéšç€åç§»é‡å¢å¤§æ€§èƒ½ä¸‹é™
SELECT * FROM orders 
WHERE cookie_id = ? 
ORDER BY created_at DESC 
LIMIT 100 OFFSET 10000;
```

#### ä¼˜åŒ–æ–¹æ¡ˆï¼šåŸºäºæ¸¸æ ‡çš„åˆ†é¡µ
```sql
-- åŸºäºæ¸¸æ ‡çš„åˆ†é¡µï¼šæ€§èƒ½ç¨³å®š
SELECT * FROM orders 
WHERE cookie_id = ? 
AND created_at < ? 
ORDER BY created_at DESC 
LIMIT 100;
```

### å¤§æ•°æ®é‡æŸ¥è¯¢ä¼˜åŒ–

#### åœºæ™¯ï¼šè·å–å¤§é‡è®¢å•æ•°æ®
```python
# ä¼˜åŒ–å‰ï¼šä¸€æ¬¡æ€§åŠ è½½æ‰€æœ‰æ•°æ®
def get_all_orders_old(cookie_id: str):
    cursor.execute("SELECT * FROM orders WHERE cookie_id = ?", (cookie_id,))
    return cursor.fetchall()

# ä¼˜åŒ–åï¼šåˆ†æ‰¹åŠ è½½æ•°æ®
def get_orders_paginated(cookie_id: str, page_size: int = 1000):
    offset = 0
    while True:
        cursor.execute("""
            SELECT * FROM orders 
            WHERE cookie_id = ? 
            ORDER BY created_at DESC 
            LIMIT ? OFFSET ?
        """, (cookie_id, page_size, offset))
        
        batch = cursor.fetchall()
        if not batch:
            break
            
        yield batch
        offset += page_size
```

**èŠ‚æ¥æº**
- [db_manager.py](file://db_manager.py#L4507-L4538)

## æŸ¥è¯¢é‡æ„ä¸æ€§èƒ½ä¼˜åŒ–

### æŸ¥è¯¢é‡æ„åŸåˆ™

```mermaid
flowchart TD
A[æŸ¥è¯¢æ€§èƒ½ä¼˜åŒ–] --> B[æŸ¥è¯¢åˆ†æ]
B --> C[è¯†åˆ«ç“¶é¢ˆ]
C --> D[é‡æ„ç­–ç•¥]
D --> E[å®æ–½ä¼˜åŒ–]
E --> F[æ€§èƒ½éªŒè¯]
B --> B1[EXPLAINåˆ†æ]
B --> B2[æ…¢æŸ¥è¯¢æ—¥å¿—]
B --> B3[æ€§èƒ½ç›‘æ§]
C --> C1[å…¨è¡¨æ‰«æ]
C --> C2[ç¼ºå°‘ç´¢å¼•]
C --> C3[å¤æ‚è¿æ¥]
C --> C4[å¤§æ•°æ®é‡]
D --> D1[ç´¢å¼•ä¼˜åŒ–]
D --> D2[æŸ¥è¯¢é‡å†™]
D --> D3[åˆ†é¡µä¼˜åŒ–]
D --> D4[ç¼“å­˜ç­–ç•¥]
E --> E1[æµ‹è¯•éªŒè¯]
E --> E2[ç›‘æ§è·Ÿè¸ª]
F --> F1[æ€§èƒ½æŒ‡æ ‡]
F --> F2[ç”¨æˆ·ä½“éªŒ]
```

### å…·ä½“ä¼˜åŒ–æ¡ˆä¾‹

#### 1. CookieçŠ¶æ€æŸ¥è¯¢ä¼˜åŒ–
```python
# ä¼˜åŒ–å‰ï¼šå¤šæ¬¡æŸ¥è¯¢
def get_cookie_status_old(cookie_id: str):
    # æŸ¥è¯¢CookieåŸºæœ¬ä¿¡æ¯
    cursor.execute("SELECT * FROM cookies WHERE id = ?", (cookie_id,))
    cookie = cursor.fetchone()
    
    # æŸ¥è¯¢CookieçŠ¶æ€
    cursor.execute("SELECT enabled FROM cookie_status WHERE cookie_id = ?", (cookie_id,))
    status = cursor.fetchone()
    
    return {"cookie": cookie, "status": status}

# ä¼˜åŒ–åï¼šå•æ¬¡è¿æ¥æŸ¥è¯¢
def get_cookie_status_optimized(cookie_id: str):
    cursor.execute("""
        SELECT c.*, cs.enabled 
        FROM cookies c 
        LEFT JOIN cookie_status cs ON c.id = cs.cookie_id 
        WHERE c.id = ?
    """, (cookie_id,))
    return cursor.fetchone()
```

#### 2. AIè®¾ç½®æŸ¥è¯¢ä¼˜åŒ–
```python
# ä¼˜åŒ–å‰ï¼šå¤šä¸ªå­—æ®µåˆ†åˆ«æŸ¥è¯¢
def get_ai_settings_old(cookie_id: str):
    cursor.execute("SELECT ai_enabled FROM ai_reply_settings WHERE cookie_id = ?", (cookie_id,))
    enabled = cursor.fetchone()
    
    cursor.execute("SELECT model_name FROM ai_reply_settings WHERE cookie_id = ?", (cookie_id,))
    model = cursor.fetchone()
    
    # ... å…¶ä»–å­—æ®µæŸ¥è¯¢
    
    return {"enabled": enabled, "model": model, ...}

# ä¼˜åŒ–åï¼šå•æ¬¡æŸ¥è¯¢è·å–æ‰€æœ‰å­—æ®µ
def get_ai_settings_optimized(cookie_id: str):
    cursor.execute("""
        SELECT ai_enabled, model_name, api_key, base_url,
               max_discount_percent, max_discount_amount, max_bargain_rounds,
               custom_prompts
        FROM ai_reply_settings WHERE cookie_id = ?
    """, (cookie_id,))
    result = cursor.fetchone()
    # è¿”å›å­—å…¸ç»“æ„
```

### ç¼“å­˜ç­–ç•¥

#### Redisç¼“å­˜é›†æˆ
```python
import redis
import json

# ç¼“å­˜ç®¡ç†å™¨
class QueryCache:
    def __init__(self):
        self.redis_client = redis.Redis(host='localhost', port=6379, db=0)
    
    def get_cached_query(self, cache_key: str, ttl: int = 300):
        cached_data = self.redis_client.get(cache_key)
        if cached_data:
            return json.loads(cached_data)
        return None
    
    def set_cached_query(self, cache_key: str, data: dict, ttl: int = 300):
        self.redis_client.setex(cache_key, ttl, json.dumps(data))
```

**èŠ‚æ¥æº**
- [db_manager.py](file://db_manager.py#L1796-L1843)
- [db_manager.py](file://db_manager.py#L1240-L1264)

## æ€§èƒ½ç›‘æ§ä¸è¯Šæ–­

### SQLæ—¥å¿—é…ç½®

é¡¹ç›®å†…ç½®äº†è¯¦ç»†çš„SQLæ—¥å¿—åŠŸèƒ½ï¼š

```python
# SQLæ—¥å¿—é…ç½®
self.sql_log_enabled = True  # é»˜è®¤å¯ç”¨SQLæ—¥å¿—
self.sql_log_level = 'INFO'  # é»˜è®¤ä½¿ç”¨INFOçº§åˆ«

# æ—¥å¿—è®°å½•å‡½æ•°
def _log_sql(self, sql: str, params: tuple = None, operation: str = "EXECUTE"):
    if not self.sql_log_enabled:
        return
        
    # æ ¼å¼åŒ–SQLå’Œå‚æ•°
    formatted_sql = ' '.join(sql.split())
    params_str = f" | å‚æ•°: [{', '.join(formatted_params)}]" if params else ""
    
    log_message = f"ğŸ—„ï¸ SQL {operation}: {formatted_sql}{params_str}"
    
    # æ ¹æ®é…ç½®çš„æ—¥å¿—çº§åˆ«è¾“å‡º
    if self.sql_log_level == 'DEBUG':
        logger.debug(log_message)
    elif self.sql_log_level == 'INFO':
        logger.info(log_message)
    elif self.sql_log_level == 'WARNING':
        logger.warning(log_message)
```

### æ€§èƒ½ç›‘æ§æŒ‡æ ‡

#### 1. æŸ¥è¯¢æ‰§è¡Œæ—¶é—´ç›‘æ§
```python
import time

class PerformanceMonitor:
    def __init__(self):
        self.query_times = []
    
    def timed_query(self, sql: str, params=None):
        start_time = time.time()
        
        try:
            result = self._execute_sql(sql, params)
            execution_time = time.time() - start_time
            
            # è®°å½•æ…¢æŸ¥è¯¢
            if execution_time > 1.0:  # è¶…è¿‡1ç§’çš„æŸ¥è¯¢
                logger.warning(f"æ…¢æŸ¥è¯¢è­¦å‘Š: {sql} æ‰§è¡Œæ—¶é—´: {execution_time:.2f}s")
            
            self.query_times.append(execution_time)
            return result
        except Exception as e:
            logger.error(f"æŸ¥è¯¢æ‰§è¡Œå¤±è´¥: {sql} - {e}")
            raise
```

#### 2. æ•°æ®åº“ç»Ÿè®¡ä¿¡æ¯
```python
def get_database_stats():
    """è·å–æ•°æ®åº“ç»Ÿè®¡ä¿¡æ¯"""
    stats = {}
    
    # è·å–è¡¨å¤§å°
    cursor.execute("SELECT name FROM sqlite_master WHERE type='table'")
    tables = cursor.fetchall()
    
    for table in tables:
        cursor.execute(f"SELECT COUNT(*) FROM {table[0]}")
        stats[table[0]] = {"row_count": cursor.fetchone()[0]}
    
    return stats
```

### æ…¢æŸ¥è¯¢è¯†åˆ«

#### æ…¢æŸ¥è¯¢é˜ˆå€¼è®¾ç½®
```python
# æ…¢æŸ¥è¯¢é˜ˆå€¼é…ç½®
SLOW_QUERY_THRESHOLD = {
    'read': 1.0,      # è¯»æ“ä½œè¶…è¿‡1ç§’
    'write': 5.0,     # å†™æ“ä½œè¶…è¿‡5ç§’
    'complex': 10.0   # å¤æ‚æŸ¥è¯¢è¶…è¿‡10ç§’
}

# æ…¢æŸ¥è¯¢ç›‘æ§è£…é¥°å™¨
def monitor_slow_queries(threshold: float = 1.0):
    def decorator(func):
        def wrapper(*args, **kwargs):
            start_time = time.time()
            result = func(*args, **kwargs)
            execution_time = time.time() - start_time
            
            if execution_time > threshold:
                logger.warning(f"æ…¢æŸ¥è¯¢æ£€æµ‹: {func.__name__} æ‰§è¡Œæ—¶é—´ {execution_time:.2f}s")
            
            return result
        return wrapper
    return decorator
```

**èŠ‚æ¥æº**
- [db_manager.py](file://db_manager.py#L1108-L1148)

## æœ€ä½³å®è·µå»ºè®®

### 1. æŸ¥è¯¢è®¾è®¡åŸåˆ™

#### å•ä¸€èŒè´£åŸåˆ™
```python
# å¥½çš„åšæ³•ï¼šæ¯ä¸ªæŸ¥è¯¢ä¸“æ³¨äºå•ä¸€ä»»åŠ¡
def get_cookie_details(cookie_id: str):
    """è·å–Cookieè¯¦ç»†ä¿¡æ¯"""
    cursor.execute("""
        SELECT id, value, user_id, auto_confirm, remark, pause_duration, 
               username, password, show_browser, created_at 
        FROM cookies 
        WHERE id = ?
    """, (cookie_id,))
    return cursor.fetchone()

def get_cookie_keywords(cookie_id: str):
    """è·å–Cookieç›¸å…³å…³é”®å­—"""
    cursor.execute("""
        SELECT keyword, reply, item_id, type 
        FROM keywords 
        WHERE cookie_id = ?
    """, (cookie_id,))
    return cursor.fetchall()
```

#### é¿å…N+1æŸ¥è¯¢é—®é¢˜
```python
# é”™è¯¯åšæ³•ï¼šå¾ªç¯æŸ¥è¯¢
def get_cookies_with_keywords_old(user_id: int):
    cookies = get_user_cookies(user_id)
    for cookie in cookies:
        cookie['keywords'] = get_cookie_keywords(cookie['id'])
    return cookies

# æ­£ç¡®åšæ³•ï¼šæ‰¹é‡æŸ¥è¯¢
def get_cookies_with_keywords_optimized(user_id: int):
    # è·å–æ‰€æœ‰Cookie
    cookies = get_user_cookies(user_id)
    cookie_ids = [c['id'] for c in cookies]
    
    # æ‰¹é‡è·å–å…³é”®å­—
    cursor.execute("""
        SELECT cookie_id, keyword, reply 
        FROM keywords 
        WHERE cookie_id IN ({})
    """.format(','.join(['?']*len(cookie_ids))), cookie_ids)
    
    keywords_map = defaultdict(list)
    for row in cursor.fetchall():
        keywords_map[row[0]].append({'keyword': row[1], 'reply': row[2]})
    
    # ç»„è£…ç»“æœ
    for cookie in cookies:
        cookie['keywords'] = keywords_map.get(cookie['id'], [])
    
    return cookies
```

### 2. ç´¢å¼•è®¾è®¡æœ€ä½³å®è·µ

#### ç´¢å¼•é€‰æ‹©åŸåˆ™
```mermaid
graph TD
A[ç´¢å¼•è®¾è®¡åŸåˆ™] --> B[é€‰æ‹©æ€§åŸåˆ™]
A --> C[æŸ¥è¯¢é¢‘ç‡åŸåˆ™]
A --> D[åŸºæ•°åŸåˆ™]
A --> E[è¦†ç›–æŸ¥è¯¢åŸåˆ™]
B --> B1[é«˜é€‰æ‹©æ€§çš„å­—æ®µä¼˜å…ˆ]
B --> B2[åŒºåˆ†åº¦é«˜çš„å­—æ®µ]
C --> C1[é¢‘ç¹æŸ¥è¯¢çš„å­—æ®µ]
C --> C2[WHEREæ¡ä»¶ä¸­çš„å­—æ®µ]
D --> D1[åŸºæ•°å¤§çš„å­—æ®µ]
D --> D2[é‡å¤å€¼å°‘çš„å­—æ®µ]
E --> E1[è¦†ç›–æŸ¥è¯¢éœ€æ±‚]
E --> E2[å‡å°‘å›è¡¨æŸ¥è¯¢]
```

#### ç´¢å¼•ç»´æŠ¤ç­–ç•¥
```python
class IndexMaintenance:
    def __init__(self, db_manager):
        self.db_manager = db_manager
    
    def analyze_table(self, table_name: str):
        """åˆ†æè¡¨ç»Ÿè®¡ä¿¡æ¯"""
        cursor = self.db_manager.conn.cursor()
        cursor.execute(f"ANALYZE {table_name}")
        return cursor.fetchall()
    
    def rebuild_index(self, table_name: str, index_name: str):
        """é‡å»ºç´¢å¼•ä»¥ä¼˜åŒ–ç¢ç‰‡"""
        cursor = self.db_manager.conn.cursor()
        cursor.execute(f"REINDEX {index_name}")
        return cursor.rowcount
    
    def optimize_database(self):
        """æ•°æ®åº“ä¼˜åŒ–ç»¼åˆæªæ–½"""
        cursor = self.db_manager.conn.cursor()
        
        # 1. åˆ†æè¡¨ç»Ÿè®¡ä¿¡æ¯
        cursor.execute("SELECT name FROM sqlite_master WHERE type='table'")
        tables = cursor.fetchall()
        
        for table in tables:
            self.analyze_table(table[0])
        
        # 2. é‡å»ºä¸»è¦ç´¢å¼•
        indices_to_rebuild = [
            'idx_cards_user_id',
            'idx_keywords_cookie_id',
            'idx_orders_cookie_id'
        ]
        
        for index in indices_to_rebuild:
            self.rebuild_index('main', index)
        
        # 3. æ¸…ç†æ•°æ®åº“
        cursor.execute("VACUUM")
```

### 3. è¿æ¥æ± å’Œäº‹åŠ¡ç®¡ç†

#### è¿æ¥æ± å®ç°
```python
import threading
from queue import Queue

class ConnectionPool:
    def __init__(self, db_path: str, pool_size: int = 5):
        self.db_path = db_path
        self.pool_size = pool_size
        self.connection_queue = Queue()
        self.lock = threading.Lock()
        
        # åˆå§‹åŒ–è¿æ¥æ± 
        for _ in range(pool_size):
            conn = sqlite3.connect(db_path, check_same_thread=False)
            self.connection_queue.put(conn)
    
    def get_connection(self):
        return self.connection_queue.get()
    
    def release_connection(self, conn):
        self.connection_queue.put(conn)
    
    def close_all_connections(self):
        while not self.connection_queue.empty():
            conn = self.connection_queue.get()
            conn.close()
```

#### äº‹åŠ¡ä¼˜åŒ–
```python
class OptimizedTransaction:
    def __init__(self, db_manager):
        self.db_manager = db_manager
    
    @contextmanager
    def transaction(self):
        """ä¼˜åŒ–çš„äº‹åŠ¡ç®¡ç†"""
        cursor = self.db_manager.conn.cursor()
        try:
            # è®¾ç½®å»¶è¿Ÿæäº¤
            cursor.execute("BEGIN IMMEDIATE")
            
            yield cursor
            
            # æ‰¹é‡æäº¤
            self.db_manager.conn.commit()
            
        except Exception as e:
            self.db_manager.conn.rollback()
            logger.error(f"äº‹åŠ¡æ‰§è¡Œå¤±è´¥: {e}")
            raise
    
    def bulk_insert(self, table: str, data_list: list, columns: list):
        """æ‰¹é‡æ’å…¥ä¼˜åŒ–"""
        if not data_list:
            return
        
        placeholders = ','.join(['?' for _ in columns])
        columns_str = ','.join(columns)
        
        sql = f"INSERT INTO {table} ({columns_str}) VALUES ({placeholders})"
        
        with self.transaction() as cursor:
            cursor.executemany(sql, [tuple(item[col] for col in columns) for item in data_list])
```

### 4. æ•°æ®åº“é…ç½®ä¼˜åŒ–

#### SQLiteé…ç½®ä¼˜åŒ–
```python
def optimize_sqlite_config(conn):
    """SQLiteæ•°æ®åº“é…ç½®ä¼˜åŒ–"""
    
    # WALæ¨¡å¼æé«˜å¹¶å‘æ€§èƒ½
    conn.execute("PRAGMA journal_mode = WAL")
    
    # åŒæ­¥æ¨¡å¼ä¼˜åŒ–
    conn.execute("PRAGMA synchronous = NORMAL")
    
    # ç¼“å†²åŒºå¤§å°ä¼˜åŒ–
    conn.execute("PRAGMA cache_size = -64000")  # 64MBç¼“å­˜
    
    # è‡ªåŠ¨æ¸…ç†ä¼˜åŒ–
    conn.execute("PRAGMA temp_store = MEMORY")
    
    # ç¼–è¯‘é€‰é¡¹ä¼˜åŒ–
    conn.execute("PRAGMA compile_options")
```

**èŠ‚æ¥æº**
- [db_manager.py](file://db_manager.py#L1108-L1148)

## æ€»ç»“

æœ¬æ–‡æ¡£é€šè¿‡åˆ†æ`db_manager.py`ä¸­çš„å®é™…æŸ¥è¯¢å®ç°ï¼Œæä¾›äº†å…¨é¢çš„æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–æŒ‡å—ã€‚ä¸»è¦å†…å®¹åŒ…æ‹¬ï¼š

### æ ¸å¿ƒä¼˜åŒ–æŠ€æœ¯
1. **ç´¢å¼•ç­–ç•¥**ï¼šåˆç†è®¾è®¡å’Œä½¿ç”¨ç´¢å¼•ï¼Œç‰¹åˆ«æ˜¯å¤åˆç´¢å¼•å’Œè¦†ç›–ç´¢å¼•
2. **æŸ¥è¯¢é‡æ„**ï¼šé¿å…N+1æŸ¥è¯¢é—®é¢˜ï¼Œä¼˜åŒ–å¤šè¡¨è¿æ¥æŸ¥è¯¢
3. **åˆ†é¡µä¼˜åŒ–**ï¼šä½¿ç”¨åŸºäºæ¸¸æ ‡çš„åˆ†é¡µæ›¿ä»£OFFSETåˆ†é¡µ
4. **ç¼“å­˜ç­–ç•¥**ï¼šç»“åˆRedisç­‰ç¼“å­˜æŠ€æœ¯æå‡æŸ¥è¯¢æ€§èƒ½

### æ€§èƒ½ç›‘æ§ä½“ç³»
1. **SQLæ—¥å¿—**ï¼šå†…ç½®çš„SQLæ‰§è¡Œæ—¥å¿—ç³»ç»Ÿ
2. **æ…¢æŸ¥è¯¢ç›‘æ§**ï¼šè‡ªåŠ¨è¯†åˆ«å’Œè®°å½•æ…¢æŸ¥è¯¢
3. **æ€§èƒ½æŒ‡æ ‡**ï¼šå»ºç«‹å®Œå–„çš„æ€§èƒ½ç›‘æ§æŒ‡æ ‡ä½“ç³»

### æœ€ä½³å®è·µ
1. **æŸ¥è¯¢è®¾è®¡åŸåˆ™**ï¼šéµå¾ªå•ä¸€èŒè´£å’Œé¿å…N+1æŸ¥è¯¢
2. **ç´¢å¼•è®¾è®¡**ï¼šåŸºäºæŸ¥è¯¢æ¨¡å¼å’Œæ•°æ®åˆ†å¸ƒè®¾è®¡ç´¢å¼•
3. **äº‹åŠ¡ç®¡ç†**ï¼šä¼˜åŒ–äº‹åŠ¡å¤„ç†å’Œè¿æ¥æ± ç®¡ç†
4. **æ•°æ®åº“é…ç½®**ï¼šé’ˆå¯¹SQLiteç‰¹æ€§è¿›è¡Œé…ç½®ä¼˜åŒ–

é€šè¿‡å®æ–½è¿™äº›ä¼˜åŒ–ç­–ç•¥ï¼Œå¯ä»¥æ˜¾è‘—æå‡æ•°æ®åº“æŸ¥è¯¢æ€§èƒ½ï¼Œæ”¹å–„ç³»ç»Ÿçš„æ•´ä½“å“åº”æ—¶é—´å’Œç”¨æˆ·ä½“éªŒã€‚å»ºè®®åœ¨å®é™…åº”ç”¨ä¸­ç»“åˆå…·ä½“çš„ä¸šåŠ¡åœºæ™¯å’Œæ•°æ®ç‰¹å¾ï¼ŒæŒç»­ç›‘æ§å’Œä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½ã€‚