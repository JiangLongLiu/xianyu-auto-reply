# æ•°æ®åº“è®¾è®¡

<cite>
**æœ¬æ–‡æ¡£å¼•ç”¨çš„æ–‡ä»¶**
- [db_manager.py](file://db_manager.py)
- [config.py](file://config.py)
- [global_config.yml](file://global_config.yml)
- [Start.py](file://Start.py)
- [reply_server.py](file://reply_server.py)
</cite>

## ç›®å½•
1. [ç®€ä»‹](#ç®€ä»‹)
2. [æ•°æ®åº“æ¶æ„æ¦‚è§ˆ](#æ•°æ®åº“æ¶æ„æ¦‚è§ˆ)
3. [æ ¸å¿ƒæ•°æ®è¡¨ç»“æ„](#æ ¸å¿ƒæ•°æ®è¡¨ç»“æ„)
4. [å¤šç”¨æˆ·æ•°æ®éš”ç¦»æœºåˆ¶](#å¤šç”¨æˆ·æ•°æ®éš”ç¦»æœºåˆ¶)
5. [é…ç½®ç®¡ç†](#é…ç½®ç®¡ç†)
6. [æ•°æ®åº“åˆå§‹åŒ–ä¸è¿ç§»](#æ•°æ®åº“åˆå§‹åŒ–ä¸è¿ç§»)
7. [å¤‡ä»½ä¸æ¢å¤ç­–ç•¥](#å¤‡ä»½ä¸æ¢å¤ç­–ç•¥)
8. [æ€§èƒ½ä¼˜åŒ–æªæ–½](#æ€§èƒ½ä¼˜åŒ–æªæ–½)
9. [æŸ¥è¯¢ç¤ºä¾‹ä¸æœ€ä½³å®è·µ](#æŸ¥è¯¢ç¤ºä¾‹ä¸æœ€ä½³å®è·µ)
10. [æ€»ç»“](#æ€»ç»“)

## ç®€ä»‹

æœ¬ç³»ç»Ÿé‡‡ç”¨SQLiteä½œä¸ºä¸»è¦æ•°æ®åº“å¼•æ“ï¼Œè®¾è®¡äº†ä¸€ä¸ªå®Œæ•´çš„å¤šç”¨æˆ·ç”µå•†å¹³å°è‡ªåŠ¨å›å¤ç³»ç»Ÿã€‚æ•°æ®åº“è®¾è®¡éµå¾ªå…³ç³»å‹æ•°æ®åº“èŒƒå¼ï¼Œå®ç°äº†ä¸¥æ ¼çš„ç”¨æˆ·æ•°æ®éš”ç¦»ï¼Œæ”¯æŒå¤æ‚çš„ä¸šåŠ¡é€»è¾‘å’Œé«˜æ•ˆçš„æŸ¥è¯¢æ€§èƒ½ã€‚

## æ•°æ®åº“æ¶æ„æ¦‚è§ˆ

ç³»ç»Ÿæ•°æ®åº“é‡‡ç”¨å±‚æ¬¡åŒ–è®¾è®¡ï¼Œä¸»è¦åŒ…å«ä»¥ä¸‹å‡ ä¸ªå±‚æ¬¡ï¼š

```mermaid
graph TB
subgraph "ç”¨æˆ·å±‚"
U[users - ç”¨æˆ·è¡¨]
C[cookies - Cookieè´¦æˆ·è¡¨]
end
subgraph "ä¸šåŠ¡å±‚"
K[keywords - å…³é”®å­—è¡¨]
O[orders - è®¢å•è¡¨]
D[delivery_rules - å‘è´§è§„åˆ™è¡¨]
CARDS[cards - å¡åˆ¸è¡¨]
end
subgraph "é…ç½®å±‚"
S[system_settings - ç³»ç»Ÿè®¾ç½®è¡¨]
N[notification_channels - é€šçŸ¥æ¸ é“è¡¨]
MS[message_notifications - æ¶ˆæ¯é€šçŸ¥é…ç½®è¡¨]
end
subgraph "AIå±‚"
AI[ai_reply_settings - AIå›å¤è®¾ç½®è¡¨]
CONV[ai_conversations - AIå¯¹è¯å†å²è¡¨]
CACHE[ai_item_cache - AIå•†å“ç¼“å­˜è¡¨]
end
subgraph "ç›‘æ§å±‚"
LOGS[risk_control_logs - é£æ§æ—¥å¿—è¡¨]
USR[user_settings - ç”¨æˆ·è®¾ç½®è¡¨]
end
U --> C
C --> K
C --> O
C --> D
C --> CARDS
C --> AI
C --> CONV
C --> CACHE
C --> MS
S --> N
N --> MS
U --> USR
C --> LOGS
```

**å›¾è¡¨æ¥æº**
- [db_manager.py](file://db_manager.py#L67-L447)

## æ ¸å¿ƒæ•°æ®è¡¨ç»“æ„

### ç”¨æˆ·è¡¨ (users)

ç”¨æˆ·è®¤è¯å’Œæƒé™ç®¡ç†çš„æ ¸å¿ƒè¡¨ï¼Œæ”¯æŒå¤šç”¨æˆ·ç³»ç»Ÿçš„åŸºç¡€æ¶æ„ã€‚

| å­—æ®µå | æ•°æ®ç±»å‹ | çº¦æŸ | æè¿° |
|--------|----------|------|------|
| id | INTEGER | PRIMARY KEY AUTOINCREMENT | ç”¨æˆ·å”¯ä¸€æ ‡è¯†ç¬¦ |
| username | TEXT | UNIQUE NOT NULL | ç”¨æˆ·åï¼Œå”¯ä¸€çº¦æŸ |
| email | TEXT | UNIQUE NOT NULL | é‚®ç®±åœ°å€ï¼Œå”¯ä¸€çº¦æŸ |
| password_hash | TEXT | NOT NULL | å¯†ç å“ˆå¸Œå€¼ |
| is_active | BOOLEAN | DEFAULT TRUE | ç”¨æˆ·æ˜¯å¦æ¿€æ´» |
| created_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | åˆ›å»ºæ—¶é—´ |
| updated_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | æ›´æ–°æ—¶é—´ |

### Cookieè´¦æˆ·è¡¨ (cookies)

å­˜å‚¨ç”¨æˆ·ç™»å½•å‡­è¯å’Œè´¦æˆ·é…ç½®ä¿¡æ¯ï¼Œæ˜¯ç³»ç»Ÿçš„æ ¸å¿ƒæ•°æ®è¡¨ä¹‹ä¸€ã€‚

| å­—æ®µå | æ•°æ®ç±»å‹ | çº¦æŸ | æè¿° |
|--------|----------|------|------|
| id | TEXT | PRIMARY KEY | Cookieå”¯ä¸€æ ‡è¯†ç¬¦ |
| value | TEXT | NOT NULL | Cookieå€¼ |
| user_id | INTEGER | NOT NULL | å…³è”ç”¨æˆ·IDï¼Œå¤–é”®çº¦æŸ |
| auto_confirm | INTEGER | DEFAULT 1 | è‡ªåŠ¨ç¡®è®¤å‘è´§è®¾ç½® |
| remark | TEXT | DEFAULT '' | å¤‡æ³¨ä¿¡æ¯ |
| pause_duration | INTEGER | DEFAULT 10 | è‡ªåŠ¨å›å¤æš‚åœæ—¶é—´ï¼ˆåˆ†é’Ÿï¼‰ |
| username | TEXT | DEFAULT '' | å¯†ç ç™»å½•ç”¨æˆ·å |
| password | TEXT | DEFAULT '' | å¯†ç ç™»å½•å¯†ç  |
| show_browser | INTEGER | DEFAULT 0 | æ˜¯å¦æ˜¾ç¤ºæµè§ˆå™¨ |
| created_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | åˆ›å»ºæ—¶é—´ |

### å…³é”®å­—è¡¨ (keywords)

å®ç°æ™ºèƒ½å›å¤çš„æ ¸å¿ƒè¡¨ï¼Œæ”¯æŒåŸºäºå•†å“IDçš„ç²¾ç¡®åŒ¹é…ã€‚

| å­—æ®µå | æ•°æ®ç±»å‹ | çº¦æŸ | æè¿° |
|--------|----------|------|------|
| cookie_id | TEXT | NOT NULL | å…³è”Cookie ID |
| keyword | TEXT | NOT NULL | å…³é”®è¯å†…å®¹ |
| reply | TEXT | NOT NULL | å›å¤å†…å®¹ |
| item_id | TEXT | | å•†å“IDï¼ˆå¯é€‰ï¼‰ |
| type | TEXT | DEFAULT 'text' | å…³é”®è¯ç±»å‹ï¼ˆtext/imageï¼‰ |
| image_url | TEXT | | å›¾ç‰‡URLï¼ˆä»…å›¾ç‰‡å…³é”®è¯ï¼‰ |
| FOREIGN KEY | | | (cookie_id) REFERENCES cookies(id) ON DELETE CASCADE |

### è®¢å•è¡¨ (orders)

è·Ÿè¸ªäº¤æ˜“è¿‡ç¨‹ï¼Œæ”¯æŒè®¢å•çŠ¶æ€ç®¡ç†å’Œè‡ªåŠ¨å‘è´§ã€‚

| å­—æ®µå | æ•°æ®ç±»å‹ | çº¦æŸ | æè¿° |
|--------|----------|------|------|
| order_id | TEXT | PRIMARY KEY | è®¢å•å”¯ä¸€æ ‡è¯†ç¬¦ |
| item_id | TEXT | | å•†å“ID |
| buyer_id | TEXT | | ä¹°å®¶ID |
| spec_name | TEXT | | è§„æ ¼åç§° |
| spec_value | TEXT | | è§„æ ¼å€¼ |
| quantity | TEXT | | æ•°é‡ |
| amount | TEXT | | é‡‘é¢ |
| order_status | TEXT | DEFAULT 'unknown' | è®¢å•çŠ¶æ€ |
| cookie_id | TEXT | NOT NULL | å…³è”Cookie ID |
| created_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | åˆ›å»ºæ—¶é—´ |
| updated_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | æ›´æ–°æ—¶é—´ |

### å¡åˆ¸è¡¨ (cards)

æ”¯æŒå¤šç§ç±»å‹çš„è‡ªåŠ¨å›å¤å†…å®¹ï¼ŒåŒ…æ‹¬æ–‡æœ¬ã€APIã€æ•°æ®å’Œå›¾ç‰‡å¡åˆ¸ã€‚

| å­—æ®µå | æ•°æ®ç±»å‹ | çº¦æŸ | æè¿° |
|--------|----------|------|------|
| id | INTEGER | PRIMARY KEY AUTOINCREMENT | å¡åˆ¸å”¯ä¸€æ ‡è¯†ç¬¦ |
| name | TEXT | NOT NULL | å¡åˆ¸åç§° |
| type | TEXT | NOT NULL CHECK (type IN ('api', 'text', 'data', 'image')) | å¡åˆ¸ç±»å‹ |
| api_config | TEXT | | APIé…ç½®ä¿¡æ¯ |
| text_content | TEXT | | æ–‡æœ¬å†…å®¹ |
| data_content | TEXT | | æ•°æ®å†…å®¹ |
| image_url | TEXT | | å›¾ç‰‡URL |
| description | TEXT | | å¡åˆ¸æè¿° |
| enabled | BOOLEAN | DEFAULT TRUE | æ˜¯å¦å¯ç”¨ |
| delay_seconds | INTEGER | DEFAULT 0 | å»¶æ—¶å‘é€ç§’æ•° |
| is_multi_spec | BOOLEAN | DEFAULT FALSE | æ˜¯å¦å¤šè§„æ ¼ |
| spec_name | TEXT | | è§„æ ¼åç§° |
| spec_value | TEXT | | è§„æ ¼å€¼ |
| user_id | INTEGER | NOT NULL DEFAULT 1 | å…³è”ç”¨æˆ·ID |
| created_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | åˆ›å»ºæ—¶é—´ |
| updated_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | æ›´æ–°æ—¶é—´ |

### AIå›å¤é…ç½®è¡¨ (ai_reply_settings)

ç®¡ç†AIå›å¤åŠŸèƒ½çš„å„ç§å‚æ•°å’Œè®¾ç½®ã€‚

| å­—æ®µå | æ•°æ®ç±»å‹ | çº¦æŸ | æè¿° |
|--------|----------|------|------|
| cookie_id | TEXT | PRIMARY KEY | å…³è”Cookie ID |
| ai_enabled | BOOLEAN | DEFAULT FALSE | æ˜¯å¦å¯ç”¨AIå›å¤ |
| model_name | TEXT | DEFAULT 'qwen-plus' | AIæ¨¡å‹åç§° |
| api_key | TEXT | | APIå¯†é’¥ |
| base_url | TEXT | DEFAULT 'https://dashscope.aliyuncs.com/compatible-mode/v1' | APIåŸºç¡€URL |
| max_discount_percent | INTEGER | DEFAULT 10 | æœ€å¤§æŠ˜æ‰£ç™¾åˆ†æ¯” |
| max_discount_amount | INTEGER | DEFAULT 100 | æœ€å¤§æŠ˜æ‰£é‡‘é¢ |
| max_bargain_rounds | INTEGER | DEFAULT 3 | æœ€å¤§è®®ä»·è½®æ¬¡ |
| custom_prompts | TEXT | | è‡ªå®šä¹‰æç¤ºè¯ |
| created_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | åˆ›å»ºæ—¶é—´ |
| updated_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | æ›´æ–°æ—¶é—´ |

### é€šçŸ¥æ¸ é“è¡¨ (notification_channels)

æ”¯æŒå¤šç§é€šçŸ¥æ¸ é“çš„é…ç½®ç®¡ç†ã€‚

| å­—æ®µå | æ•°æ®ç±»å‹ | çº¦æŸ | æè¿° |
|--------|----------|------|------|
| id | INTEGER | PRIMARY KEY AUTOINCREMENT | é€šçŸ¥æ¸ é“ID |
| name | TEXT | NOT NULL | æ¸ é“åç§° |
| user_id | INTEGER | NOT NULL | å…³è”ç”¨æˆ·ID |
| type | TEXT | NOT NULL CHECK (type IN ('qq','ding_talk','dingtalk','feishu','lark','bark','email','webhook','wechat','telegram')) | æ¸ é“ç±»å‹ |
| config | TEXT | NOT NULL | é…ç½®ä¿¡æ¯ï¼ˆJSONæ ¼å¼ï¼‰ |
| enabled | BOOLEAN | DEFAULT TRUE | æ˜¯å¦å¯ç”¨ |
| created_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | åˆ›å»ºæ—¶é—´ |
| updated_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | æ›´æ–°æ—¶é—´ |

**ç« èŠ‚æ¥æº**
- [db_manager.py](file://db_manager.py#L67-L447)

## å¤šç”¨æˆ·æ•°æ®éš”ç¦»æœºåˆ¶

ç³»ç»Ÿé€šè¿‡user_idå­—æ®µå®ç°ä¸¥æ ¼çš„å¤šç”¨æˆ·æ•°æ®éš”ç¦»ï¼Œç¡®ä¿ä¸åŒç”¨æˆ·çš„æ•°æ®å®Œå…¨ç‹¬ç«‹ã€‚

### éš”ç¦»åŸåˆ™

1. **å¼ºåˆ¶ç”¨æˆ·å…³è”**ï¼šæ‰€æœ‰ä¸šåŠ¡è¡¨éƒ½åŒ…å«user_idå­—æ®µ
2. **çº§è”åˆ é™¤**ï¼šç”¨æˆ·åˆ é™¤æ—¶è‡ªåŠ¨æ¸…ç†å…¶æ‰€æœ‰ç›¸å…³æ•°æ®
3. **æŸ¥è¯¢è¿‡æ»¤**ï¼šæ‰€æœ‰æŸ¥è¯¢éƒ½è‡ªåŠ¨åŒ…å«user_idè¿‡æ»¤æ¡ä»¶
4. **æƒé™è¾¹ç•Œ**ï¼šè·¨ç”¨æˆ·æ•°æ®è®¿é—®è¢«ä¸¥æ ¼ç¦æ­¢

### éš”ç¦»å®ç°

```mermaid
sequenceDiagram
participant User as ç”¨æˆ·
participant DB as æ•°æ®åº“
participant Table as ä¸šåŠ¡è¡¨
User->>DB : æŸ¥è¯¢è¯·æ±‚(user_id=1)
DB->>DB : è‡ªåŠ¨æ·»åŠ WHERE user_id=1è¿‡æ»¤
DB->>Table : æ‰§è¡ŒæŸ¥è¯¢
Table-->>DB : è¿”å›ç”¨æˆ·1çš„æ•°æ®
DB-->>User : è¿”å›éš”ç¦»æ•°æ®
Note over User,Table : è·¨ç”¨æˆ·æ•°æ®è®¿é—®è¢«é˜»æ­¢
```

**å›¾è¡¨æ¥æº**
- [db_manager.py](file://db_manager.py#L1225-L1237)
- [db_manager.py](file://db_manager.py#L2210-L2279)

### æ•°æ®æ¸…ç†æœºåˆ¶

ç³»ç»Ÿæä¾›äº†å®Œæ•´çš„ç”¨æˆ·æ•°æ®æ¸…ç†åŠŸèƒ½ï¼š

```python
# åˆ é™¤ç”¨æˆ·åŠå…¶æ‰€æœ‰ç›¸å…³æ•°æ®
cursor.execute('DELETE FROM user_settings WHERE user_id = ?', (user_id,))
cursor.execute('DELETE FROM cards WHERE user_id = ?', (user_id,))
cursor.execute('DELETE FROM delivery_rules WHERE user_id = ?', (user_id,))
cursor.execute('DELETE FROM notification_channels WHERE user_id = ?', (user_id,))
cursor.execute('DELETE FROM cookies WHERE user_id = ?', (user_id,))
```

**ç« èŠ‚æ¥æº**
- [db_manager.py](file://db_manager.py#L4319-L4348)

## é…ç½®ç®¡ç†

ç³»ç»Ÿé‡‡ç”¨åŒé‡é…ç½®ç®¡ç†æ¨¡å¼ï¼Œå¹³è¡¡äº†çµæ´»æ€§å’Œå®‰å…¨æ€§ã€‚

### æ–‡ä»¶é…ç½® (global_config.yml)

å­˜å‚¨ç³»ç»Ÿçº§é…ç½®ï¼Œé€‚åˆéƒ¨ç½²æ—¶å›ºå®šä¸å˜çš„è®¾ç½®ï¼š

| é…ç½®ç±»åˆ« | ä¸»è¦é…ç½®é¡¹ | æè¿° |
|----------|------------|------|
| APIç«¯ç‚¹ | API_ENDPOINTS.login_check | ç™»å½•æ£€æŸ¥APIåœ°å€ |
| åº”ç”¨é…ç½® | APP_CONFIG.app_key | åº”ç”¨å¯†é’¥ |
| è‡ªåŠ¨å›å¤ | AUTO_REPLY.enabled | æ˜¯å¦å¯ç”¨è‡ªåŠ¨å›å¤ |
| WebSocket | WEBSOCKET_URL | WebSocketè¿æ¥åœ°å€ |
| æ—¥å¿—é…ç½® | LOG_CONFIG.level | æ—¥å¿—çº§åˆ« |
| æ»‘å—éªŒè¯ | SLIDER_VERIFICATION.max_concurrent | æœ€å¤§å¹¶å‘æ•° |

### æ•°æ®åº“é…ç½® (system_settings)

å­˜å‚¨è¿è¡Œæ—¶å¯å˜çš„ç³»ç»Ÿè®¾ç½®ï¼š

| é”®å | é»˜è®¤å€¼ | æè¿° |
|------|--------|------|
| theme_color | blue | ä¸»é¢˜é¢œè‰² |
| registration_enabled | true | æ˜¯å¦å¼€å¯ç”¨æˆ·æ³¨å†Œ |
| smtp_server | ç©º | SMTPæœåŠ¡å™¨åœ°å€ |
| smtp_port | 587 | SMTPç«¯å£ |
| qq_reply_secret_key | xianyu_qq_reply_2024 | QQå›å¤APIå¯†é’¥ |

### é…ç½®åŒæ­¥æœºåˆ¶

ç³»ç»Ÿåœ¨å¯åŠ¨æ—¶ä¼šè‡ªåŠ¨åŒæ­¥é…ç½®ï¼š
- ä¼˜å…ˆä½¿ç”¨æ•°æ®åº“é…ç½®
- æ•°æ®åº“é…ç½®ç¼ºå¤±æ—¶ä½¿ç”¨æ–‡ä»¶é…ç½®
- ç®¡ç†å‘˜å¯é€šè¿‡Webç•Œé¢ä¿®æ”¹æ•°æ®åº“é…ç½®

**ç« èŠ‚æ¥æº**
- [global_config.yml](file://global_config.yml#L1-L77)
- [config.py](file://config.py#L1-L126)
- [db_manager.py](file://db_manager.py#L425-L438)

## æ•°æ®åº“åˆå§‹åŒ–ä¸è¿ç§»

### åˆå§‹åŒ–æµç¨‹

```mermaid
flowchart TD
Start([ç³»ç»Ÿå¯åŠ¨]) --> CheckDB{æ£€æŸ¥æ•°æ®åº“æ–‡ä»¶}
CheckDB --> |ä¸å­˜åœ¨| CreateDB[åˆ›å»ºæ•°æ®åº“æ–‡ä»¶]
CheckDB --> |å­˜åœ¨| LoadDB[åŠ è½½ç°æœ‰æ•°æ®åº“]
CreateDB --> InitTables[åˆå§‹åŒ–æ•°æ®è¡¨]
LoadDB --> CheckVersion{æ£€æŸ¥æ•°æ®åº“ç‰ˆæœ¬}
InitTables --> CreateUsers[åˆ›å»ºé»˜è®¤ç”¨æˆ·]
CreateUsers --> CreateSettings[åˆå§‹åŒ–ç³»ç»Ÿè®¾ç½®]
CreateSettings --> Complete[åˆå§‹åŒ–å®Œæˆ]
CheckVersion --> |ç‰ˆæœ¬è¿‡ä½| UpgradeDB[æ‰§è¡Œæ•°æ®åº“å‡çº§]
CheckVersion --> |ç‰ˆæœ¬æœ€æ–°| Complete
UpgradeDB --> MigrateData[æ•°æ®è¿ç§»]
MigrateData --> Complete
```

**å›¾è¡¨æ¥æº**
- [db_manager.py](file://db_manager.py#L67-L447)
- [db_manager.py](file://db_manager.py#L441-L447)

### ç‰ˆæœ¬å‡çº§æœºåˆ¶

ç³»ç»Ÿæ”¯æŒæ•°æ®åº“ç‰ˆæœ¬è‡ªåŠ¨å‡çº§ï¼š

| ç‰ˆæœ¬ | å‡çº§å†…å®¹ |
|------|----------|
| 1.0 | åŸºç¡€è¡¨ç»“æ„åˆ›å»º |
| 1.1 | é€šçŸ¥æ¸ é“è¡¨å‡çº§ |
| 1.2 | æ”¯æŒæ›´å¤šé€šçŸ¥æ¸ é“ç±»å‹ |
| 1.3 | å…³é”®è¯è¡¨æ”¯æŒå›¾ç‰‡ç±»å‹ |
| 1.4 | é€šçŸ¥æ¸ é“ç±»å‹æ‰©å±• |
| 1.5 | Cookieè¡¨æ”¯æŒè´¦å·ç™»å½• |

### æ•°æ®è¿ç§»ç­–ç•¥

1. **å‘åå…¼å®¹**ï¼šæ–°ç‰ˆæœ¬å¯ä»¥è¯»å–æ—§ç‰ˆæœ¬æ•°æ®
2. **æ¸è¿›å¼å‡çº§**ï¼šæ¯æ¬¡å‡çº§åªå¤„ç†ç‰¹å®šå˜æ›´
3. **æ•°æ®å¤‡ä»½**ï¼šå‡çº§å‰è‡ªåŠ¨å¤‡ä»½é‡è¦æ•°æ®
4. **å›æ»šæœºåˆ¶**ï¼šå‡çº§å¤±è´¥æ—¶è‡ªåŠ¨å›æ»š

**ç« èŠ‚æ¥æº**
- [db_manager.py](file://db_manager.py#L558-L608)
- [db_manager.py](file://db_manager.py#L441-L447)

## å¤‡ä»½ä¸æ¢å¤ç­–ç•¥

### å¤‡ä»½ç±»å‹

ç³»ç»Ÿæä¾›ä¸¤ç§å¤‡ä»½æ¨¡å¼ï¼š

#### ç”¨æˆ·çº§å¤‡ä»½
```python
# åªå¤‡ä»½æŒ‡å®šç”¨æˆ·çš„æ•°æ®
backup_data = {
    'version': '1.0',
    'timestamp': time.time(),
    'user_id': user_id,
    'data': {
        'cookies': {...},
        'keywords': {...},
        'orders': {...}
    }
}
```

#### ç³»ç»Ÿçº§å¤‡ä»½
```python
# å¤‡ä»½æ‰€æœ‰ç”¨æˆ·çš„æ•°æ®
tables = ['cookies', 'keywords', 'orders', 'cards', 
          'delivery_rules', 'notification_channels']
```

### æ¢å¤æœºåˆ¶

```mermaid
flowchart TD
Import[å¯¼å…¥å¤‡ä»½] --> Validate{éªŒè¯å¤‡ä»½æ ¼å¼}
Validate --> |æ— æ•ˆ| Error[è¿”å›é”™è¯¯]
Validate --> |æœ‰æ•ˆ| BeginTx[å¼€å§‹äº‹åŠ¡]
BeginTx --> ClearOldData[æ¸…ç†æ—§æ•°æ®]
ClearOldData --> ImportData[å¯¼å…¥æ–°æ•°æ®]
ImportData --> Commit[æäº¤äº‹åŠ¡]
Commit --> Success[æ¢å¤æˆåŠŸ]
Error --> Rollback[å›æ»šæ“ä½œ]
```

**å›¾è¡¨æ¥æº**
- [db_manager.py](file://db_manager.py#L2210-L2374)

### å¤‡ä»½ç‰¹æ€§

1. **å¢é‡å¤‡ä»½**ï¼šæ”¯æŒåªå¤‡ä»½å˜åŒ–çš„æ•°æ®
2. **å‹ç¼©å­˜å‚¨**ï¼šå¤‡ä»½æ–‡ä»¶è‡ªåŠ¨å‹ç¼©
3. **å®Œæ•´æ€§æ£€æŸ¥**ï¼šå¯¼å…¥å‰éªŒè¯æ•°æ®å®Œæ•´æ€§
4. **ç”¨æˆ·éš”ç¦»**ï¼šæ”¯æŒé€‰æ‹©æ€§æ¢å¤ç‰¹å®šç”¨æˆ·æ•°æ®

**ç« èŠ‚æ¥æº**
- [db_manager.py](file://db_manager.py#L2210-L2374)
- [reply_server.py](file://reply_server.py#L5223-L5251)

## æ€§èƒ½ä¼˜åŒ–æªæ–½

### ç´¢å¼•è®¾è®¡

ç³»ç»Ÿå»ºç«‹äº†å®Œå–„çš„ç´¢å¼•ä½“ç³»ï¼š

| ç´¢å¼•åç§° | ç›®æ ‡è¡¨ | ç´¢å¼•å­—æ®µ | ç”¨é€” |
|----------|--------|----------|------|
| idx_cards_user_id | cards | user_id | ç”¨æˆ·æ•°æ®æŸ¥è¯¢ |
| idx_keywords_unique_no_item | keywords | (cookie_id, keyword) | é€šç”¨å…³é”®è¯å»é‡ |
| idx_keywords_unique_with_item | keywords | (cookie_id, keyword, item_id) | å•†å“å…³é”®è¯å»é‡ |
| idx_anonymous_id | user_stats | anonymous_id | ç”¨æˆ·ç»Ÿè®¡æŸ¥è¯¢ |
| idx_last_seen | user_stats | last_seen | æ´»è·ƒç”¨æˆ·ç­›é€‰ |

### æŸ¥è¯¢ä¼˜åŒ–ç­–ç•¥

1. **è¿æ¥æ± ç®¡ç†**ï¼šä½¿ç”¨çº¿ç¨‹é”ä¿æŠ¤æ•°æ®åº“è¿æ¥
2. **æ‰¹é‡æ“ä½œ**ï¼šæ”¯æŒæ‰¹é‡æ’å…¥å’Œæ›´æ–°
3. **å»¶è¿ŸåŠ è½½**ï¼šæŒ‰éœ€åŠ è½½éå…³é”®æ•°æ®
4. **ç¼“å­˜æœºåˆ¶**ï¼šå¯¹é¢‘ç¹æŸ¥è¯¢çš„æ•°æ®å»ºç«‹å†…å­˜ç¼“å­˜

### æ€§èƒ½ç›‘æ§

```python
# SQLæ—¥å¿—è®°å½•
def _log_sql(self, sql: str, params: tuple = None, operation: str = "EXECUTE"):
    """è®°å½•SQLæ‰§è¡Œæ—¥å¿—"""
    if not self.sql_log_enabled:
        return
    
    # æ ¼å¼åŒ–å‚æ•°å’ŒSQL
    formatted_sql = ' '.join(sql.split())
    log_message = f"ğŸ—„ï¸ SQL {operation}: {formatted_sql}{params_str}"
    
    # æ ¹æ®é…ç½®çš„æ—¥å¿—çº§åˆ«è¾“å‡º
    if self.sql_log_level == 'DEBUG':
        logger.debug(log_message)
    elif self.sql_log_level == 'INFO':
        logger.info(log_message)
```

**ç« èŠ‚æ¥æº**
- [db_manager.py](file://db_manager.py#L1072-L1084)
- [db_manager.py](file://db_manager.py#L1108-L1141)

## æŸ¥è¯¢ç¤ºä¾‹ä¸æœ€ä½³å®è·µ

### å¸¸ç”¨æŸ¥è¯¢æ¨¡å¼

#### è·å–ç”¨æˆ·æ‰€æœ‰Cookie
```sql
SELECT id, value, created_at 
FROM cookies 
WHERE user_id = ?
```

#### æŸ¥è¯¢å…³é”®è¯åŒ¹é…
```sql
SELECT keyword, reply, item_id 
FROM keywords 
WHERE cookie_id = ? 
AND (item_id IS NULL OR item_id = '')
ORDER BY keyword
```

#### ç»Ÿè®¡ç”¨æˆ·æ´»åŠ¨
```sql
SELECT COUNT(*) as order_count, SUM(amount) as total_amount
FROM orders 
WHERE cookie_id IN (SELECT id FROM cookies WHERE user_id = ?)
```

### æœ€ä½³å®è·µ

1. **å§‹ç»ˆä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢**ï¼šé˜²æ­¢SQLæ³¨å…¥æ”»å‡»
2. **åˆç†ä½¿ç”¨ç´¢å¼•**ï¼šé¿å…å…¨è¡¨æ‰«æ
3. **æ§åˆ¶äº‹åŠ¡èŒƒå›´**ï¼šå‡å°‘é”ç«äº‰
4. **å®šæœŸæ¸…ç†è¿‡æœŸæ•°æ®**ï¼šä¿æŒæ•°æ®åº“æ€§èƒ½
5. **ç›‘æ§æŸ¥è¯¢æ€§èƒ½**ï¼šåŠæ—¶å‘ç°æ€§èƒ½ç“¶é¢ˆ

### é”™è¯¯å¤„ç†

```python
try:
    cursor.execute(sql, params)
    result = cursor.fetchall()
    return result
except sqlite3.Error as e:
    logger.error(f"æ•°æ®åº“æŸ¥è¯¢å¤±è´¥: {e}")
    return []
```

**ç« èŠ‚æ¥æº**
- [db_manager.py](file://db_manager.py#L1225-L1237)
- [db_manager.py](file://db_manager.py#L1561-L1570)

## æ€»ç»“

æœ¬æ•°æ®åº“è®¾è®¡æ–¹æ¡ˆä½“ç°äº†ç°ä»£Webåº”ç”¨çš„æœ€ä½³å®è·µï¼š

### è®¾è®¡ä¼˜åŠ¿

1. **ä¸¥æ ¼çš„ç”¨æˆ·éš”ç¦»**ï¼šé€šè¿‡user_idå­—æ®µå®ç°å®Œå…¨çš„æ•°æ®éš”ç¦»
2. **çµæ´»çš„é…ç½®ç®¡ç†**ï¼šæ–‡ä»¶é…ç½®ä¸æ•°æ®åº“é…ç½®ç›¸ç»“åˆ
3. **å®Œå–„çš„è¿ç§»æœºåˆ¶**ï¼šæ”¯æŒå¹³æ»‘çš„ç‰ˆæœ¬å‡çº§
4. **å¼ºå¤§çš„å¤‡ä»½æ¢å¤**ï¼šæä¾›å¤šç§å¤‡ä»½ç­–ç•¥
5. **ä¼˜ç§€çš„æ€§èƒ½è¡¨ç°**ï¼šé€šè¿‡ç´¢å¼•å’Œç¼“å­˜ä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½

### æŠ€æœ¯ç‰¹è‰²

- **å…³ç³»å‹æ•°æ®åº“è®¾è®¡**ï¼šä¿è¯æ•°æ®ä¸€è‡´æ€§å’Œå®Œæ•´æ€§
- **å¤šç”¨æˆ·æ¶æ„**ï¼šæ”¯æŒä¼ä¸šçº§åº”ç”¨éœ€æ±‚
- **æ¨¡å—åŒ–è®¾è®¡**ï¼šä¾¿äºç»´æŠ¤å’Œæ‰©å±•
- **å®‰å…¨è€ƒè™‘**ï¼šå†…ç½®é˜²æŠ¤æœºåˆ¶å’Œå®¡è®¡åŠŸèƒ½

### æ‰©å±•æ€§

ç³»ç»Ÿè®¾è®¡å…·æœ‰è‰¯å¥½çš„æ‰©å±•æ€§ï¼Œå¯ä»¥è½»æ¾æ·»åŠ æ–°çš„ä¸šåŠ¡è¡¨å’ŒåŠŸèƒ½æ¨¡å—ï¼ŒåŒæ—¶ä¿æŒç°æœ‰åŠŸèƒ½çš„ç¨³å®šæ€§ã€‚