# 表结构详情

<cite>
**本文档引用的文件**
- [db_manager.py](file://db_manager.py)
- [global_config.yml](file://global_config.yml)
- [config.py](file://config.py)
- [reply_server.py](file://reply_server.py)
</cite>

## 目录
1. [简介](#简介)
2. [数据库架构概览](#数据库架构概览)
3. [核心用户表](#核心用户表)
4. [Cookie管理表](#cookie管理表)
5. [关键词回复表](#关键词回复表)
6. [卡券管理表](#卡券管理表)
7. [订单管理表](#订单管理表)
8. [AI回复系统表](#ai回复系统表)
9. [通知系统表](#通知系统表)
10. [系统配置表](#系统配置表)
11. [索引设计](#索引设计)
12. [字段演进历程](#字段演进历程)
13. [配置对比分析](#配置对比分析)
14. [总结](#总结)

## 简介

本文档详细分析了Xianyu Auto Reply系统中db_manager.py定义的所有数据表结构，包括字段定义、约束条件、索引设计以及字段的演进过程。该系统采用SQLite数据库，支持多用户管理和自动回复功能。

## 数据库架构概览

系统采用关系型数据库设计，主要包含以下几类表：

```mermaid
erDiagram
USERS {
integer id PK
text username UK
text email UK
text password_hash
boolean is_active
timestamp created_at
timestamp updated_at
}
COOKIES {
text id PK
text value
integer user_id FK
integer auto_confirm
text remark
integer pause_duration
text username
text password
integer show_browser
timestamp created_at
}
KEYWORDS {
text cookie_id FK
text keyword
text reply
text item_id
text type
text image_url
}
CARDS {
integer id PK
text name
text type CHECK
text api_config
text text_content
text data_content
text image_url
text description
boolean enabled
integer delay_seconds
boolean is_multi_spec
text spec_name
text spec_value
integer user_id FK
timestamp created_at
timestamp updated_at
}
ORDERS {
text order_id PK
text item_id
text buyer_id
text spec_name
text spec_value
text quantity
text amount
text order_status
text cookie_id FK
timestamp created_at
timestamp updated_at
}
USERS ||--o{ COOKIES : "belongs to"
COOKIES ||--o{ KEYWORDS : "has"
COOKIES ||--o{ CARDS : "manages"
COOKIES ||--o{ ORDERS : "processes"
```

**图表来源**
- [db_manager.py](file://db_manager.py#L74-L234)

## 核心用户表

### users表

用户基础信息表，存储系统用户的基本信息。

| 字段名 | 数据类型 | 约束条件 | 默认值 | 业务含义 |
|--------|----------|----------|--------|----------|
| id | INTEGER | PRIMARY KEY AUTOINCREMENT | - | 主键，自增ID |
| username | TEXT | UNIQUE NOT NULL | - | 用户名，唯一且不能为空 |
| email | TEXT | UNIQUE NOT NULL | - | 邮箱地址，唯一且不能为空 |
| password_hash | TEXT | NOT NULL | - | 密码哈希值，用于安全验证 |
| is_active | BOOLEAN | DEFAULT TRUE | TRUE | 用户账户状态，是否激活 |
| created_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | CURRENT_TIMESTAMP | 创建时间戳 |
| updated_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | CURRENT_TIMESTAMP | 更新时间戳 |

**节来源**
- [db_manager.py](file://db_manager.py#L74-L83)

### email_verifications表

邮箱验证码表，用于用户注册和密码找回功能。

| 字段名 | 数据类型 | 约束条件 | 默认值 | 业务含义 |
|--------|----------|----------|--------|----------|
| id | INTEGER | PRIMARY KEY AUTOINCREMENT | - | 主键，自增ID |
| email | TEXT | NOT NULL | - | 目标邮箱地址 |
| code | TEXT | NOT NULL | - | 验证码内容 |
| expires_at | TIMESTAMP | NOT NULL | - | 验证码过期时间 |
| used | BOOLEAN | DEFAULT FALSE | FALSE | 是否已使用 |
| created_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | CURRENT_TIMESTAMP | 创建时间戳 |

**节来源**
- [db_manager.py](file://db_manager.py#L87-L95)

### captcha_codes表

图形验证码表，用于防止机器人攻击。

| 字段名 | 数据类型 | 约束条件 | 默认值 | 业务含义 |
|--------|----------|----------|--------|----------|
| id | INTEGER | PRIMARY KEY AUTOINCREMENT | - | 主键，自增ID |
| session_id | TEXT | NOT NULL | - | 会话标识符 |
| code | TEXT | NOT NULL | - | 验证码内容 |
| expires_at | TIMESTAMP | NOT NULL | - | 验证码过期时间 |
| created_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | CURRENT_TIMESTAMP | 创建时间戳 |

**节来源**
- [db_manager.py](file://db_manager.py#L99-L106)

## Cookie管理表

### cookies表

Cookie存储和管理表，是系统的核心数据表之一。

| 字段名 | 数据类型 | 约束条件 | 默认值 | 业务含义 |
|--------|----------|----------|--------|----------|
| id | TEXT | PRIMARY KEY | - | Cookie唯一标识符 |
| value | TEXT | NOT NULL | - | Cookie值内容 |
| user_id | INTEGER | NOT NULL | - | 关联用户ID，外键约束 |
| auto_confirm | INTEGER | DEFAULT 1 | 1 | 自动确认设置（0=关闭，1=开启） |
| remark | TEXT | DEFAULT '' | '' | 备注信息 |
| pause_duration | INTEGER | DEFAULT 10 | 10 | 自动回复暂停时间（分钟） |
| username | TEXT | DEFAULT '' | '' | 用于密码登录的用户名 |
| password | TEXT | DEFAULT '' | '' | 用于密码登录的密码 |
| show_browser | INTEGER | DEFAULT 0 | 0 | 登录时是否显示浏览器 |
| created_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | CURRENT_TIMESTAMP | 创建时间戳 |

**重要特性：**
- **外键约束**：`user_id`字段与users表建立外键关系，支持级联删除
- **自动确认机制**：`auto_confirm`字段控制自动确认发货功能
- **暂停机制**：`pause_duration`字段允许设置自动回复暂停时间
- **账号登录支持**：新增`username`、`password`、`show_browser`字段支持密码登录

**节来源**
- [db_manager.py](file://db_manager.py#L111-L122)

## 关键词回复表

### keywords表

关键词自动回复配置表，支持多种回复类型。

| 字段名 | 数据类型 | 约束条件 | 默认值 | 业务含义 |
|--------|----------|----------|--------|----------|
| cookie_id | TEXT | - | - | 关联的Cookie ID，外键约束 |
| keyword | TEXT | - | - | 触发关键词 |
| reply | TEXT | - | - | 回复内容 |
| item_id | TEXT | - | - | 商品ID（支持指定商品回复） |
| type | TEXT | DEFAULT 'text' | 'text' | 回复类型（text/image） |
| image_url | TEXT | - | - | 图片URL（仅图片类型使用） |

**重要特性：**
- **复合唯一约束**：通过索引实现基于商品ID的唯一性校验
- **多类型支持**：支持文本和图片两种回复类型
- **商品级回复**：`item_id`字段支持指定商品的个性化回复

**复合唯一索引设计：**
- 无商品ID时：`(cookie_id, keyword)`必须唯一
- 有商品ID时：`(cookie_id, keyword, item_id)`必须唯一

**节来源**
- [db_manager.py](file://db_manager.py#L129-L137)

### 其他关键词相关表

#### cookie_status表

Cookie状态管理表。

| 字段名 | 数据类型 | 约束条件 | 默认值 | 业务含义 |
|--------|----------|----------|--------|----------|
| cookie_id | TEXT | PRIMARY KEY | - | 关联的Cookie ID |
| enabled | BOOLEAN | DEFAULT TRUE | TRUE | 是否启用 |
| updated_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | CURRENT_TIMESTAMP | 更新时间戳 |

**节来源**
- [db_manager.py](file://db_manager.py#L142-L146)

#### default_replies表

默认回复设置表。

| 字段名 | 数据类型 | 约束条件 | 默认值 | 业务含义 |
|--------|----------|----------|--------|----------|
| cookie_id | TEXT | PRIMARY KEY | - | 关联的Cookie ID |
| enabled | BOOLEAN | DEFAULT FALSE | FALSE | 是否启用默认回复 |
| reply_content | TEXT | - | - | 默认回复内容 |
| reply_once | BOOLEAN | DEFAULT FALSE | FALSE | 是否只回复一次 |
| created_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | CURRENT_TIMESTAMP | 创建时间戳 |
| updated_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | CURRENT_TIMESTAMP | 更新时间戳 |

**节来源**
- [db_manager.py](file://db_manager.py#L311-L318)

#### default_reply_records表

默认回复记录表，记录已回复的聊天ID。

| 字段名 | 数据类型 | 约束条件 | 默认值 | 业务含义 |
|--------|----------|----------|--------|----------|
| id | INTEGER | PRIMARY KEY AUTOINCREMENT | - | 主键，自增ID |
| cookie_id | TEXT | NOT NULL | - | 关联的Cookie ID |
| chat_id | TEXT | NOT NULL | - | 聊天ID |
| replied_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | CURRENT_TIMESTAMP | 回复时间戳 |
| UNIQUE | - | (cookie_id, chat_id) | - | 联合唯一约束 |

**节来源**
- [db_manager.py](file://db_manager.py#L345-L351)

## 卡券管理表

### cards表

卡券管理系统，支持多种类型的回复内容。

| 字段名 | 数据类型 | 约束条件 | 默认值 | 业务含义 |
|--------|----------|----------|--------|----------|
| id | INTEGER | PRIMARY KEY AUTOINCREMENT | - | 主键，自增ID |
| name | TEXT | NOT NULL | - | 卡券名称 |
| type | TEXT | NOT NULL CHECK | - | 卡券类型（api/text/data/image） |
| api_config | TEXT | - | - | API配置JSON |
| text_content | TEXT | - | - | 文本内容 |
| data_content | TEXT | - | - | 数据内容 |
| image_url | TEXT | - | - | 图片URL |
| description | TEXT | - | - | 卡券描述 |
| enabled | BOOLEAN | DEFAULT TRUE | TRUE | 是否启用 |
| delay_seconds | INTEGER | DEFAULT 0 | 0 | 延迟发送时间（秒） |
| is_multi_spec | BOOLEAN | DEFAULT FALSE | FALSE | 是否多规格 |
| spec_name | TEXT | - | - | 规格名称 |
| spec_value | TEXT | - | - | 规格值 |
| user_id | INTEGER | NOT NULL DEFAULT 1 | 1 | 关联用户ID |
| created_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | CURRENT_TIMESTAMP | 创建时间戳 |
| updated_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | CURRENT_TIMESTAMP | 更新时间戳 |

**CHECK约束**：
- `type`字段限制为`('api', 'text', 'data', 'image')`中的值

**重要演进**：
- **user_id字段**：添加用户隔离支持
- **delay_seconds字段**：添加自动发货延时功能
- **多规格支持**：添加`is_multi_spec`、`spec_name`、`spec_value`字段

**节来源**
- [db_manager.py](file://db_manager.py#L198-L216)

### delivery_rules表

自动发货规则表。

| 字段名 | 数据类型 | 约束条件 | 默认值 | 业务含义 |
|--------|----------|----------|--------|----------|
| id | INTEGER | PRIMARY KEY AUTOINCREMENT | - | 主键，自增ID |
| keyword | TEXT | NOT NULL | - | 触发关键词 |
| card_id | INTEGER | NOT NULL | - | 关联卡券ID |
| delivery_count | INTEGER | DEFAULT 1 | 1 | 发货数量 |
| enabled | BOOLEAN | DEFAULT TRUE | TRUE | 是否启用 |
| description | TEXT | - | - | 规则描述 |
| delivery_times | INTEGER | DEFAULT 0 | 0 | 已发货次数 |
| created_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | CURRENT_TIMESTAMP | 创建时间戳 |
| updated_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | CURRENT_TIMESTAMP | 更新时间戳 |

**节来源**
- [db_manager.py](file://db_manager.py#L295-L305)

## 订单管理表

### orders表

订单管理系统。

| 字段名 | 数据类型 | 约束条件 | 默认值 | 业务含义 |
|--------|----------|----------|--------|----------|
| order_id | TEXT | PRIMARY KEY | - | 订单ID |
| item_id | TEXT | - | - | 商品ID |
| buyer_id | TEXT | - | - | 买家ID |
| spec_name | TEXT | - | - | 规格名称 |
| spec_value | TEXT | - | - | 规格值 |
| quantity | TEXT | - | - | 数量 |
| amount | TEXT | - | - | 金额 |
| order_status | TEXT | DEFAULT 'unknown' | 'unknown' | 订单状态 |
| cookie_id | TEXT | - | - | 关联Cookie ID |
| created_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | CURRENT_TIMESTAMP | 创建时间戳 |
| updated_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | CURRENT_TIMESTAMP | 更新时间戳 |

**节来源**
- [db_manager.py](file://db_manager.py#L221-L233)

### item_info表

商品信息缓存表。

| 字段名 | 数据类型 | 约束条件 | 默认值 | 业务含义 |
|--------|----------|----------|--------|----------|
| id | INTEGER | PRIMARY KEY AUTOINCREMENT | - | 主键，自增ID |
| cookie_id | TEXT | NOT NULL | - | 关联Cookie ID |
| item_id | TEXT | NOT NULL | - | 商品ID |
| item_title | TEXT | - | - | 商品标题 |
| item_description | TEXT | - | - | 商品描述 |
| item_category | TEXT | - | - | 商品分类 |
| item_price | TEXT | - | - | 商品价格 |
| item_detail | TEXT | - | - | 商品详情 |
| is_multi_spec | BOOLEAN | DEFAULT FALSE | FALSE | 是否多规格 |
| created_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | CURRENT_TIMESTAMP | 创建时间戳 |
| updated_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | CURRENT_TIMESTAMP | 更新时间戳 |

**重要特性**：
- **唯一约束**：`(cookie_id, item_id)`组合唯一
- **多规格支持**：`is_multi_spec`字段支持多规格商品
- **多数量发货**：`multi_quantity_delivery`字段支持多数量发货

**节来源**
- [db_manager.py](file://db_manager.py#L267-L280)

## AI回复系统表

### ai_reply_settings表

AI回复配置表。

| 字段名 | 数据类型 | 约束条件 | 默认值 | 业务含义 |
|--------|----------|----------|--------|----------|
| cookie_id | TEXT | PRIMARY KEY | - | 关联Cookie ID |
| ai_enabled | BOOLEAN | DEFAULT FALSE | FALSE | 是否启用AI回复 |
| model_name | TEXT | DEFAULT 'qwen-plus' | 'qwen-plus' | AI模型名称 |
| api_key | TEXT | - | - | API密钥 |
| base_url | TEXT | DEFAULT 'https://dashscope.aliyuncs.com/compatible-mode/v1' | - | API基础URL |
| max_discount_percent | INTEGER | DEFAULT 10 | 10 | 最大折扣百分比 |
| max_discount_amount | INTEGER | DEFAULT 100 | 100 | 最大折扣金额 |
| max_bargain_rounds | INTEGER | DEFAULT 3 | 3 | 最大议价轮次 |
| custom_prompts | TEXT | - | - | 自定义提示词 |
| created_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | CURRENT_TIMESTAMP | 创建时间戳 |
| updated_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | CURRENT_TIMESTAMP | 更新时间戳 |

**节来源**
- [db_manager.py](file://db_manager.py#L152-L164)

### ai_conversations表

AI对话历史表。

| 字段名 | 数据类型 | 约束条件 | 默认值 | 业务含义 |
|--------|----------|----------|--------|----------|
| id | INTEGER | PRIMARY KEY AUTOINCREMENT | - | 主键，自增ID |
| cookie_id | TEXT | NOT NULL | - | 关联Cookie ID |
| chat_id | TEXT | NOT NULL | - | 聊天ID |
| user_id | TEXT | NOT NULL | - | 用户ID |
| item_id | TEXT | NOT NULL | - | 商品ID |
| role | TEXT | NOT NULL | - | 角色（user/assistant/system） |
| content | TEXT | NOT NULL | - | 对话内容 |
| intent | TEXT | - | - | 对话意图 |
| bargain_count | INTEGER | DEFAULT 0 | 0 | 议价轮次 |
| created_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | CURRENT_TIMESTAMP | 创建时间戳 |

**节来源**
- [db_manager.py](file://db_manager.py#L170-L181)

### ai_item_cache表

AI商品信息缓存表。

| 字段名 | 数据类型 | 约束条件 | 默认值 | 业务含义 |
|--------|----------|----------|--------|----------|
| item_id | TEXT | PRIMARY KEY | - | 商品ID |
| data | TEXT | NOT NULL | - | 商品数据JSON |
| price | REAL | - | - | 商品价格 |
| description | TEXT | - | - | 商品描述 |
| last_updated | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | CURRENT_TIMESTAMP | 最后更新时间 |

**节来源**
- [db_manager.py](file://db_manager.py#L187-L193)

## 通知系统表

### notification_channels表

通知渠道配置表。

| 字段名 | 数据类型 | 约束条件 | 默认值 | 业务含义 |
|--------|----------|----------|--------|----------|
| id | INTEGER | PRIMARY KEY AUTOINCREMENT | - | 主键，自增ID |
| name | TEXT | NOT NULL | - | 通知渠道名称 |
| type | TEXT | NOT NULL CHECK | - | 通知类型 |
| config | TEXT | NOT NULL | - | 配置JSON |
| enabled | BOOLEAN | DEFAULT TRUE | TRUE | 是否启用 |
| created_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | CURRENT_TIMESTAMP | 创建时间戳 |
| updated_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | CURRENT_TIMESTAMP | 更新时间戳 |

**CHECK约束**：
- `type`字段限制为`('qq','ding_talk','dingtalk','feishu','lark','bark','email','webhook','wechat','telegram')`中的值

**支持的通知渠道**：
- QQ通知
- 钉钉通知（dingtalk）
- 飞书通知（feishu/lark）
- Bark通知
- 邮件通知
- Webhook通知
- 微信通知
- Telegram通知

**节来源**
- [db_manager.py](file://db_manager.py#L357-L365)

### message_notifications表

消息通知配置表。

| 字段名 | 数据类型 | 约束条件 | 默认值 | 业务含义 |
|--------|----------|----------|--------|----------|
| id | INTEGER | PRIMARY KEY AUTOINCREMENT | - | 主键，自增ID |
| cookie_id | TEXT | NOT NULL | - | 关联Cookie ID |
| channel_id | INTEGER | NOT NULL | - | 关联通知渠道ID |
| enabled | BOOLEAN | DEFAULT TRUE | TRUE | 是否启用 |
| created_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | CURRENT_TIMESTAMP | 创建时间戳 |
| updated_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | CURRENT_TIMESTAMP | 更新时间戳 |

**联合唯一约束**：`(cookie_id, channel_id)`组合唯一

**节来源**
- [db_manager.py](file://db_manager.py#L381-L389)

## 系统配置表

### system_settings表

系统级配置表。

| 字段名 | 数据类型 | 约束条件 | 默认值 | 业务含义 |
|--------|----------|----------|--------|----------|
| key | TEXT | PRIMARY KEY | - | 配置键名 |
| value | TEXT | NOT NULL | - | 配置值 |
| description | TEXT | - | - | 配置描述 |
| updated_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | CURRENT_TIMESTAMP | 更新时间戳 |

**预设配置项**：
- `theme_color`: 主题颜色（默认：blue）
- `registration_enabled`: 是否开启用户注册（默认：true）
- `show_default_login_info`: 是否显示默认登录信息（默认：true）
- `smtp_server`: SMTP服务器地址
- `smtp_port`: SMTP端口（默认：587）
- `smtp_user`: SMTP登录用户名
- `smtp_password`: SMTP登录密码/授权码
- `smtp_from`: 发件人显示名
- `smtp_use_tls`: 是否启用TLS（默认：true）
- `smtp_use_ssl`: 是否启用SSL（默认：false）
- `qq_reply_secret_key`: QQ回复消息API秘钥（默认：xianyu_qq_reply_2024）

**节来源**
- [db_manager.py](file://db_manager.py#L370-L375)

### user_settings表

用户级配置表。

| 字段名 | 数据类型 | 约束条件 | 默认值 | 业务含义 |
|--------|----------|----------|--------|----------|
| id | INTEGER | PRIMARY KEY AUTOINCREMENT | - | 主键，自增ID |
| user_id | INTEGER | NOT NULL | - | 关联用户ID |
| key | TEXT | NOT NULL | - | 配置键名 |
| value | TEXT | NOT NULL | - | 配置值 |
| description | TEXT | - | - | 配置描述 |
| created_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | CURRENT_TIMESTAMP | 创建时间戳 |
| updated_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | CURRENT_TIMESTAMP | 更新时间戳 |

**联合唯一约束**：`(user_id, key)`组合唯一

**节来源**
- [db_manager.py](file://db_manager.py#L395-L404)

### risk_control_logs表

风控日志表。

| 字段名 | 数据类型 | 约束条件 | 默认值 | 业务含义 |
|--------|----------|----------|--------|----------|
| id | INTEGER | PRIMARY KEY AUTOINCREMENT | - | 主键，自增ID |
| cookie_id | TEXT | NOT NULL | - | 关联Cookie ID |
| event_type | TEXT | NOT NULL DEFAULT 'slider_captcha' | 'slider_captcha' | 事件类型 |
| event_description | TEXT | - | - | 事件描述 |
| processing_result | TEXT | - | - | 处理结果 |
| processing_status | TEXT | DEFAULT 'processing' | 'processing' | 处理状态 |
| error_message | TEXT | - | - | 错误信息 |
| created_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | CURRENT_TIMESTAMP | 创建时间戳 |
| updated_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | CURRENT_TIMESTAMP | 更新时间戳 |

**节来源**
- [db_manager.py](file://db_manager.py#L410-L420)

## 索引设计

### 主要索引

#### idx_cards_user_id
- **表**：cards
- **字段**：user_id
- **类型**：普通索引
- **目的**：优化用户级别的卡券查询性能

#### idx_keywords_unique_no_item
- **表**：keywords
- **字段**：(cookie_id, keyword)
- **类型**：唯一索引
- **条件**：`item_id IS NULL OR item_id = ''`
- **目的**：确保通用关键词的唯一性

#### idx_keywords_unique_with_item
- **表**：keywords
- **字段**：(cookie_id, keyword, item_id)
- **类型**：唯一索引
- **条件**：`item_id IS NOT NULL AND item_id != ''`
- **目的**：确保指定商品关键词的唯一性

### 外键索引

系统自动为所有外键字段创建隐式索引：
- `user_id`字段（users表）
- `cookie_id`字段（cookies表）
- `channel_id`字段（notification_channels表）

**节来源**
- [db_manager.py](file://db_manager.py#L244-L244)
- [db_manager.py](file://db_manager.py#L1074-L1083)

## 字段演进历程

### cards表演进

**初始版本**：
```sql
CREATE TABLE IF NOT EXISTS cards (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name TEXT NOT NULL,
    type TEXT NOT NULL CHECK (type IN ('api', 'text', 'data')),
    -- 其他字段...
)
```

**演进过程**：
1. **添加image_url字段**：支持图片类型的卡券
2. **添加user_id字段**：实现用户隔离
3. **添加delay_seconds字段**：支持自动发货延时
4. **添加多规格字段**：支持商品多规格回复
5. **更新CHECK约束**：支持image类型

**最终版本**：
```sql
CREATE TABLE IF NOT EXISTS cards (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name TEXT NOT NULL,
    type TEXT NOT NULL CHECK (type IN ('api', 'text', 'data', 'image')),
    -- 其他字段...
)
```

### keywords表演进

**初始版本**：
```sql
CREATE TABLE IF NOT EXISTS keywords (
    cookie_id TEXT,
    keyword TEXT,
    reply TEXT,
    FOREIGN KEY (cookie_id) REFERENCES cookies(id) ON DELETE CASCADE
)
```

**演进过程**：
1. **添加item_id字段**：支持指定商品回复
2. **添加type字段**：支持文本和图片类型
3. **添加image_url字段**：存储图片URL
4. **重构唯一约束**：通过复合索引实现基于商品ID的唯一性校验

### cookies表演进

**初始版本**：
```sql
CREATE TABLE IF NOT EXISTS cookies (
    id TEXT PRIMARY KEY,
    value TEXT NOT NULL,
    user_id INTEGER NOT NULL,
    -- 其他字段...
)
```

**演进过程**：
1. **添加auto_confirm字段**：支持自动确认发货
2. **添加remark字段**：支持备注信息
3. **添加pause_duration字段**：支持自动回复暂停
4. **添加账号登录字段**：支持用户名密码登录

**节来源**
- [db_manager.py](file://db_manager.py#L237-L263)
- [db_manager.py](file://db_manager.py#L488-L556)
- [db_manager.py](file://db_manager.py#L1036-L1094)

## 配置对比分析

### 系统级配置 vs 用户级配置

#### 系统级配置（system_settings表）

| 配置项 | 数据类型 | 存储位置 | 作用范围 | 示例值 |
|--------|----------|----------|----------|--------|
| theme_color | TEXT | system_settings表 | 全局 | blue |
| registration_enabled | BOOLEAN | system_settings表 | 全局 | true |
| smtp_server | TEXT | system_settings表 | 全局 | smtp.example.com |
| smtp_port | INTEGER | system_settings表 | 全局 | 587 |
| qq_reply_secret_key | TEXT | system_settings表 | 全局 | xianyu_qq_reply_2024 |

#### 用户级配置（user_settings表）

| 配置项 | 数据类型 | 存储位置 | 作用范围 | 示例值 |
|--------|----------|----------|----------|--------|
| ui_language | TEXT | user_settings表 | 用户级别 | zh_CN |
| notification_preferences | JSON | user_settings表 | 用户级别 | {...} |
| auto_reply_settings | JSON | user_settings表 | 用户级别 | {...} |

#### 配置文件vs数据库配置

**global_config.yml中的配置**：
- **API端点**：API接口地址和参数
- **心跳间隔**：系统心跳检测时间间隔
- **日志配置**：日志格式和级别
- **滑块验证**：滑块验证相关设置

**system_settings表中的配置**：
- **SMTP配置**：邮件服务器配置
- **主题设置**：界面主题和颜色
- **注册开关**：用户注册功能开关
- **API密钥**：第三方服务API密钥

**配置优先级**：
1. 数据库配置（最高优先级）
2. 环境变量
3. 配置文件（最低优先级）

**节来源**
- [global_config.yml](file://global_config.yml#L1-L77)
- [config.py](file://config.py#L1-L126)

## 总结

Xianyu Auto Reply系统的数据库设计体现了以下特点：

### 设计优势

1. **模块化设计**：清晰的功能分区，便于维护和扩展
2. **用户隔离**：通过user_id字段实现多用户支持
3. **灵活的回复机制**：支持文本、图片、API等多种回复方式
4. **完善的索引策略**：优化查询性能，特别是用户级查询
5. **版本演进能力**：支持字段的动态添加和约束更新

### 技术特色

1. **SQLite本地存储**：轻量级部署，适合个人和小型团队使用
2. **外键约束**：保证数据完整性，支持级联操作
3. **CHECK约束**：确保数据的有效性和一致性
4. **复合索引**：实现复杂的业务约束逻辑
5. **事务支持**：保证数据操作的原子性

### 扩展建议

1. **性能优化**：可以考虑为高频查询字段添加额外索引
2. **数据备份**：完善定期备份机制
3. **监控告警**：添加数据库性能监控
4. **容量规划**：为大数据量场景预留扩展空间

该数据库设计充分考虑了自动回复系统的业务需求，在保证功能完整性的同时，兼顾了性能和可维护性。