# å‰åç«¯é€šä¿¡æœºåˆ¶

<cite>
**æœ¬æ–‡æ¡£å¼•ç”¨çš„æ–‡ä»¶**
- [app.js](file://static/js/app.js)
- [login.html](file://static/login.html)
- [index.html](file://static/index.html)
- [reply_server.py](file://reply_server.py)
- [config.py](file://config.py)
- [nginx.conf](file://nginx/nginx.conf)
</cite>

## ç›®å½•
1. [æ¦‚è¿°](#æ¦‚è¿°)
2. [è®¤è¯æœºåˆ¶](#è®¤è¯æœºåˆ¶)
3. [JavaScriptå®¢æˆ·ç«¯é€šä¿¡](#javascriptå®¢æˆ·ç«¯é€šä¿¡)
4. [åç«¯APIç«¯ç‚¹](#åç«¯apiç«¯ç‚¹)
5. [è¯·æ±‚æ—¥å¿—ä¸­é—´ä»¶](#è¯·æ±‚æ—¥å¿—ä¸­é—´ä»¶)
6. [CORSä¸å®‰å…¨é…ç½®](#corsä¸å®‰å…¨é…ç½®)
7. [é”™è¯¯å¤„ç†ç­–ç•¥](#é”™è¯¯å¤„ç†ç­–ç•¥)
8. [æ€§èƒ½ä¼˜åŒ–](#æ€§èƒ½ä¼˜åŒ–)
9. [æ€»ç»“](#æ€»ç»“)

## æ¦‚è¿°

è¯¥ç³»ç»Ÿé‡‡ç”¨å‰åç«¯åˆ†ç¦»æ¶æ„ï¼Œå‰ç«¯ä½¿ç”¨JavaScripté€šè¿‡Fetch APIä¸åç«¯FastAPIæœåŠ¡è¿›è¡Œé€šä¿¡ã€‚æ•´ä¸ªé€šä¿¡æœºåˆ¶å›´ç»•Bearer Tokenè®¤è¯å±•å¼€ï¼Œç¡®ä¿ç”¨æˆ·èº«ä»½éªŒè¯å’Œæ•°æ®å®‰å…¨ä¼ è¾“ã€‚

## è®¤è¯æœºåˆ¶

### Bearer Tokenè®¤è¯æµç¨‹

ç³»ç»Ÿä½¿ç”¨åŸºäºJWTçš„Bearer Tokenè®¤è¯æœºåˆ¶ï¼Œå…·ä½“å®ç°å¦‚ä¸‹ï¼š

```mermaid
sequenceDiagram
participant Client as JavaScriptå®¢æˆ·ç«¯
participant Login as ç™»å½•é¡µé¢
participant Backend as FastAPIåç«¯
participant Storage as localStorage
Client->>Login : ç”¨æˆ·è®¿é—®ç™»å½•é¡µé¢
Login->>Client : æ˜¾ç¤ºç™»å½•è¡¨å•
Client->>Backend : POST /login (ç”¨æˆ·å/å¯†ç )
Backend->>Backend : éªŒè¯å‡­æ®
Backend->>Storage : ä¿å­˜auth_token
Storage->>Client : localStorage.setItem('auth_token', token)
Client->>Backend : GET /verify (æºå¸¦token)
Backend->>Client : è¿”å›è®¤è¯çŠ¶æ€
Client->>Client : è·³è½¬åˆ°ç®¡ç†é¡µé¢
```

**å›¾è¡¨æ¥æº**
- [login.html](file://static/login.html#L368-L400)
- [reply_server.py](file://reply_server.py#L542-L660)

### Tokenç®¡ç†

JavaScriptå®¢æˆ·ç«¯é€šè¿‡ä»¥ä¸‹æ–¹å¼ç®¡ç†è®¤è¯ä»¤ç‰Œï¼š

```javascript
// å…¨å±€authTokenå˜é‡
let authToken = localStorage.getItem('auth_token');

// ç™»å½•æˆåŠŸåä¿å­˜token
localStorage.setItem('auth_token', result.token);

// è¯·æ±‚æ—¶è‡ªåŠ¨æ·»åŠ Authorizationå¤´
headers: {
    'Authorization': `Bearer ${authToken}`
}
```

**èŠ‚æ¥æº**
- [app.js](file://static/js/app.js#L8-L9)
- [login.html](file://static/login.html#L379-L389)

### åç«¯è®¤è¯éªŒè¯

åç«¯ä½¿ç”¨HTTP Bearerè®¤è¯ä¸­é—´ä»¶éªŒè¯è¯·æ±‚ï¼š

```python
# HTTP Bearerè®¤è¯
security = HTTPBearer(auto_error=False)

# éªŒè¯tokenå‡½æ•°
def verify_token(credentials: Optional[HTTPAuthorizationCredentials] = Depends(security)):
    if not credentials:
        return None
    
    token = credentials.credentials
    if token not in SESSION_TOKENS:
        return None
    
    # æ£€æŸ¥tokenæ˜¯å¦è¿‡æœŸ
    if time.time() - token_data['timestamp'] > TOKEN_EXPIRE_TIME:
        del SESSION_TOKENS[token]
        return None
    
    return token_data
```

**èŠ‚æ¥æº**
- [reply_server.py](file://reply_server.py#L48-L220)

## JavaScriptå®¢æˆ·ç«¯é€šä¿¡

### Fetch APIå°è£…

ç³»ç»Ÿå°è£…äº†ç»Ÿä¸€çš„fetchè¯·æ±‚å¤„ç†å‡½æ•°ï¼Œæä¾›é”™è¯¯å¤„ç†å’Œè®¤è¯æ”¯æŒï¼š

```javascript
async function fetchJSON(url, opts = {}) {
    toggleLoading(true);
    try {
        // æ·»åŠ è®¤è¯å¤´
        if (authToken) {
            opts.headers = opts.headers || {};
            opts.headers['Authorization'] = `Bearer ${authToken}`;
        }
        
        const res = await fetch(url, opts);
        
        if (res.status === 401) {
            // æœªæˆæƒï¼Œè·³è½¬åˆ°ç™»å½•é¡µé¢
            localStorage.removeItem('auth_token');
            window.location.href = '/';
            return;
        }
        
        if (!res.ok) {
            // å¤„ç†é”™è¯¯å“åº”
            let errorMessage = `HTTP ${res.status}`;
            try {
                const errorText = await res.text();
                if (errorText) {
                    try {
                        const errorJson = JSON.parse(errorText);
                        errorMessage = errorJson.detail || errorJson.message || errorText;
                    } catch {
                        errorMessage = errorText;
                    }
                }
            } catch {
                errorMessage = `HTTP ${res.status} ${res.statusText}`;
            }
            throw new Error(errorMessage);
        }
        
        const data = await res.json();
        toggleLoading(false);
        return data;
    } catch (err) {
        handleApiError(err);
        throw err;
    }
}
```

**èŠ‚æ¥æº**
- [app.js](file://static/js/app.js#L1108-L1149)

### å…³é”®APIè°ƒç”¨ç¤ºä¾‹

#### ä»ªè¡¨ç›˜æ•°æ®åŠ è½½

```javascript
async function loadDashboard() {
    try {
        toggleLoading(true);
        
        // è·å–è´¦å·åˆ—è¡¨
        const cookiesResponse = await fetch(`${apiBase}/cookies/details`, {
            headers: {
                'Authorization': `Bearer ${authToken}`
            }
        });
        
        if (cookiesResponse.ok) {
            const cookiesData = await cookiesResponse.json();
            
            // å¹¶è¡Œè·å–æ¯ä¸ªè´¦å·çš„å…³é”®è¯
            const accountsWithKeywords = await Promise.all(
                cookiesData.map(async (account) => {
                    const keywordsResponse = await fetch(`${apiBase}/keywords/${account.id}`, {
                        headers: {
                            'Authorization': `Bearer ${authToken}`
                        }
                    });
                    
                    if (keywordsResponse.ok) {
                        const keywordsData = await keywordsResponse.json();
                        return {
                            ...account,
                            keywords: keywordsData,
                            keywordCount: keywordsData.length
                        };
                    } else {
                        return {
                            ...account,
                            keywords: [],
                            keywordCount: 0
                        };
                    }
                })
            );
            
            // æ›´æ–°ä»ªè¡¨ç›˜æ˜¾ç¤º
            updateDashboardStats(accountsWithKeywords.length, totalKeywords, enabledAccounts);
            updateDashboardAccountsList(accountsWithKeywords);
        }
    } catch (error) {
        console.error('åŠ è½½ä»ªè¡¨ç›˜æ•°æ®å¤±è´¥:', error);
        showToast('åŠ è½½ä»ªè¡¨ç›˜æ•°æ®å¤±è´¥', 'danger');
    } finally {
        toggleLoading(false);
    }
}
```

**èŠ‚æ¥æº**
- [app.js](file://static/js/app.js#L157-L240)

#### å•†å“å…³é”®è¯ç®¡ç†

```javascript
// æ·»åŠ æˆ–æ›´æ–°å…³é”®è¯
async function addKeyword() {
    const keyword = document.getElementById('newKeyword').value.trim();
    const reply = document.getElementById('newReply').value.trim();
    const itemId = document.getElementById('newItemIdSelect').value.trim();
    
    try {
        toggleLoading(true);
        
        // å‡†å¤‡å…³é”®è¯æ•°æ®
        let currentKeywords = [...(keywordsData[currentCookieId] || [])];
        let textKeywords = currentKeywords.filter(item => (item.type || 'text') === 'text');
        
        // å‘é€POSTè¯·æ±‚æ›´æ–°å…³é”®è¯
        const response = await fetch(`${apiBase}/keywords-with-item-id/${currentCookieId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${authToken}`
            },
            body: JSON.stringify({
                keywords: textKeywords
            })
        });
        
        if (response.ok) {
            showToast(`âœ¨ å…³é”®è¯ "${keyword}" æ·»åŠ æˆåŠŸï¼`, 'success');
            await refreshKeywordsList();
        }
    } catch (error) {
        console.error('å…³é”®è¯æ·»åŠ å¤±è´¥:', error);
        showToast('å…³é”®è¯æ·»åŠ å¤±è´¥', 'danger');
    } finally {
        toggleLoading(false);
    }
}
```

**èŠ‚æ¥æº**
- [app.js](file://static/js/app.js#L669-L796)

## åç«¯APIç«¯ç‚¹

### å…³é”®ç«¯ç‚¹åˆ—è¡¨

ç³»ç»Ÿæä¾›äº†å¤šä¸ªRESTful APIç«¯ç‚¹ï¼Œæ”¯æŒå®Œæ•´çš„CRUDæ“ä½œï¼š

| ç«¯ç‚¹ | æ–¹æ³• | æè¿° | è®¤è¯ |
|------|------|------|------|
| `/api/keywords` | GET | è·å–æ‰€æœ‰å…³é”®è¯ | æ˜¯ |
| `/api/keywords/{cid}` | GET | è·å–ç‰¹å®šè´¦å·çš„å…³é”®è¯ | æ˜¯ |
| `/api/keywords-with-item-id/{cid}` | GET/POST | è·å–æˆ–æ›´æ–°åŒ…å«å•†å“IDçš„å…³é”®è¯ | æ˜¯ |
| `/api/items` | GET | è·å–æ‰€æœ‰å•†å“ä¿¡æ¯ | æ˜¯ |
| `/api/items/{cookie_id}` | GET | è·å–ç‰¹å®šè´¦å·çš„å•†å“ | æ˜¯ |
| `/api/orders` | GET | è·å–è®¢å•ä¿¡æ¯ | æ˜¯ |
| `/login` | POST | ç”¨æˆ·ç™»å½• | å¦ |
| `/verify` | GET | éªŒè¯token | æ˜¯ |
| `/logout` | POST | ç”¨æˆ·ç™»å‡º | æ˜¯ |

### å•†å“ç®¡ç†ç«¯ç‚¹

```python
@app.get("/items")
def get_all_items(current_user: Dict[str, Any] = Depends(get_current_user)):
    """è·å–å½“å‰ç”¨æˆ·çš„æ‰€æœ‰å•†å“ä¿¡æ¯"""
    try:
        user_id = current_user['user_id']
        from db_manager import db_manager
        user_cookies = db_manager.get_all_cookies(user_id)
        
        all_items = []
        for cookie_id in user_cookies.keys():
            items = db_manager.get_items_by_cookie(cookie_id)
            all_items.extend(items)
        
        return {"items": all_items}
    except Exception as e:
        raise HTTPException(status_code=500, detail=f"è·å–å•†å“ä¿¡æ¯å¤±è´¥: {str(e)}")
```

**èŠ‚æ¥æº**
- [reply_server.py](file://reply_server.py#L3961-L3978)

### è®¢å•ç®¡ç†ç«¯ç‚¹

```python
@app.get('/api/orders')
def get_user_orders(current_user: Dict[str, Any] = Depends(get_current_user)):
    """è·å–å½“å‰ç”¨æˆ·çš„è®¢å•ä¿¡æ¯"""
    try:
        from db_manager import db_manager
        
        user_id = current_user['user_id']
        log_with_user('info', "æŸ¥è¯¢ç”¨æˆ·è®¢å•ä¿¡æ¯", current_user)
        
        # è·å–ç”¨æˆ·çš„æ‰€æœ‰Cookie
        user_cookies = db_manager.get_all_cookies(user_id)
        
        # è·å–æ‰€æœ‰è®¢å•
        all_orders = []
        for cookie_id in user_cookies:
            orders = db_manager.get_orders_by_cookie(cookie_id)
            all_orders.extend(orders)
        
        return {"success": True, "data": all_orders}
    except Exception as e:
        logger.error(f"è·å–è®¢å•ä¿¡æ¯å¤±è´¥: {e}")
        raise HTTPException(status_code=500, detail="è·å–è®¢å•ä¿¡æ¯å¤±è´¥")
```

**èŠ‚æ¥æº**
- [reply_server.py](file://reply_server.py#L5524-L5555)

## è¯·æ±‚æ—¥å¿—ä¸­é—´ä»¶

### ä¸­é—´ä»¶å®ç°

ç³»ç»Ÿå®ç°äº†è‡ªå®šä¹‰çš„è¯·æ±‚æ—¥å¿—ä¸­é—´ä»¶ï¼Œè®°å½•æ‰€æœ‰APIè¯·æ±‚çš„è¯¦ç»†ä¿¡æ¯ï¼š

```python
@app.middleware("http")
async def log_requests(request, call_next):
    start_time = time.time()
    
    # è·å–ç”¨æˆ·ä¿¡æ¯
    user_info = "æœªç™»å½•"
    try:
        auth_header = request.headers.get("Authorization")
        if auth_header and auth_header.startswith("Bearer "):
            token = auth_header.split(" ")[1]
            if token in SESSION_TOKENS:
                token_data = SESSION_TOKENS[token]
                if time.time() - token_data['timestamp'] <= TOKEN_EXPIRE_TIME:
                    user_info = f"ã€{token_data['username']}#{token_data['user_id']}ã€‘"
    except Exception:
        pass
    
    logger.info(f"ğŸŒ {user_info} APIè¯·æ±‚: {request.method} {request.url.path}")
    
    response = await call_next(request)
    
    process_time = time.time() - start_time
    logger.info(f"âœ… {user_info} APIå“åº”: {request.method} {request.url.path} - {response.status_code} ({process_time:.3f}s)")
    
    return response
```

**èŠ‚æ¥æº**
- [reply_server.py](file://reply_server.py#L331-L357)

### æ—¥å¿—è®°å½•å†…å®¹

ä¸­é—´ä»¶è®°å½•ä»¥ä¸‹ä¿¡æ¯ï¼š
- ç”¨æˆ·æ ‡è¯†ï¼ˆç”¨æˆ·åå’ŒIDï¼‰
- è¯·æ±‚æ–¹æ³•å’Œè·¯å¾„
- å“åº”çŠ¶æ€ç 
- å¤„ç†æ—¶é—´
- è¯·æ±‚å¤´ä¿¡æ¯

## CORSä¸å®‰å…¨é…ç½®

### Nginxå®‰å…¨å¤´é…ç½®

Nginxåå‘ä»£ç†é…ç½®äº†ä¸¥æ ¼çš„å®‰å…¨å¤´ï¼Œé˜²æ­¢å¸¸è§çš„Webæ”»å‡»ï¼š

```nginx
# å®‰å…¨å¤´é…ç½®
add_header X-Frame-Options "SAMEORIGIN" always;
add_header X-XSS-Protection "1; mode=block" always;
add_header X-Content-Type-Options "nosniff" always;
add_header Referrer-Policy "no-referrer-when-downgrade" always;
add_header Content-Security-Policy "default-src 'self' http: https: data: blob: 'unsafe-inline'" always;
```

**èŠ‚æ¥æº**
- [nginx.conf](file://nginx/nginx.conf#L53-L58)

### å†…å®¹å®‰å…¨ç­–ç•¥

ç³»ç»Ÿå®æ–½äº†ä¸¥æ ¼çš„å†…å®¹å®‰å…¨ç­–ç•¥ï¼ˆCSPï¼‰ï¼š
- é™åˆ¶èµ„æºåŠ è½½æºä¸ºåŒæºå’ŒHTTPS
- ç¦æ­¢å†…è”è„šæœ¬æ‰§è¡Œ
- é™åˆ¶WebSocketè¿æ¥
- ç¦æ­¢ä¸å®‰å…¨çš„åè®®

### è·¨åŸŸèµ„æºå…±äº«ï¼ˆCORSï¼‰

è™½ç„¶ç³»ç»Ÿä¸»è¦é¢å‘å†…éƒ¨ä½¿ç”¨ï¼Œä½†Nginxé…ç½®æ”¯æŒå¿…è¦çš„è·¨åŸŸè¯·æ±‚ï¼š

```nginx
location / {
    proxy_pass http://xianyu_backend;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection 'upgrade';
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
}
```

**èŠ‚æ¥æº**
- [nginx.conf](file://nginx/nginx.conf#L61-L74)

## é”™è¯¯å¤„ç†ç­–ç•¥

### å‰ç«¯é”™è¯¯å¤„ç†

JavaScriptå®¢æˆ·ç«¯å®ç°äº†å¤šå±‚æ¬¡çš„é”™è¯¯å¤„ç†ï¼š

```javascript
// ç»Ÿä¸€é”™è¯¯å¤„ç†å‡½æ•°
function handleApiError(error) {
    console.error('APIè¯·æ±‚é”™è¯¯:', error);
    
    // æ ¹æ®é”™è¯¯ç±»å‹æ˜¾ç¤ºä¸åŒæç¤º
    if (error.message.includes('NetworkError')) {
        showToast('ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ', 'danger');
    } else if (error.message.includes('401')) {
        // æœªæˆæƒï¼Œè‡ªåŠ¨è·³è½¬ç™»å½•
        localStorage.removeItem('auth_token');
        window.location.href = '/';
    } else {
        showToast(`æ“ä½œå¤±è´¥: ${error.message}`, 'danger');
    }
}

// fetchJSONå‡½æ•°ä¸­çš„é”™è¯¯å¤„ç†
async function fetchJSON(url, opts = {}) {
    try {
        const res = await fetch(url, opts);
        
        if (!res.ok) {
            let errorMessage = `HTTP ${res.status}`;
            try {
                const errorText = await res.text();
                if (errorText) {
                    try {
                        const errorJson = JSON.parse(errorText);
                        errorMessage = errorJson.detail || errorJson.message || errorText;
                    } catch {
                        errorMessage = errorText;
                    }
                }
            } catch {
                errorMessage = `HTTP ${res.status} ${res.statusText}`;
            }
            throw new Error(errorMessage);
        }
        
        return await res.json();
    } catch (err) {
        handleApiError(err);
        throw err;
    }
}
```

**èŠ‚æ¥æº**
- [app.js](file://static/js/app.js#L1108-L1149)

### åç«¯é”™è¯¯å¤„ç†

åç«¯ä½¿ç”¨FastAPIçš„HTTPExceptionæä¾›ç»“æ„åŒ–çš„é”™è¯¯å“åº”ï¼š

```python
# ç»Ÿä¸€é”™è¯¯å“åº”æ ¼å¼
class ErrorResponse(BaseModel):
    success: bool = False
    message: str
    detail: Optional[str] = None

# ç¤ºä¾‹é”™è¯¯å¤„ç†
@app.post("/keywords/{cid}")
def update_keywords(cid: str, body: KeywordIn, current_user: Dict[str, Any] = Depends(get_current_user)):
    try:
        # éªŒè¯å’Œå¤„ç†é€»è¾‘
        kw_list = [(k, v) for k, v in body.keywords.items()]
        cookie_manager.manager.update_keywords(cid, kw_list)
        return {"msg": "updated", "count": len(kw_list)}
    except Exception as e:
        logger.error(f"æ›´æ–°å…³é”®è¯å¤±è´¥: {e}")
        raise HTTPException(status_code=500, detail=f"æ›´æ–°å…³é”®è¯å¤±è´¥: {str(e)}")
```

**èŠ‚æ¥æº**
- [reply_server.py](file://reply_server.py#L3077-L3096)

### é”™è¯¯åˆ†ç±»å¤„ç†

| é”™è¯¯ç±»å‹ | HTTPçŠ¶æ€ç  | å‰ç«¯å¤„ç† | åç«¯å¤„ç† |
|----------|------------|----------|----------|
| ç½‘ç»œé”™è¯¯ | 0 | æ˜¾ç¤ºç½‘ç»œé”™è¯¯æç¤º | è®°å½•é”™è¯¯æ—¥å¿— |
| æœªæˆæƒ | 401 | è‡ªåŠ¨è·³è½¬ç™»å½• | æ¸…ç†æ— æ•ˆtoken |
| æƒé™ä¸è¶³ | 403 | æ˜¾ç¤ºæƒé™ä¸è¶³ | è®°å½•å®‰å…¨äº‹ä»¶ |
| èµ„æºä¸å­˜åœ¨ | 404 | æ˜¾ç¤ºèµ„æºä¸å­˜åœ¨ | è®°å½•è®¿é—®å°è¯• |
| æœåŠ¡å™¨é”™è¯¯ | 500 | æ˜¾ç¤ºæœåŠ¡å™¨é”™è¯¯ | è¯¦ç»†é”™è¯¯æ—¥å¿— |

## æ€§èƒ½ä¼˜åŒ–

### ç¼“å­˜ç­–ç•¥

ç³»ç»Ÿå®ç°äº†å¤šå±‚ç¼“å­˜æœºåˆ¶ï¼š

```javascript
// å…³é”®è¯ç¼“å­˜
let accountKeywordCache = {};
let cacheTimestamp = 0;
const CACHE_DURATION = 30000; // 30ç§’ç¼“å­˜

async function getAccountKeywordCount(accountId) {
    const now = Date.now();
    
    // æ£€æŸ¥ç¼“å­˜
    if (accountKeywordCache[accountId] && (now - cacheTimestamp) < CACHE_DURATION) {
        return accountKeywordCache[accountId];
    }
    
    try {
        const response = await fetch(`${apiBase}/keywords/${accountId}`, {
            headers: {
                'Authorization': `Bearer ${authToken}`
            }
        });
        
        if (response.ok) {
            const keywordsData = await response.json();
            const count = keywordsData.length;
            
            // æ›´æ–°ç¼“å­˜
            accountKeywordCache[accountId] = count;
            cacheTimestamp = now;
            
            return count;
        }
    } catch (error) {
        console.error(`è·å–è´¦å· ${accountId} å…³é”®è¯å¤±è´¥:`, error);
        return 0;
    }
}
```

**èŠ‚æ¥æº**
- [app.js](file://static/js/app.js#L324-L362)

### å¹¶å‘è¯·æ±‚ä¼˜åŒ–

```javascript
// å¹¶è¡Œè·å–å¤šä¸ªè´¦å·çš„å…³é”®è¯
const accountsWithKeywords = await Promise.all(
    cookiesData.map(async (account) => {
        const keywordsResponse = await fetch(`${apiBase}/keywords/${account.id}`, {
            headers: {
                'Authorization': `Bearer ${authToken}`
            }
        });
        
        if (keywordsResponse.ok) {
            const keywordsData = await keywordsResponse.json();
            return {
                ...account,
                keywords: keywordsData,
                keywordCount: keywordsData.length
            };
        } else {
            return {
                ...account,
                keywords: [],
                keywordCount: 0
            };
        }
    })
);
```

**èŠ‚æ¥æº**
- [app.js](file://static/js/app.js#L171-L203)

### Nginxæ€§èƒ½ä¼˜åŒ–

```nginx
# è¿æ¥æ± é…ç½®
upstream xianyu_backend {
    server xianyu-app:8080;
    keepalive 32;
}

# é™æ€æ–‡ä»¶ç¼“å­˜
location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
    proxy_pass http://xianyu_backend;
    expires 1y;
    add_header Cache-Control "public, immutable";
}

# Gzipå‹ç¼©
gzip on;
gzip_vary on;
gzip_min_length 1024;
gzip_proxied any;
gzip_comp_level 6;
gzip_types
    text/plain
    text/css
    text/xml
    text/javascript
    application/json
    application/javascript
    application/xml+rss
    application/atom+xml
    image/svg+xml;
```

**èŠ‚æ¥æº**
- [nginx.conf](file://nginx/nginx.conf#L43-L81)

## æ€»ç»“

è¯¥ç³»ç»Ÿçš„å‰åç«¯é€šä¿¡æœºåˆ¶å…·æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š

### å®‰å…¨æ€§
- åŸºäºBearer Tokençš„è®¤è¯æœºåˆ¶
- ä¸¥æ ¼çš„CORSå’Œå®‰å…¨å¤´é…ç½®
- è¾“å…¥éªŒè¯å’Œæƒé™æ§åˆ¶
- å®Œæ•´çš„é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•

### å¯é æ€§
- ç»Ÿä¸€çš„é”™è¯¯å¤„ç†ç­–ç•¥
- è¯·æ±‚é‡è¯•æœºåˆ¶
- å®Œæ•´çš„APIæ–‡æ¡£
- ç»“æ„åŒ–çš„é”™è¯¯å“åº”

### æ€§èƒ½
- å¤šå±‚ç¼“å­˜ç­–ç•¥
- å¹¶å‘è¯·æ±‚ä¼˜åŒ–
- é™æ€èµ„æºä¼˜åŒ–
- å‹ç¼©å’Œç¼“å­˜é…ç½®

### å¯ç»´æŠ¤æ€§
- æ¨¡å—åŒ–çš„ä»£ç ç»“æ„
- ç»Ÿä¸€çš„APIè®¾è®¡è§„èŒƒ
- å®Œå–„çš„æ—¥å¿—è®°å½•
- æ¸…æ™°çš„é”™è¯¯ä¿¡æ¯

è¿™ç§è®¾è®¡ç¡®ä¿äº†ç³»ç»Ÿçš„å®‰å…¨æ€§ã€å¯é æ€§å’Œé«˜æ€§èƒ½ï¼Œä¸ºç”¨æˆ·æä¾›è‰¯å¥½çš„ä½¿ç”¨ä½“éªŒã€‚